"use strict";(self.webpackChunkside_eye=self.webpackChunkside_eye||[]).push([[381],{2814:(e,o,r)=>{r.d(o,{x:()=>a});var n=r(9950),s=r(6220),i=r(330),t=r(1367);const a=()=>{const{currentUser:e}=(0,t.As)(),[o,r]=(0,n.useState)(new Set);(0,n.useEffect)((()=>{if(null===e||void 0===e||!e.uid)return;const o=async()=>{try{const o=(0,s.H9)(i.db,"users",e.uid);await(0,s.mZ)(o,{lastSeen:(0,s.O5)(),isOnline:!0})}catch(o){console.error("Error updating presence:",o)}};o();const n=setInterval(o,3e4),t=async()=>{try{const o=(0,s.H9)(i.db,"users",e.uid);await(0,s.mZ)(o,{isOnline:!1,lastSeen:(0,s.O5)()})}catch(o){console.error("Error setting offline status:",o)}};window.addEventListener("beforeunload",t);const a=(0,s.rJ)(i.db,"users"),l=(0,s.aQ)(a,(e=>{const o=new Set,n=new Date;e.docs.forEach((e=>{const r=e.data(),s=e.id;if(r.isOnline)o.add(s);else if(r.lastSeen){const e=r.lastSeen.toDate?r.lastSeen.toDate():new Date(r.lastSeen);(n.getTime()-e.getTime())/6e4<2&&o.add(s)}})),r(o)}));return()=>{clearInterval(n),window.removeEventListener("beforeunload",t),l(),t()}}),[null===e||void 0===e?void 0:e.uid]);return{isUserOnline:e=>o.has(e),onlineUsers:o}}},7016:(e,o,r)=>{r.d(o,{A:()=>t});r(9950);var n=r(6491),s=r(3274),i=r(4414);const t=e=>{let{isOnline:o,size:r="small",showTooltip:t=!0}=e;const a={small:10,medium:14,large:18},l=(0,i.jsx)(n.A,{sx:{width:a[r],height:a[r],borderRadius:"50%",backgroundColor:o?"#4caf50":"#bdbdbd",border:"2px solid white",boxShadow:"0 0 0 1px rgba(0,0,0,0.1)",transition:"background-color 0.3s ease"}});return t?(0,i.jsx)(s.A,{title:o?"Online":"Offline",placement:"top",children:l}):l}},7381:(e,o,r)=>{r.r(o),r.d(o,{default:()=>pe});var n=r(9379),s=r(45),i=r(9950),t=r(8429),a=r(6491),l=r(6639),c=r(9808),d=r(2235),m=r(5333),u=r(2053),x=r(2236),h=r(4142),p=r(6699),A=r(249),j=r(6050),g=r(8614),v=r(1413),f=r(5277),b=r(8145),y=r(226),w=r(7591),k=r(3266),C=r(4195),S=r(4447),R=r(6583),I=r(33),E=r(8170),P=r(6493),z=r(3563),N=r(9739),U=r(2362),O=r(4862),F=r(3174),W=r(7016),q=r(2814),B=r(4801),H=r(6281),D=r(529),T=r(1071),_=r(9438),M=r(4200),L=r(598),Z=r(1673),J=r(227),G=r(3248),Y=r(2092),V=r(760),Q=r(7565),K=r(7319),X=r(260),$=r(1308),ee=r(379),oe=r(1770),re=r(1367),ne=r(4570),se=r(6220),ie=r(330),te=r(5887),ae=r(9751),le=r(4857),ce=r(6589),de=r(4567),me=r(4414);const ue=["children","value","index"];function xe(e){const{children:o,value:r,index:i}=e,t=(0,s.A)(e,ue);return(0,me.jsx)("div",(0,n.A)((0,n.A)({role:"tabpanel",hidden:r!==i,id:"room-tabpanel-".concat(i),"aria-labelledby":"room-tab-".concat(i)},t),{},{children:r===i&&(0,me.jsx)(a.A,{sx:{p:2},children:o})}))}const he=(0,de.A)("input")({display:"none"}),pe=()=>{var e,o;const{roomId:r}=(0,t.g)(),{currentUser:s}=(0,re.As)(),{addNotification:de}=(0,ne.E)(),ue=(0,t.Zp)(),{isUserOnline:pe}=(0,q.x)(),[Ae,je]=(0,i.useState)(null),[ge,ve]=(0,i.useState)(!0),[fe,be]=(0,i.useState)(!1),[ye,we]=(0,i.useState)(0),[ke,Ce]=(0,i.useState)(null),[Se,Re]=(0,i.useState)(""),[Ie,Ee]=(0,i.useState)(""),[Pe,ze]=(0,i.useState)([]),[Ne,Ue]=(0,i.useState)([]),[Oe,Fe]=(0,i.useState)([]),[We,qe]=(0,i.useState)(!1),[Be,He]=(0,i.useState)(!1),[De,Te]=(0,i.useState)(!1),[_e,Me]=(0,i.useState)(""),[Le,Ze]=(0,i.useState)([{text:""},{text:""}]),[Je,Ge]=(0,i.useState)(""),[Ye,Ve]=(0,i.useState)([]),[Qe,Ke]=(0,i.useState)(!1),[Xe,$e]=(0,i.useState)(""),[eo,oo]=(0,i.useState)("success"),ro=(0,i.useRef)(null),[no,so]=(0,i.useState)({}),[io,to]=(0,i.useState)(null),[ao,lo]=(0,i.useState)(!1),[co,mo]=(0,i.useState)(null),[uo,xo]=(0,i.useState)(null),[ho,po]=(0,i.useState)(!1),Ao=(0,i.useRef)(null),[jo,go]=(0,i.useState)(!1),[vo,fo]=(0,i.useState)(null),[bo,yo]=(0,i.useState)(null),[wo,ko]=(0,i.useState)(!1),[Co,So]=(0,i.useState)(!1),[Ro,Io]=(0,i.useState)(""),[Eo,Po]=(0,i.useState)(null),[zo,No]=(0,i.useState)(null),[Uo,Oo]=(0,i.useState)(!1),[Fo,Wo]=(0,i.useState)(!1),[qo,Bo]=(0,i.useState)([]),[Ho,Do]=(0,i.useState)(!1),[To,_o]=(0,i.useState)([]),[Mo,Lo]=(0,i.useState)(null),[Zo,Jo]=(0,i.useState)(null),[Go,Yo]=(0,i.useState)(!1),[Vo,Qo]=(0,i.useState)(null),[Ko,Xo]=(0,i.useState)([]),[$o,er]=(0,i.useState)(!1),[or,rr]=(0,i.useState)(null),[nr,sr]=(0,i.useState)({anchorEl:null,message:null}),[ir,tr]=(0,i.useState)({anchorEl:null,message:null,emoji:null}),ar=(0,le.A)(),lr=((0,ce.A)(ar.breakpoints.up("md")),()=>{Ce(null)}),cr=()=>{var e;null===(e=ro.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})};(0,i.useEffect)((()=>{cr()}),[Pe,Ne]),(0,i.useEffect)((()=>{if(!r||!s)return void ue("/messages");(async()=>{try{const e=(0,se.H9)(ie.db,"rooms",r),o=await(0,se.x7)(e);if(!o.exists())return te.oR.error("Room not found"),void ue("/messages");const i=(0,n.A)({id:o.id},o.data());if(je(i),be(i.createdBy===s.uid),!i.members.includes(s.uid)){if(i.locked&&i.createdBy!==s.uid){if(i.pendingRequests&&i.pendingRequests.includes(s.uid))te.oR.success("Your request to join this room is pending approval");else{const o=i.pendingRequests||[];await(0,se.mZ)(e,{pendingRequests:[...o,s.uid]});const n=(0,se.rJ)(ie.db,"notifications");await(0,se.gS)(n,{type:"room_join_request",senderId:s.uid,senderName:s.displayName||"User",senderAvatar:s.photoURL||"",recipientId:i.createdBy,content:"".concat(s.displayName||"A user",' wants to join your room "').concat(i.name,'"'),roomId:r,roomName:i.name,isRead:!1,createdAt:(0,se.O5)()}),te.oR.success("Your request to join this room has been sent to the owner")}return void ue("/messages")}await(0,se.mZ)(e,{members:[...i.members,s.uid]})}ve(!1)}catch(e){console.error("Error fetching room:",e),te.oR.error("Failed to load room"),ue("/messages")}})();const e=(0,se.rJ)(ie.db,"rooms",r,"messages"),o=(0,se.P)(e,(0,se._M)("type","==","chat"),(0,se.My)("timestamp","asc"),(0,se.AB)(100)),i=(0,se.aQ)(o,(e=>{const o=e.docs.map((e=>(0,n.A)({id:e.id},e.data())));ze(o)})),t=(0,se.P)(e,(0,se._M)("type","==","announcement"),(0,se.My)("timestamp","desc"),(0,se.AB)(20)),a=(0,se.aQ)(t,(e=>{const o=e.docs.map((e=>(0,n.A)({id:e.id},e.data())));Ue(o)})),l=(0,se.P)(e,(0,se._M)("type","==","poll"),(0,se.My)("timestamp","desc"),(0,se.AB)(10)),c=(0,se.aQ)(l,(e=>{const o=e.docs.map((e=>(0,n.A)({id:e.id},e.data())));Fe(o)}));return()=>{i(),a(),c()}}),[r,s,ue,ie.db]),(0,i.useEffect)((()=>{if(!s)return;(async()=>{try{const e=(0,se.H9)(ie.db,"users",s.uid),o=await(0,se.x7)(e);if(o.exists()){const e=o.data();so({username:e.username,name:e.name,profilePic:e.profilePic||e.photoURL})}}catch(e){console.error("Error fetching user data:",e)}})()}),[s,ie.db]);const dr=async()=>{if(Se.trim()||ho)try{if(ho)return void await pr();await(0,se.gS)((0,se.rJ)(ie.db,"rooms",r,"messages"),{text:Se.trim(),sender:null===s||void 0===s?void 0:s.uid,senderName:no.name||no.username||(null===s||void 0===s?void 0:s.displayName)||"Anonymous",senderPhoto:no.profilePic||(null===s||void 0===s?void 0:s.photoURL)||null,timestamp:(0,se.O5)(),type:"chat",reactions:[]}),Re(""),cr()}catch(e){console.error("Error sending message:",e),$e("Failed to send message"),oo("error"),Ke(!0)}},mr=async()=>{if(Je.trim())try{Ve([]);const o=Je.trim().toLowerCase(),r=(0,se.rJ)(ie.db,"users");let i=[];try{const e=(0,se.P)(r,(0,se.My)("username_lower"),(0,se.EO)(o),(0,se.FD)(o+"\uf8ff"),(0,se.AB)(20)),s=await(0,se.GG)(e);i=s.docs.map((e=>(0,n.A)({id:e.id},e.data()))),console.log("Found ".concat(i.length," users by username_lower"))}catch(e){console.error("Error searching by username_lower:",e)}if(i.length<10)try{const e=(0,se.P)(r,(0,se.My)("name_lower"),(0,se.EO)(o),(0,se.FD)(o+"\uf8ff"),(0,se.AB)(20)),s=(await(0,se.GG)(e)).docs.map((e=>(0,n.A)({id:e.id},e.data()))).filter((e=>!i.some((o=>o.id===e.id))));i=[...i,...s],console.log("Added ".concat(s.length," users by name_lower, total: ").concat(i.length))}catch(e){console.error("Error searching by name_lower:",e)}if(0===i.length)try{const e=(0,se.P)(r,(0,se._M)("username",">=",o),(0,se._M)("username","<=",o+"\uf8ff"),(0,se.AB)(20)),s=(0,se.P)(r,(0,se._M)("name",">=",o),(0,se._M)("name","<=",o+"\uf8ff"),(0,se.AB)(20)),[t,a]=await Promise.all([(0,se.GG)(e),(0,se.GG)(s)]),l=new Map;t.docs.forEach((e=>{l.set(e.id,(0,n.A)({id:e.id},e.data()))})),a.docs.forEach((e=>{l.set(e.id,(0,n.A)({id:e.id},e.data()))})),i=Array.from(l.values()),console.log("Found ".concat(i.length," users using standard fields"))}catch(e){console.error("Error with fallback search:",e)}if(0===i.length)try{console.log("Using last resort search method");const e=(0,se.P)(r,(0,se.AB)(50)),s=await(0,se.GG)(e);i=s.docs.map((e=>{const o=e.data();return(0,n.A)({id:e.id,username:o.username,name:o.name,profilePic:o.profilePic},o)})).filter((e=>e.username&&e.username.toLowerCase().includes(o)||e.name&&e.name.toLowerCase().includes(o))),console.log("Found ".concat(i.length," users with client-side filtering"))}catch(e){console.error("Error with last resort search:",e)}const t=i.filter((e=>e.id!==(null===s||void 0===s?void 0:s.uid)&&!(null!==Ae&&void 0!==Ae&&Ae.members.includes(e.id))));console.log("Returning ".concat(t.length," users after filtering")),Ve(t),0===t.length&&($e("No matching users found"),oo("info"),Ke(!0))}catch(e){console.error("Error searching users:",e),$e("Failed to search users"),oo("error"),Ke(!0)}},ur=e=>{if(!e)return"";return e.toDate().toLocaleString()},xr=()=>{co&&(clearTimeout(co),mo(null))},hr=()=>{co&&(clearTimeout(co),mo(null))},pr=async e=>{var o,n,i;const t=e?null===(o=e.target.files)||void 0===o?void 0:o[0]:null===(n=Ao.current)||void 0===n||null===(i=n.files)||void 0===i?void 0:i[0];if(!t||!s||!r)return;if(t.size>10485760)return void te.oR.error("File too large. Maximum size is 10MB.");const a=t.type.split("/")[0];if("image"===a||"video"===a){try{po(!0),xo(0);const e=(0,ae.KR)(ie.IG,"chat-media/rooms/".concat(r,"/").concat(Date.now(),"_").concat(t.name)),o=(0,ae.bp)(e,t);o.on("state_changed",(e=>{const o=e.bytesTransferred/e.totalBytes*100;xo(o)}),(e=>{console.error("Error uploading file:",e),te.oR.error("Upload failed: "+e.message),po(!1),xo(null)}),(async()=>{try{const e=await(0,ae.qk)(o.snapshot.ref);await Ar(e,a),po(!1),xo(null)}catch(e){console.error("Error getting download URL:",e),te.oR.error("Failed to process uploaded file"),po(!1),xo(null)}}))}catch(l){console.error("Error handling file upload:",l),te.oR.error("Failed to upload file"),po(!1),xo(null)}Ao.current&&(Ao.current.value="")}else te.oR.error("Only image and video files are supported.")},Ar=async(e,o)=>{if(s)try{const n=(0,se.rJ)(ie.db,"rooms",r,"messages"),i="image"===o?"Sent an image":"Sent a video";await(0,se.gS)(n,{text:i,sender:s.uid,senderName:no.name||no.username||s.displayName||"User",senderPhoto:no.profilePic||s.photoURL||"",timestamp:(0,se.O5)(),type:"chat",mediaUrl:e,mediaType:o}),cr()}catch(n){console.error("Error sending media message:",n),te.oR.error("Failed to send media")}},jr=()=>{yo(null)},gr=()=>{Po(null)},vr=()=>{sr({anchorEl:null,message:null})},fr=()=>{tr({anchorEl:null,message:null,emoji:null})},br=()=>{Lo(null),Jo(null)};(0,i.useEffect)((()=>{s&&(async()=>{if(s)try{const e=(0,se.H9)(ie.db,"users",s.uid),o=await(0,se.x7)(e);if(o.exists()){const e=o.data();Xo(e.blockedUsers||[])}}catch(e){console.error("Error fetching blocked users:",e)}})()}),[s]),(0,i.useEffect)((()=>{To.length>0&&(()=>{if(!Ae||!Ko.length)return;const e=To.find((e=>Ko.includes(e.id)));e&&(rr(e),er(!0))})()}),[To,Ko]);const yr=async(e,o,i)=>{if(Ae&&s&&fe)try{const t=Ae.members.filter((e=>e!==s.uid)),a=t.map((t=>de((0,n.A)({type:e,senderId:s.uid,senderName:no.name||no.username||s.displayName||"Room Owner",senderAvatar:no.profilePic||s.photoURL||"",recipientId:t,content:o,roomId:r,roomName:Ae.name},i))));await Promise.all(a),console.log("Sent ".concat(e," notifications to ").concat(t.length," room members"))}catch(t){console.error("Error sending room notifications:",t)}},wr=e=>{const o=/(https?:\/\/[^\s]+\/side-room\/[^\s]+)/g;return e.split(o).map(((e,r)=>{if(e.match(o)){const o=new URL(e).pathname.split("/"),n=o[o.length-1];return(0,me.jsx)(a.A,{component:"button",onClick:e=>{e.stopPropagation(),(e=>{ue("/side-room/".concat(e))})(n)},sx:{color:"inherit",textDecoration:"underline",background:"none",border:"none",padding:0,font:"inherit",cursor:"pointer","&:hover":{opacity:.8}},children:e},r)}return(0,me.jsx)("span",{children:e},r)}))},kr=async(e,o)=>{if(null!==s&&void 0!==s&&s.uid&&r)try{const i=(0,se.H9)(ie.db,"rooms",r,"messages",e),t=await(0,se.x7)(i);if(!t.exists())return $e("Announcement not found"),oo("error"),void Ke(!0);const a=t.data().reactions||[],l=a.findIndex((e=>e.userId===s.uid&&e.emoji===o));let c;if(-1!==l)c=[...a],c.splice(l,1);else{const e=a.filter((e=>e.userId!==s.uid)),r={emoji:o,userId:s.uid,username:no.name||no.username||s.displayName||""};c=[...e,r]}await(0,se.mZ)(i,{reactions:c}),Ue((o=>o.map((o=>o.id===e?(0,n.A)((0,n.A)({},o),{},{reactions:c}):o))))}catch(i){console.error("Error handling announcement reaction:",i),$e("Failed to update reaction"),oo("error"),Ke(!0)}};return ge?(0,me.jsx)(a.A,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"100vh"},children:(0,me.jsx)(l.A,{})}):(0,me.jsxs)(c.A,{maxWidth:"md",sx:{mt:2,mb:8,height:"100%"},children:[(0,me.jsxs)(d.A,{elevation:0,sx:{p:2},children:[(0,me.jsxs)(a.A,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:2},children:[(0,me.jsxs)(a.A,{sx:{display:"flex",alignItems:"center"},children:[(0,me.jsx)(m.A,{onClick:()=>ue("/messages"),sx:{mr:1},children:(0,me.jsx)(B.A,{})}),(0,me.jsx)(u.A,{variant:"h6",fontWeight:"bold",children:null===Ae||void 0===Ae?void 0:Ae.name})]}),(0,me.jsx)(m.A,{onClick:e=>{Ce(e.currentTarget)},children:(0,me.jsx)(H.A,{})})]}),(null===Ae||void 0===Ae?void 0:Ae.description)&&(0,me.jsx)(u.A,{variant:"body2",color:"text.secondary",sx:{mb:2},children:Ae.description}),(0,me.jsx)(a.A,{sx:{borderBottom:1,borderColor:"divider"},children:(0,me.jsxs)(x.A,{value:ye,onChange:(e,o)=>{we(o)},"aria-label":"room tabs",variant:"fullWidth",children:[(0,me.jsx)(h.A,{label:"General Chat",icon:(0,me.jsx)(D.A,{}),iconPosition:"start",id:"room-tab-0","aria-controls":"room-tabpanel-0"}),(0,me.jsx)(h.A,{label:"Announcements",icon:(0,me.jsx)(T.A,{}),iconPosition:"start",id:"room-tab-1","aria-controls":"room-tabpanel-1"}),(0,me.jsx)(h.A,{label:"Polls",icon:(0,me.jsx)(_.A,{}),iconPosition:"start",id:"room-tab-2","aria-controls":"room-tabpanel-2"})]})})]}),ho&&(0,me.jsxs)(a.A,{sx:{width:"100%",px:2,py:1,bgcolor:"background.paper"},children:[(0,me.jsxs)(u.A,{variant:"caption",gutterBottom:!0,children:["Uploading media... ",uo?Math.round(uo):0,"%"]}),(0,me.jsx)(p.A,{variant:"determinate",value:uo||0,sx:{height:6,borderRadius:3}})]}),(0,me.jsxs)(d.A,{elevation:0,sx:{height:"calc(100vh - 250px)",mt:2},children:[(0,me.jsxs)(xe,{value:ye,index:0,children:[(0,me.jsx)(a.A,{sx:{height:"calc(100vh - 350px)",overflowY:"auto",mb:2},children:0===Pe.length?(0,me.jsx)(a.A,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"100%"},children:(0,me.jsx)(u.A,{variant:"body2",color:"text.secondary",children:"No messages yet. Start the conversation!"})}):(0,me.jsxs)(A.A,{children:[Pe.map((e=>{var o,r;const n=e.sender===(null===s||void 0===s?void 0:s.uid);return(0,me.jsxs)(j.Ay,{alignItems:"flex-start",sx:{flexDirection:n?"row-reverse":"row",px:1},children:[(0,me.jsx)(g.A,{sx:{minWidth:n?"40px":"56px",ml:n?1:0},children:(0,me.jsxs)(a.A,{sx:{position:"relative"},children:[(0,me.jsx)(v.A,{alt:e.senderName,src:e.senderPhoto,sx:{width:40,height:40,bgcolor:e.senderPhoto?void 0:n?"primary.main":"secondary.main",cursor:"pointer","&:hover":{opacity:.8}},onClick:()=>ue("/profile/".concat(e.sender)),children:!e.senderPhoto&&(null===(o=e.senderName)||void 0===o||null===(r=o.charAt(0))||void 0===r?void 0:r.toUpperCase())}),!n&&(0,me.jsx)(a.A,{sx:{position:"absolute",bottom:4,right:4,zIndex:1},children:(0,me.jsx)(W.A,{isOnline:pe(e.sender),size:"small"})})]})}),(0,me.jsxs)(a.A,{sx:{display:"flex",flexDirection:"column",alignItems:n?"flex-end":"flex-start",maxWidth:"75%"},children:[(0,me.jsx)(u.A,{variant:"caption",color:"text.secondary",sx:{mb:.5,cursor:"pointer","&:hover":{textDecoration:"underline"}},onClick:()=>ue("/profile/".concat(e.sender)),children:n?"You":e.senderName}),(0,me.jsxs)(d.A,{elevation:0,sx:{p:1.5,borderRadius:2,bgcolor:n?"primary.light":"background.paper",color:n?"primary.contrastText":"text.primary",cursor:"pointer",position:"relative","&:hover":{opacity:.9}},onClick:o=>((e,o)=>{sr({anchorEl:e.currentTarget,message:o})})(o,e),onMouseDown:()=>n&&(e=>{if(e.sender!==(null===s||void 0===s?void 0:s.uid))return;const o=setTimeout((()=>{to(e),lo(!0)}),500);mo(o)})(e),onMouseUp:xr,onTouchStart:()=>n&&(e=>{if(e.sender!==(null===s||void 0===s?void 0:s.uid))return;const o=setTimeout((()=>{to(e),lo(!0)}),500);mo(o)})(e),onTouchEnd:hr,children:[e.mediaUrl&&"image"===e.mediaType&&(0,me.jsx)(a.A,{sx:{mb:1},children:(0,me.jsx)("img",{src:e.mediaUrl,alt:"Shared image",style:{maxWidth:"100%",maxHeight:"300px",borderRadius:"8px",display:"block"}})}),e.mediaUrl&&"video"===e.mediaType&&(0,me.jsx)(a.A,{sx:{mb:1},children:(0,me.jsx)("video",{src:e.mediaUrl,controls:!0,style:{maxWidth:"100%",maxHeight:"300px",borderRadius:"8px",display:"block"}})}),(0,me.jsx)(u.A,{variant:"body1",children:wr(e.text)}),(0,me.jsx)(u.A,{variant:"caption",color:n?"primary.contrastText":"text.secondary",sx:{display:"block",opacity:.8,mt:.5,textAlign:"right"},children:ur(e.timestamp)})]}),e.reactions&&e.reactions.length>0&&(0,me.jsx)(a.A,{sx:{display:"flex",flexDirection:n?"row-reverse":"row",flexWrap:"wrap",gap:.5,mt:.5,maxWidth:"100%"},children:Object.entries(e.reactions.reduce(((e,o)=>(e[o.emoji]=(e[o.emoji]||0)+1,e)),{})).map((o=>{var r;let[n,i]=o;const t=null===(r=e.reactions)||void 0===r?void 0:r.some((e=>e.emoji===n&&e.userId===(null===s||void 0===s?void 0:s.uid)));return(0,me.jsx)(f.A,{label:"".concat(n," ").concat(i),size:"small",variant:"outlined",onClick:o=>((e,o,r)=>{e.stopPropagation(),tr({anchorEl:e.currentTarget,message:o,emoji:r})})(o,e,n),sx:{borderRadius:"12px",height:"24px",fontSize:"0.75rem",cursor:"pointer",backgroundColor:e=>t?"dark"===e.palette.mode?"rgba(25, 118, 210, 0.2)":"rgba(25, 118, 210, 0.1)":"dark"===e.palette.mode?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.05)",border:e=>t?"1px solid ".concat(e.palette.primary.main):void 0,"&:hover":{backgroundColor:e=>t?"dark"===e.palette.mode?"rgba(25, 118, 210, 0.3)":"rgba(25, 118, 210, 0.2)":"dark"===e.palette.mode?"rgba(255,255,255,0.15)":"rgba(0,0,0,0.1)"}}},n)}))})]})]},e.id)})),(0,me.jsx)("div",{ref:ro})]})}),(0,me.jsxs)(a.A,{sx:{display:"flex",p:1},children:[(0,me.jsx)(he,{ref:Ao,accept:"image/*,video/*",id:"file-upload-input",type:"file",onChange:pr}),(0,me.jsx)(m.A,{onClick:()=>{var e;null===(e=Ao.current)||void 0===e||e.click()},color:"primary",sx:{mr:1},"aria-label":"attach file",children:(0,me.jsx)(M.A,{})}),(0,me.jsx)(m.A,{onClick:()=>{go(!jo)},color:"primary",sx:{mr:1},"aria-label":"add emoji",children:(0,me.jsx)(L.A,{})}),(0,me.jsx)(b.A,{fullWidth:!0,placeholder:"Type a message...",variant:"outlined",value:Se,onChange:e=>Re(e.target.value),onKeyPress:e=>"Enter"===e.key&&dr(),sx:{mr:1}}),(0,me.jsx)(y.A,{variant:"contained",endIcon:(0,me.jsx)(Z.A,{}),onClick:dr,disabled:!Se.trim()&&!ho,children:"Send"})]})]}),(0,me.jsxs)(xe,{value:ye,index:1,children:[fe&&(0,me.jsxs)(a.A,{sx:{mb:3,p:2,bgcolor:"background.paper",borderRadius:1},children:[(0,me.jsx)(u.A,{variant:"subtitle1",gutterBottom:!0,children:"Create Announcement"}),(0,me.jsx)(b.A,{fullWidth:!0,placeholder:"Post an announcement to all members...",variant:"outlined",multiline:!0,rows:3,value:Ie,onChange:e=>Ee(e.target.value),sx:{mb:1}}),(0,me.jsx)(y.A,{variant:"contained",endIcon:(0,me.jsx)(T.A,{}),onClick:async()=>{if(Ie.trim()&&s&&fe)try{const e=(0,se.rJ)(ie.db,"rooms",r,"messages");await(0,se.gS)(e,{text:Ie.trim(),sender:s.uid,senderName:no.name||no.username||s.displayName||"User",senderPhoto:no.profilePic||s.photoURL||"",timestamp:(0,se.O5)(),type:"announcement",reactions:[]}),await yr("room_announcement",'\ud83d\udce2 New announcement in "'.concat(null===Ae||void 0===Ae?void 0:Ae.name,'": ').concat(Ie.trim().substring(0,100)).concat(Ie.trim().length>100?"...":""),{postId:null}),Ee(""),$e("Announcement posted"),oo("success"),Ke(!0)}catch(e){console.error("Error posting announcement:",e),te.oR.error("Failed to post announcement")}},disabled:!Ie.trim(),children:"Post Announcement"})]}),(0,me.jsx)(a.A,{children:0===Ne.length?(0,me.jsx)(a.A,{sx:{display:"flex",justifyContent:"center",alignItems:"center",py:4},children:(0,me.jsx)(u.A,{variant:"body2",color:"text.secondary",children:"No announcements yet."})}):(0,me.jsx)(A.A,{children:Ne.map((e=>{var o,r,n,i;return(0,me.jsxs)(d.A,{elevation:0,sx:{mb:2,p:2,bgcolor:"background.default"},children:[(0,me.jsxs)(a.A,{sx:{display:"flex",alignItems:"center",mb:1},children:[(0,me.jsxs)(a.A,{sx:{position:"relative",mr:1},children:[(0,me.jsx)(v.A,{alt:e.senderName,src:e.senderPhoto}),(0,me.jsx)(a.A,{sx:{position:"absolute",bottom:4,right:4,zIndex:1},children:(0,me.jsx)(W.A,{isOnline:pe(e.sender),size:"small"})})]}),(0,me.jsxs)(a.A,{sx:{flexGrow:1},children:[(0,me.jsx)(u.A,{variant:"subtitle2",children:e.senderName}),(0,me.jsx)(u.A,{variant:"caption",color:"text.secondary",children:ur(e.timestamp)})]}),fe&&(0,me.jsx)(m.A,{size:"small",onClick:o=>((e,o)=>{e.stopPropagation(),yo(e.currentTarget),fo(o)})(o,e),sx:{ml:1},children:(0,me.jsx)(H.A,{fontSize:"small"})})]}),(0,me.jsx)(u.A,{variant:"body1",sx:{mb:2},children:e.text}),(0,me.jsxs)(a.A,{sx:{display:"flex",alignItems:"center",gap:1,mt:2},children:[(0,me.jsxs)(a.A,{sx:{display:"flex",alignItems:"center"},children:[(0,me.jsx)(m.A,{size:"small",onClick:()=>kr(e.id,"\u2764\ufe0f"),sx:{color:null!==(o=e.reactions)&&void 0!==o&&o.some((e=>"\u2764\ufe0f"===e.emoji&&e.userId===(null===s||void 0===s?void 0:s.uid)))?"red":"text.secondary","&:hover":{color:"red",backgroundColor:"rgba(255, 0, 0, 0.1)"}},children:"\u2764\ufe0f"}),(0,me.jsx)(u.A,{variant:"caption",color:"text.secondary",children:(null===(r=e.reactions)||void 0===r?void 0:r.filter((e=>"\u2764\ufe0f"===e.emoji)).length)||0})]}),(0,me.jsxs)(a.A,{sx:{display:"flex",alignItems:"center"},children:[(0,me.jsx)(m.A,{size:"small",onClick:()=>kr(e.id,"\ud83d\udc94"),sx:{color:null!==(n=e.reactions)&&void 0!==n&&n.some((e=>"\ud83d\udc94"===e.emoji&&e.userId===(null===s||void 0===s?void 0:s.uid)))?"purple":"text.secondary","&:hover":{color:"purple",backgroundColor:"rgba(128, 0, 128, 0.1)"}},children:"\ud83d\udc94"}),(0,me.jsx)(u.A,{variant:"caption",color:"text.secondary",children:(null===(i=e.reactions)||void 0===i?void 0:i.filter((e=>"\ud83d\udc94"===e.emoji)).length)||0})]})]})]},e.id)}))})})]}),(0,me.jsxs)(xe,{value:ye,index:2,children:[fe&&(0,me.jsxs)(a.A,{sx:{mb:3,p:2,bgcolor:"background.paper",borderRadius:1},children:[(0,me.jsx)(u.A,{variant:"subtitle1",gutterBottom:!0,children:"Create Poll"}),(0,me.jsx)(y.A,{variant:"contained",startIcon:(0,me.jsx)(_.A,{}),onClick:()=>Te(!0),fullWidth:!0,children:"Create New Poll"})]}),(0,me.jsx)(a.A,{children:0===Oe.length?(0,me.jsx)(a.A,{sx:{display:"flex",justifyContent:"center",alignItems:"center",py:4},children:(0,me.jsx)(u.A,{variant:"body2",color:"text.secondary",children:"No polls have been created yet."})}):(0,me.jsx)(A.A,{children:Oe.map((e=>{var o;return(0,me.jsxs)(d.A,{elevation:0,sx:{mb:3,p:2,bgcolor:"background.default"},children:[(0,me.jsxs)(a.A,{sx:{display:"flex",alignItems:"center",mb:2},children:[(0,me.jsxs)(a.A,{sx:{position:"relative",mr:1},children:[(0,me.jsx)(v.A,{alt:e.senderName,src:e.senderPhoto}),(0,me.jsx)(a.A,{sx:{position:"absolute",bottom:4,right:4,zIndex:1},children:(0,me.jsx)(W.A,{isOnline:pe(e.sender),size:"small"})})]}),(0,me.jsxs)(a.A,{sx:{flexGrow:1},children:[(0,me.jsx)(u.A,{variant:"subtitle2",children:e.senderName}),(0,me.jsx)(u.A,{variant:"caption",color:"text.secondary",children:ur(e.timestamp)})]}),fe&&e.sender===(null===s||void 0===s?void 0:s.uid)&&(0,me.jsx)(m.A,{size:"small",onClick:o=>((e,o)=>{e.stopPropagation(),Po(e.currentTarget),No(o)})(o,e),sx:{ml:1},children:(0,me.jsx)(H.A,{fontSize:"small"})})]}),(0,me.jsx)(u.A,{variant:"h6",gutterBottom:!0,children:e.text}),null===(o=e.pollOptions)||void 0===o?void 0:o.map(((o,n)=>{var i;const t=(null===(i=e.pollVotes)||void 0===i?void 0:i[n.toString()])||[],l=t.length,c=Object.values(e.pollVotes||{}).reduce(((e,o)=>e+((null===o||void 0===o?void 0:o.length)||0)),0),d=c>0?Math.round(l/c*100):0,m=t.includes((null===s||void 0===s?void 0:s.uid)||"");return(0,me.jsxs)(a.A,{sx:{mb:1,p:1.5,borderRadius:1,bgcolor:m?"primary.light":"background.paper",position:"relative",overflow:"hidden",cursor:"pointer","&:hover":{bgcolor:m?"primary.light":"action.hover"}},onClick:()=>(async(e,o)=>{if(s)try{const n=(0,se.H9)(ie.db,"rooms",r,"messages",e),i=await(0,se.x7)(n);if(!i.exists())return;const t=i.data().pollVotes||{};Object.keys(t).forEach((e=>{var o;null!==(o=t[e])&&void 0!==o&&o.includes(s.uid)&&(t[e]=t[e].filter((e=>e!==s.uid)))}));const a=o.toString();t[a]||(t[a]=[]),t[a]=[...t[a],s.uid],await(0,se.mZ)(n,{pollVotes:t})}catch(n){console.error("Error voting on poll:",n),te.oR.error("Failed to submit vote")}})(e.id,n),children:[(0,me.jsx)(a.A,{sx:{position:"absolute",left:0,top:0,height:"100%",width:"".concat(d,"%"),bgcolor:"primary.main",opacity:.2,zIndex:0}}),(0,me.jsxs)(a.A,{sx:{display:"flex",justifyContent:"space-between",position:"relative",zIndex:1},children:[(0,me.jsx)(u.A,{variant:"body1",children:o}),(0,me.jsxs)(u.A,{variant:"body2",children:[l," ",1===l?"vote":"votes"," (",d,"%)"]})]})]},n)}))]},e.id)}))})})]})]}),(0,me.jsx)(w.A,{anchorEl:ke,open:Boolean(ke),onClose:lr,children:fe?(0,me.jsxs)(me.Fragment,{children:[(0,me.jsxs)(k.A,{onClick:()=>{qe(!0),lr()},children:[(0,me.jsx)(C.A,{children:(0,me.jsx)(J.A,{fontSize:"small"})}),"Invite People"]}),(0,me.jsxs)(k.A,{onClick:()=>{Do(!0),(async()=>{if(Ae&&Ae.members)try{const e=await Promise.all(Ae.members.map((async e=>{const o=(0,se.H9)(ie.db,"users",e),r=await(0,se.x7)(o);if(r.exists()){const o=r.data();return{id:e,username:o.username||"Unknown user",name:o.name,profilePic:o.profilePic}}return null})));_o(e.filter(Boolean))}catch(e){console.error("Error fetching room members:",e),$e("Failed to load room members"),oo("error"),Ke(!0)}})(),lr()},children:[(0,me.jsx)(C.A,{children:(0,me.jsx)(J.A,{fontSize:"small"})}),"Members"]}),(0,me.jsxs)(k.A,{onClick:async()=>{if(Ae&&fe)try{const e=!Ae.locked,o=(0,se.H9)(ie.db,"rooms",r);await(0,se.mZ)(o,{locked:e}),je((0,n.A)((0,n.A)({},Ae),{},{locked:e})),$e("Room ".concat(e?"locked":"unlocked")),oo("success"),Ke(!0),lr()}catch(e){console.error("Error toggling room lock:",e),$e("Failed to update room settings"),oo("error"),Ke(!0)}},children:[(0,me.jsx)(C.A,{children:null!==Ae&&void 0!==Ae&&Ae.locked?(0,me.jsx)(G.A,{fontSize:"small"}):(0,me.jsx)(Y.A,{fontSize:"small"})}),null!==Ae&&void 0!==Ae&&Ae.locked?"Unlock Room":"Lock Room"]}),(null===Ae||void 0===Ae?void 0:Ae.locked)&&(null===Ae||void 0===Ae?void 0:Ae.pendingRequests)&&Ae.pendingRequests.length>0&&(0,me.jsxs)(k.A,{onClick:async()=>{if(Ae&&fe)try{if(Ae.pendingRequests&&Ae.pendingRequests.length>0){const e=await Promise.all(Ae.pendingRequests.map((async e=>{const o=(0,se.H9)(ie.db,"users",e),r=await(0,se.x7)(o);if(r.exists()){const o=r.data();return{id:e,username:o.username||"Unknown user",profilePic:o.profilePic}}return null})));Bo(e.filter(Boolean))}else Bo([]);Wo(!0)}catch(e){console.error("Error fetching pending requests:",e),$e("Failed to load join requests"),oo("error"),Ke(!0)}},children:[(0,me.jsx)(C.A,{children:(0,me.jsx)(J.A,{fontSize:"small"})}),"View Join Requests",(0,me.jsx)(S.A,{color:"primary",badgeContent:Ae.pendingRequests.length,sx:{ml:1}})]}),(0,me.jsxs)(k.A,{onClick:()=>{He(!0),lr()},sx:{color:"error.main"},children:[(0,me.jsx)(C.A,{children:(0,me.jsx)(V.A,{fontSize:"small",color:"error"})}),"Delete Room"]})]}):(0,me.jsxs)(me.Fragment,{children:[(0,me.jsxs)(k.A,{onClick:()=>{$e("Room reported to moderators"),oo("info"),Ke(!0),lr()},children:[(0,me.jsx)(C.A,{children:(0,me.jsx)(Q.A,{fontSize:"small"})}),"Report Room"]}),(0,me.jsxs)(k.A,{onClick:async()=>{if(Ae&&s)try{const e=(0,se.H9)(ie.db,"rooms",r);await(0,se.mZ)(e,{members:Ae.members.filter((e=>e!==s.uid))}),ue("/messages"),te.oR.success("You left the room")}catch(e){console.error("Error leaving room:",e),te.oR.error("Failed to leave room")}},sx:{color:"error.main"},children:[(0,me.jsx)(C.A,{children:(0,me.jsx)(K.A,{fontSize:"small",color:"error"})}),"Leave Room"]})]})}),(0,me.jsxs)(R.A,{open:We,onClose:()=>qe(!1),maxWidth:"sm",fullWidth:!0,children:[(0,me.jsx)(I.A,{children:"Invite People to Room"}),(0,me.jsxs)(E.A,{children:[(0,me.jsx)(P.A,{sx:{mb:2},children:"Search for users to add to this room."}),(0,me.jsxs)(a.A,{sx:{display:"flex",mb:2},children:[(0,me.jsx)(b.A,{fullWidth:!0,label:"Search by username",variant:"outlined",value:Je,onChange:e=>Ge(e.target.value),onKeyPress:e=>"Enter"===e.key&&mr(),sx:{mr:1}}),(0,me.jsx)(y.A,{variant:"contained",onClick:mr,children:"Search"})]}),Ye.length>0?(0,me.jsx)(A.A,{children:Ye.map((e=>(0,me.jsxs)(j.Ay,{secondaryAction:(0,me.jsx)(y.A,{variant:"outlined",size:"small",startIcon:(0,me.jsx)(X.A,{}),onClick:()=>(async e=>{if(Ae&&s)try{const o=(0,se.H9)(ie.db,"rooms",r);await(0,se.mZ)(o,{members:[...Ae.members,e]});const n=(0,se.rJ)(ie.db,"notifications");await(0,se.gS)(n,{type:"room_invite",from:s.uid,to:e,roomId:r,roomName:Ae.name,read:!1,timestamp:(0,se.O5)()}),Ve((o=>o.filter((o=>o.id!==e)))),$e("User invited to room"),oo("success"),Ke(!0)}catch(o){console.error("Error inviting user:",o),te.oR.error("Failed to invite user")}})(e.id),children:"Invite"}),children:[(0,me.jsx)(g.A,{children:(0,me.jsxs)(a.A,{sx:{position:"relative"},children:[(0,me.jsx)(v.A,{alt:e.username,src:e.profilePic}),(0,me.jsx)(a.A,{sx:{position:"absolute",bottom:4,right:4,zIndex:1},children:(0,me.jsx)(W.A,{isOnline:pe(e.id),size:"small"})})]})}),(0,me.jsx)(z.A,{primary:e.name||e.username,secondary:"@".concat(e.username)})]},e.id)))}):Je?(0,me.jsxs)(u.A,{variant:"body2",color:"text.secondary",sx:{textAlign:"center",py:2},children:['No users found matching "',Je,'"']}):null]}),(0,me.jsx)(N.A,{children:(0,me.jsx)(y.A,{onClick:()=>qe(!1),children:"Close"})})]}),(0,me.jsxs)(R.A,{open:Be,onClose:()=>He(!1),children:[(0,me.jsx)(I.A,{children:"Delete Room?"}),(0,me.jsx)(E.A,{children:(0,me.jsx)(P.A,{children:"Are you sure you want to delete this room? This action cannot be undone and all messages will be permanently deleted."})}),(0,me.jsxs)(N.A,{children:[(0,me.jsx)(y.A,{onClick:()=>He(!1),children:"Cancel"}),(0,me.jsx)(y.A,{onClick:async()=>{if(fe&&r)try{ve(!0);const e=(0,se.rJ)(ie.db,"rooms",r,"messages"),o=(await(0,se.GG)(e)).docs.map((e=>(0,se.kd)(e.ref)));await Promise.all(o),await(0,se.kd)((0,se.H9)(ie.db,"rooms",r)),ue("/messages"),te.oR.success("Room deleted")}catch(e){console.error("Error deleting room:",e),te.oR.error("Failed to delete room"),ve(!1)}},color:"error",variant:"contained",children:"Delete"})]})]}),(0,me.jsxs)(R.A,{open:De,onClose:()=>Te(!1),maxWidth:"sm",fullWidth:!0,children:[(0,me.jsx)(I.A,{children:"Create Poll"}),(0,me.jsxs)(E.A,{children:[(0,me.jsx)(b.A,{autoFocus:!0,margin:"dense",label:"Poll Question",fullWidth:!0,variant:"outlined",value:_e,onChange:e=>Me(e.target.value),sx:{mb:3}}),(0,me.jsx)(u.A,{variant:"subtitle2",gutterBottom:!0,children:"Options"}),Le.map(((e,o)=>(0,me.jsx)(b.A,{margin:"dense",label:"Option ".concat(o+1),fullWidth:!0,variant:"outlined",value:e.text,onChange:e=>((e,o)=>{const r=[...Le];r[e].text=o,Ze(r)})(o,e.target.value),sx:{mb:1}},o))),(0,me.jsx)(y.A,{variant:"outlined",startIcon:(0,me.jsx)(X.A,{}),onClick:()=>{Ze([...Le,{text:""}])},sx:{mt:1},children:"Add Option"})]}),(0,me.jsxs)(N.A,{children:[(0,me.jsx)(y.A,{onClick:()=>Te(!1),children:"Cancel"}),(0,me.jsx)(y.A,{onClick:async()=>{if(!_e.trim()||!s||!fe)return;const e=Le.map((e=>e.text.trim())).filter(Boolean);if(e.length<2)return $e("A poll needs at least 2 options"),oo("error"),void Ke(!0);try{const o=(0,se.rJ)(ie.db,"rooms",r,"messages");await(0,se.gS)(o,{text:_e.trim(),sender:s.uid,senderName:no.name||no.username||s.displayName||"User",senderPhoto:no.profilePic||s.photoURL||"",timestamp:(0,se.O5)(),type:"poll",pollOptions:e,pollVotes:{}}),await yr("room_poll",'\ud83d\udcca New poll in "'.concat(null===Ae||void 0===Ae?void 0:Ae.name,'": ').concat(_e.trim().substring(0,80)).concat(_e.trim().length>80?"...":""),{postId:null}),Me(""),Ze([{text:""},{text:""}]),Te(!1),$e("Poll created"),oo("success"),Ke(!0)}catch(o){console.error("Error creating poll:",o),te.oR.error("Failed to create poll")}},variant:"contained",disabled:!_e.trim()||Le.filter((e=>e.text.trim())).length<2,children:"Create Poll"})]})]}),(0,me.jsxs)(R.A,{open:ao,onClose:()=>{lo(!1),to(null)},children:[(0,me.jsx)(I.A,{children:"Delete Message?"}),(0,me.jsxs)(E.A,{children:[(0,me.jsx)(P.A,{children:"Are you sure you want to delete this message? This action cannot be undone."}),io&&(0,me.jsx)(d.A,{elevation:0,sx:{p:2,mt:2,bgcolor:"background.default"},children:(0,me.jsx)(u.A,{variant:"body1",children:io.text})})]}),(0,me.jsxs)(N.A,{children:[(0,me.jsx)(y.A,{onClick:()=>{lo(!1),to(null)},children:"Cancel"}),(0,me.jsx)(y.A,{onClick:async()=>{if(!io||!s||io.sender!==s.uid)return lo(!1),void to(null);try{const e=(0,se.H9)(ie.db,"rooms",r,"messages",io.id);await(0,se.kd)(e),$e("Message deleted"),oo("success"),Ke(!0)}catch(e){console.error("Error deleting message:",e),$e("Failed to delete message"),oo("error"),Ke(!0)}finally{lo(!1),to(null)}},color:"error",startIcon:(0,me.jsx)($.A,{}),children:"Delete"})]})]}),(0,me.jsx)(U.Ay,{open:jo,onClose:()=>go(!1),anchorReference:"anchorPosition",anchorPosition:{top:window.innerHeight-300,left:window.innerWidth/2},transformOrigin:{vertical:"bottom",horizontal:"center"},children:(0,me.jsx)(a.A,{sx:{p:1,width:"300px",maxWidth:"90vw",height:"200px",overflow:"auto",display:"flex",flexWrap:"wrap",justifyContent:"center"},children:["\ud83d\ude00","\ud83d\ude01","\ud83d\ude02","\ud83e\udd23","\ud83d\ude03","\ud83d\ude04","\ud83d\ude05","\ud83d\ude06","\ud83d\ude09","\ud83d\ude0a","\ud83d\ude0b","\ud83d\ude0e","\ud83d\ude0d","\ud83e\udd70","\ud83d\ude18","\ud83d\ude17","\ud83d\ude19","\ud83d\ude1a","\ud83d\ude42","\ud83e\udd17","\ud83e\udd14","\ud83e\udd28","\ud83d\ude10","\ud83d\ude11","\ud83d\ude36","\ud83d\ude44","\ud83d\ude0f","\ud83d\ude23","\ud83d\ude25","\ud83d\ude2e","\ud83d\udc4d","\ud83d\udc4e","\ud83d\udc4c","\u270c\ufe0f","\ud83e\udd1e","\ud83e\udd1f","\ud83e\udd18","\ud83d\udc4a","\ud83d\udc4b","\ud83d\ude4c","\u2764\ufe0f","\ud83d\udc94","\ud83d\udc96","\ud83d\udc99","\ud83d\ude22","\ud83d\ude2d","\ud83d\ude24","\ud83d\ude20","\ud83d\ude21","\ud83e\udd2c"].map((e=>(0,me.jsx)(a.A,{component:"button",onClick:()=>{(e=>{Re((o=>o+e))})(e),go(!1)},sx:{border:"none",background:"none",cursor:"pointer",fontSize:"1.8rem",m:.5,p:.5,borderRadius:"4px",minWidth:"40px",height:"40px",display:"flex",alignItems:"center",justifyContent:"center","&:hover":{background:e=>"dark"===e.palette.mode?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.05)"}},children:e},e)))})}),(0,me.jsx)(O.A,{open:Qe,autoHideDuration:4e3,onClose:()=>Ke(!1),children:(0,me.jsx)(F.A,{onClose:()=>Ke(!1),severity:eo,sx:{width:"100%"},children:Xe})}),(0,me.jsxs)(w.A,{anchorEl:bo,open:Boolean(bo),onClose:jr,children:[(0,me.jsxs)(k.A,{onClick:()=>{vo&&(Io(vo.text),ko(!0)),jr()},children:[(0,me.jsx)(C.A,{children:(0,me.jsx)(ee.A,{fontSize:"small"})}),"Edit Announcement"]}),(0,me.jsxs)(k.A,{onClick:()=>{So(!0),jr()},sx:{color:"error.main"},children:[(0,me.jsx)(C.A,{children:(0,me.jsx)(V.A,{fontSize:"small",color:"error"})}),"Delete Announcement"]})]}),(0,me.jsxs)(R.A,{open:wo,onClose:()=>ko(!1),fullWidth:!0,maxWidth:"sm",children:[(0,me.jsx)(I.A,{children:"Edit Announcement"}),(0,me.jsx)(E.A,{children:(0,me.jsx)(b.A,{autoFocus:!0,fullWidth:!0,multiline:!0,rows:4,value:Ro,onChange:e=>Io(e.target.value),margin:"dense",variant:"outlined"})}),(0,me.jsxs)(N.A,{children:[(0,me.jsx)(y.A,{onClick:()=>ko(!1),children:"Cancel"}),(0,me.jsx)(y.A,{onClick:async()=>{if(vo&&s&&fe&&Ro.trim())try{const e=(0,se.H9)(ie.db,"rooms",r,"messages",vo.id);await(0,se.mZ)(e,{text:Ro.trim()}),$e("Announcement updated"),oo("success"),Ke(!0),ko(!1)}catch(e){console.error("Error updating announcement:",e),$e("Failed to update announcement"),oo("error"),Ke(!0)}},variant:"contained",color:"primary",disabled:!Ro.trim(),children:"Save Changes"})]})]}),(0,me.jsxs)(R.A,{open:Co,onClose:()=>So(!1),children:[(0,me.jsx)(I.A,{children:"Delete Announcement?"}),(0,me.jsx)(E.A,{children:(0,me.jsx)(P.A,{children:"Are you sure you want to delete this announcement? This action cannot be undone."})}),(0,me.jsxs)(N.A,{children:[(0,me.jsx)(y.A,{onClick:()=>So(!1),children:"Cancel"}),(0,me.jsx)(y.A,{onClick:async()=>{if(vo&&s&&fe)try{const e=(0,se.H9)(ie.db,"rooms",r,"messages",vo.id);await(0,se.kd)(e),$e("Announcement deleted"),oo("success"),Ke(!0),So(!1),fo(null)}catch(e){console.error("Error deleting announcement:",e),$e("Failed to delete announcement"),oo("error"),Ke(!0)}},color:"error",variant:"contained",children:"Delete"})]})]}),(0,me.jsxs)(R.A,{open:Uo,onClose:()=>Oo(!1),children:[(0,me.jsx)(I.A,{children:"Delete Poll?"}),(0,me.jsx)(E.A,{children:(0,me.jsx)(P.A,{children:"Are you sure you want to delete this poll? This action cannot be undone."})}),(0,me.jsxs)(N.A,{children:[(0,me.jsx)(y.A,{onClick:()=>Oo(!1),children:"Cancel"}),(0,me.jsx)(y.A,{onClick:async()=>{if(zo&&s&&fe)try{const e=(0,se.H9)(ie.db,"rooms",r,"messages",zo.id);await(0,se.kd)(e),$e("Poll deleted"),oo("success"),Ke(!0),Oo(!1),No(null)}catch(e){console.error("Error deleting poll:",e),$e("Failed to delete poll"),oo("error"),Ke(!0)}},color:"error",variant:"contained",children:"Delete"})]})]}),(0,me.jsx)(w.A,{anchorEl:Eo,open:Boolean(Eo),onClose:gr,children:(0,me.jsxs)(k.A,{onClick:()=>{Oo(!0),gr()},sx:{color:"error.main"},children:[(0,me.jsx)(C.A,{children:(0,me.jsx)(V.A,{fontSize:"small",color:"error"})}),"Delete Poll"]})}),(0,me.jsx)(U.Ay,{open:Boolean(nr.anchorEl),anchorEl:nr.anchorEl,onClose:vr,anchorOrigin:{vertical:"top",horizontal:"center"},transformOrigin:{vertical:"bottom",horizontal:"center"},children:(0,me.jsx)(a.A,{sx:{p:1,display:"flex",flexWrap:"wrap",maxWidth:"300px"},children:[{emoji:"\ud83d\udc4d",label:"Like"},{emoji:"\u2764\ufe0f",label:"Love"},{emoji:"\ud83d\ude00",label:"Happy"},{emoji:"\ud83d\ude14",label:"Sad"},{emoji:"\ud83d\udc40",label:"Eyes"},{emoji:"\ud83d\udd25",label:"Fire"},{emoji:"\ud83c\udf89",label:"Celebration"},{emoji:"\ud83e\udd14",label:"Thinking"}].map((e=>(0,me.jsx)(m.A,{onClick:()=>(async e=>{if(nr.message&&null!==s&&void 0!==s&&s.uid&&r)try{const o=nr.message.id,i=(0,se.H9)(ie.db,"rooms",r,"messages",o),t=nr.message.reactions||[],a=t.findIndex((o=>o.userId===s.uid&&o.emoji===e));if(-1!==a){const e=[...t];e.splice(a,1),await(0,se.mZ)(i,{reactions:e}),"chat"===nr.message.type?ze((r=>r.map((r=>r.id===o?(0,n.A)((0,n.A)({},r),{},{reactions:e}):r)))):"announcement"===nr.message.type&&Ue((r=>r.map((r=>r.id===o?(0,n.A)((0,n.A)({},r),{},{reactions:e}):r))))}else{const r={emoji:e,userId:s.uid,username:s.displayName||""},a=[...t,r];await(0,se.mZ)(i,{reactions:a}),"chat"===nr.message.type?ze((e=>e.map((e=>e.id===o?(0,n.A)((0,n.A)({},e),{},{reactions:a}):e)))):"announcement"===nr.message.type&&Ue((e=>e.map((e=>e.id===o?(0,n.A)((0,n.A)({},e),{},{reactions:a}):e))))}vr()}catch(o){console.error("Error adding reaction:",o),$e("Failed to add reaction"),oo("error"),Ke(!0),vr()}})(e.emoji),sx:{m:.5,"&:hover":{bgcolor:"rgba(0,0,0,0.04)"}},"aria-label":e.label,children:(0,me.jsx)(u.A,{variant:"body1",sx:{fontSize:"1.4rem"},children:e.emoji})},e.emoji)))})}),(0,me.jsx)(U.Ay,{open:Boolean(ir.anchorEl),anchorEl:ir.anchorEl,onClose:fr,anchorOrigin:{vertical:"top",horizontal:"center"},transformOrigin:{vertical:"bottom",horizontal:"center"},children:(0,me.jsxs)(a.A,{sx:{p:2,maxWidth:"250px"},children:[(0,me.jsxs)(a.A,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:1.5,pb:1,borderBottom:1,borderColor:"divider"},children:[(0,me.jsxs)(u.A,{variant:"h6",sx:{display:"flex",alignItems:"center"},children:[(0,me.jsx)(a.A,{component:"span",sx:{fontSize:"1.6rem",mr:1},children:ir.emoji}),"Reactions"]}),ir.message&&ir.emoji&&(null===(e=ir.message.reactions)||void 0===e?void 0:e.some((e=>e.emoji===ir.emoji&&e.userId===(null===s||void 0===s?void 0:s.uid))))&&(0,me.jsx)(y.A,{variant:"outlined",color:"error",size:"small",onClick:()=>{var e;return(async(e,o)=>{if(null!==s&&void 0!==s&&s.uid&&r)try{const i=(0,se.H9)(ie.db,"rooms",r,"messages",e),t=await(0,se.x7)(i);if(!t.exists())return $e("Message not found"),oo("error"),void Ke(!0);const a=t.data(),l=(a.reactions||[]).filter((e=>!(e.userId===s.uid&&e.emoji===o)));await(0,se.mZ)(i,{reactions:l}),"chat"===a.type?ze((o=>o.map((o=>o.id===e?(0,n.A)((0,n.A)({},o),{},{reactions:l}):o)))):"announcement"===a.type&&Ue((o=>o.map((o=>o.id===e?(0,n.A)((0,n.A)({},o),{},{reactions:l}):o)))),fr()}catch(i){console.error("Error removing reaction:",i),$e("Failed to remove reaction"),oo("error"),Ke(!0)}})((null===(e=ir.message)||void 0===e?void 0:e.id)||"",ir.emoji||"")},children:"Remove"})]}),(0,me.jsx)(A.A,{sx:{py:0},children:ir.message&&ir.emoji&&(null===(o=ir.message.reactions)||void 0===o?void 0:o.filter((e=>e.emoji===ir.emoji)).map(((e,o)=>(0,me.jsx)(j.Ay,{sx:{py:.5,px:1,borderRadius:1,my:.3,bgcolor:e.userId===(null===s||void 0===s?void 0:s.uid)?"rgba(25, 118, 210, 0.15)":"transparent"},children:(0,me.jsxs)(a.A,{sx:{display:"flex",alignItems:"center",width:"100%",justifyContent:"space-between"},children:[(0,me.jsxs)(u.A,{children:[e.username||"User",e.userId===(null===s||void 0===s?void 0:s.uid)&&(0,me.jsx)(u.A,{component:"span",color:"text.secondary",sx:{ml:.5,fontSize:"0.8rem"},children:"(you)"})]}),(0,me.jsx)(u.A,{fontSize:"1.2rem",children:e.emoji})]})},"".concat(e.userId,"-").concat(o)))))})]})}),(0,me.jsxs)(R.A,{open:Fo,onClose:()=>Wo(!1),maxWidth:"sm",fullWidth:!0,children:[(0,me.jsx)(I.A,{children:"Join Requests"}),(0,me.jsx)(E.A,{children:0===qo.length?(0,me.jsx)(u.A,{variant:"body2",color:"text.secondary",sx:{textAlign:"center",py:2},children:"No pending join requests"}):(0,me.jsx)(A.A,{children:qo.map((e=>(0,me.jsxs)(j.Ay,{secondaryAction:(0,me.jsxs)(a.A,{children:[(0,me.jsx)(y.A,{variant:"outlined",color:"primary",size:"small",onClick:()=>(async e=>{if(Ae&&fe)try{const o=(0,se.H9)(ie.db,"rooms",r),i=(Ae.pendingRequests||[]).filter((o=>o!==e)),t=[...Ae.members,e];await(0,se.mZ)(o,{pendingRequests:i,members:t}),je((0,n.A)((0,n.A)({},Ae),{},{pendingRequests:i,members:t})),Bo((o=>o.filter((o=>o.id!==e))));const a=(0,se.rJ)(ie.db,"notifications");await(0,se.gS)(a,{type:"room_join_approved",senderId:null===s||void 0===s?void 0:s.uid,senderName:no.name||no.username||(null===s||void 0===s?void 0:s.displayName)||"Room owner",senderAvatar:no.profilePic||(null===s||void 0===s?void 0:s.photoURL)||"",recipientId:e,content:'Your request to join "'.concat(Ae.name,'" has been approved'),roomId:r,roomName:Ae.name,isRead:!1,createdAt:(0,se.O5)()}),$e("Join request approved"),oo("success"),Ke(!0)}catch(o){console.error("Error approving join request:",o),$e("Failed to approve join request"),oo("error"),Ke(!0)}})(e.id),sx:{mr:1},children:"Approve"}),(0,me.jsx)(y.A,{variant:"outlined",color:"error",size:"small",onClick:()=>(async e=>{if(Ae&&fe)try{const o=(0,se.H9)(ie.db,"rooms",r),i=(Ae.pendingRequests||[]).filter((o=>o!==e));await(0,se.mZ)(o,{pendingRequests:i}),je((0,n.A)((0,n.A)({},Ae),{},{pendingRequests:i})),Bo((o=>o.filter((o=>o.id!==e))));const t=(0,se.rJ)(ie.db,"notifications");await(0,se.gS)(t,{type:"room_join_rejected",senderId:null===s||void 0===s?void 0:s.uid,senderName:no.name||no.username||(null===s||void 0===s?void 0:s.displayName)||"Room owner",senderAvatar:no.profilePic||(null===s||void 0===s?void 0:s.photoURL)||"",recipientId:e,content:'Your request to join "'.concat(Ae.name,'" has been declined'),roomId:r,roomName:Ae.name,isRead:!1,createdAt:(0,se.O5)()}),$e("Join request declined"),oo("info"),Ke(!0)}catch(o){console.error("Error rejecting join request:",o),$e("Failed to decline join request"),oo("error"),Ke(!0)}})(e.id),children:"Decline"})]}),children:[(0,me.jsx)(g.A,{children:(0,me.jsx)(v.A,{alt:e.username,src:e.profilePic})}),(0,me.jsx)(z.A,{primary:e.username,secondary:"Wants to join this room"})]},e.id)))})}),(0,me.jsx)(N.A,{children:(0,me.jsx)(y.A,{onClick:()=>Wo(!1),children:"Close"})})]}),(0,me.jsxs)(R.A,{open:Ho,onClose:()=>Do(!1),maxWidth:"sm",fullWidth:!0,children:[(0,me.jsx)(I.A,{children:"Room Members"}),(0,me.jsx)(E.A,{children:0===To.length?(0,me.jsx)(u.A,{variant:"body2",color:"text.secondary",sx:{textAlign:"center",py:2},children:"No members found"}):(0,me.jsx)(A.A,{children:To.map((e=>(0,me.jsxs)(j.Ay,{secondaryAction:e.id!==(null===s||void 0===s?void 0:s.uid)&&(0,me.jsx)(m.A,{edge:"end",onClick:o=>((e,o)=>{e.stopPropagation(),Lo(e.currentTarget),Jo(o)})(o,e),children:(0,me.jsx)(H.A,{})}),sx:{cursor:"pointer",opacity:Ko.includes(e.id)?.5:1,"&:hover":{backgroundColor:"action.hover"}},onClick:()=>(e=>{ue("/profile/".concat(e.id))})(e),children:[(0,me.jsx)(g.A,{children:(0,me.jsxs)(a.A,{sx:{position:"relative"},children:[(0,me.jsx)(v.A,{alt:e.username,src:e.profilePic}),(0,me.jsx)(a.A,{sx:{position:"absolute",bottom:4,right:4,zIndex:1},children:(0,me.jsx)(W.A,{isOnline:pe(e.id),size:"small"})})]})}),(0,me.jsx)(z.A,{primary:(0,me.jsxs)(a.A,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.name||e.username,Ko.includes(e.id)&&(0,me.jsx)(f.A,{label:"Blocked",size:"small",color:"error",variant:"outlined",sx:{height:20,fontSize:"0.7rem"}})]}),secondary:"@".concat(e.username)})]},e.id)))})}),(0,me.jsx)(N.A,{children:(0,me.jsx)(y.A,{onClick:()=>Do(!1),children:"Close"})})]}),(0,me.jsxs)(w.A,{anchorEl:Mo,open:Boolean(Mo),onClose:br,children:[fe&&Zo&&Zo.id!==(null===s||void 0===s?void 0:s.uid)&&(0,me.jsxs)(k.A,{onClick:async()=>{if(Zo&&Ae&&fe)try{const e=(0,se.H9)(ie.db,"rooms",r),o=Ae.members.filter((e=>e!==Zo.id));await(0,se.mZ)(e,{members:o}),je((0,n.A)((0,n.A)({},Ae),{},{members:o})),_o((e=>e.filter((e=>e.id!==Zo.id))));const i=(0,se.rJ)(ie.db,"notifications");await(0,se.gS)(i,{type:"room_removed",senderId:null===s||void 0===s?void 0:s.uid,senderName:no.name||no.username||(null===s||void 0===s?void 0:s.displayName)||"Room owner",senderAvatar:no.profilePic||(null===s||void 0===s?void 0:s.photoURL)||"",recipientId:Zo.id,content:'You have been removed from "'.concat(Ae.name,'"'),roomId:r,roomName:Ae.name,isRead:!1,createdAt:(0,se.O5)()}),$e("Member removed from room"),oo("success"),Ke(!0),br()}catch(e){console.error("Error removing member:",e),$e("Failed to remove member"),oo("error"),Ke(!0)}},sx:{color:"error.main"},children:[(0,me.jsx)(C.A,{children:(0,me.jsx)(V.A,{fontSize:"small",color:"error"})}),"Remove from Room"]}),Zo&&Zo.id!==(null===s||void 0===s?void 0:s.uid)&&(0,me.jsxs)(k.A,{onClick:()=>{Zo&&($e("Reported ".concat(Zo.username)),oo("info"),Ke(!0),br())},sx:{color:"warning.main"},children:[(0,me.jsx)(C.A,{children:(0,me.jsx)(Q.A,{fontSize:"small",color:"warning"})}),"Report User"]})]}),(0,me.jsxs)(R.A,{open:Go,onClose:()=>Yo(!1),maxWidth:"sm",fullWidth:!0,children:[(0,me.jsx)(I.A,{children:(0,me.jsxs)(a.A,{sx:{display:"flex",alignItems:"center",gap:2},children:[(0,me.jsx)(v.A,{src:null===Vo||void 0===Vo?void 0:Vo.profilePic,alt:null===Vo||void 0===Vo?void 0:Vo.username,sx:{width:64,height:64}}),(0,me.jsxs)(a.A,{children:[(0,me.jsx)(u.A,{variant:"h6",children:(null===Vo||void 0===Vo?void 0:Vo.name)||(null===Vo||void 0===Vo?void 0:Vo.username)}),(0,me.jsxs)(u.A,{variant:"subtitle2",color:"text.secondary",children:["@",null===Vo||void 0===Vo?void 0:Vo.username]})]})]})}),(0,me.jsx)(E.A,{children:(0,me.jsx)(a.A,{sx:{mt:2},children:Vo&&Ko.includes(Vo.id)?(0,me.jsx)(y.A,{variant:"outlined",color:"primary",fullWidth:!0,onClick:async()=>{if(s&&Vo)try{const e=(0,se.H9)(ie.db,"users",s.uid),o=Ko.filter((e=>e!==Vo.id));await(0,se.mZ)(e,{blockedUsers:o}),Xo(o),$e("Unblocked ".concat(Vo.username)),oo("success"),Ke(!0),Yo(!1)}catch(e){console.error("Error unblocking user:",e),$e("Failed to unblock user"),oo("error"),Ke(!0)}},startIcon:(0,me.jsx)(J.A,{}),children:"Unblock User"}):(0,me.jsx)(y.A,{variant:"outlined",color:"error",fullWidth:!0,onClick:async()=>{if(s&&Vo)try{const e=(0,se.H9)(ie.db,"users",s.uid),o=[...Ko,Vo.id];await(0,se.mZ)(e,{blockedUsers:o}),Xo(o),$e("Blocked ".concat(Vo.username)),oo("success"),Ke(!0),Yo(!1),null!==Ae&&void 0!==Ae&&Ae.members.includes(Vo.id)&&(rr(Vo),er(!0))}catch(e){console.error("Error blocking user:",e),$e("Failed to block user"),oo("error"),Ke(!0)}},startIcon:(0,me.jsx)(oe.A,{}),children:"Block User"})})}),(0,me.jsx)(N.A,{children:(0,me.jsx)(y.A,{onClick:()=>Yo(!1),children:"Close"})})]}),(0,me.jsx)(O.A,{open:$o,autoHideDuration:6e3,onClose:()=>er(!1),anchorOrigin:{vertical:"top",horizontal:"center"},children:(0,me.jsx)(F.A,{onClose:()=>er(!1),severity:"warning",sx:{width:"100%"},children:or&&(0,me.jsxs)(me.Fragment,{children:["You have blocked ",or.username,". You can unblock them from their profile."]})})})]})}}}]);