"use strict";(self.webpackChunkside_eye=self.webpackChunkside_eye||[]).push([[776],{2814:(e,o,r)=>{r.d(o,{x:()=>s});var t=r(9950),i=r(6220),n=r(330),a=r(1367);const s=()=>{const{currentUser:e}=(0,a.As)(),[o,r]=(0,t.useState)(new Set);(0,t.useEffect)((()=>{if(null===e||void 0===e||!e.uid)return;const o=async()=>{try{const o=(0,i.H9)(n.db,"users",e.uid);await(0,i.mZ)(o,{lastSeen:(0,i.O5)(),isOnline:!0})}catch(o){console.error("Error updating presence:",o)}};o();const t=setInterval(o,3e4),a=async()=>{try{const o=(0,i.H9)(n.db,"users",e.uid);await(0,i.mZ)(o,{isOnline:!1,lastSeen:(0,i.O5)()})}catch(o){console.error("Error setting offline status:",o)}};window.addEventListener("beforeunload",a);const s=(0,i.rJ)(n.db,"users"),l=(0,i.aQ)(s,(e=>{const o=new Set,t=new Date;e.docs.forEach((e=>{const r=e.data(),i=e.id;if(r.isOnline)o.add(i);else if(r.lastSeen){const e=r.lastSeen.toDate?r.lastSeen.toDate():new Date(r.lastSeen);(t.getTime()-e.getTime())/6e4<2&&o.add(i)}})),r(o)}));return()=>{clearInterval(t),window.removeEventListener("beforeunload",a),l(),a()}}),[null===e||void 0===e?void 0:e.uid]);return{isUserOnline:e=>o.has(e),onlineUsers:o}}},6776:(e,o,r)=>{r.r(o),r.d(o,{default:()=>oe});var t=r(9379),i=r(9950),n=r(9254),a=r(4857),s=r(6589),l=r(6080),d=r(6491),c=r(2053),u=r(5277),m=r(8060),p=r(3239),x=r(5333),g=r(1413),h=r(6639),b=r(3274),v=r(226),f=r(3174),j=r(6699),y=r(4745),A=r(8145),w=r(7591),k=r(3266),C=r(6583),S=r(33),R=r(8170),E=r(6493),I=r(9739),U=r(4862),z=r(2362),D=r(249),O=r(6050),T=r(7016),H=r(2814),M=r(2750),P=r(7443),W=r(8724),L=r(6306),F=r(4801),Z=r(760),B=r(1227),q=r(9885),G=r(3256),N=r(598),Y=r(8429),J=r(1367),X=r(6220),_=r(330),K=r(9751),Q=r(5887),V=r(4570),$=r(4414);const ee=(0,n.Ay)("input")({display:"none"}),oe=()=>{var e,o,r,n;const{conversationId:oe,userId:re}=(0,Y.g)(),{currentUser:te}=(0,J.As)(),ie=(0,Y.Zp)(),{isUserOnline:ne}=(0,H.x)(),[ae,se]=(0,i.useState)(!0),[le,de]=(0,i.useState)([]),[ce,ue]=(0,i.useState)(""),[me,pe]=(0,i.useState)(null),[xe,ge]=(0,i.useState)(null),he=(0,i.useRef)(null),{addNotification:be}=(0,V.E)(),[ve,fe]=(0,i.useState)(!1),[je,ye]=(0,i.useState)(""),[Ae,we]=(0,i.useState)(!1),[ke,Ce]=(0,i.useState)(null),[Se,Re]=(0,i.useState)(!1),Ee=(0,i.useRef)(null),[Ie,Ue]=(0,i.useState)(null),[ze,De]=(0,i.useState)(!1),[Oe,Te]=(0,i.useState)(null),[He,Me]=(0,i.useState)(null),[Pe,We]=(0,i.useState)({anchorEl:null,message:null}),[Le,Fe]=(0,i.useState)({anchorEl:null,message:null,emoji:null}),[Ze,Be]=(0,i.useState)("recent"),qe=[{emoji:"\ud83d\udc4d",icon:(0,$.jsx)(M.A,{}),label:"Like"},{emoji:"\u2764\ufe0f",icon:(0,$.jsx)(P.A,{}),label:"Love"},{emoji:"\ud83d\ude00",icon:(0,$.jsx)(W.A,{}),label:"Happy"},{emoji:"\ud83d\ude14",icon:(0,$.jsx)(L.A,{}),label:"Sad"},{emoji:"\ud83d\udc40",icon:null,label:"Eyes"},{emoji:"\ud83e\udd2c",icon:null,label:"Angry"},{emoji:"\ud83e\udd14",icon:null,label:"Thinking"},{emoji:"\ud83e\udd37\u200d\u2642\ufe0f",icon:null,label:"Shrug"},{emoji:"\ud83e\udd37\u200d\u2640\ufe0f",icon:null,label:"Shrug"},{emoji:"\ud83e\udd37",icon:null,label:"Shrug"},{emoji:"\ud83e\udd37\u200d\u2642\ufe0f",icon:null,label:"Shrug"},{emoji:"\ud83e\udd37\u200d\u2640\ufe0f",icon:null,label:"Shrug"},{emoji:"\ud83e\udd37",icon:null,label:"Shrug"},{emoji:"\ud83e\udd22",icon:null,label:"Disgusted"},{emoji:"\ud83e\udd2e",icon:null,label:"Vomit"},{emoji:"\ud83e\udd27",icon:null,label:"Sick"},{emoji:"\ud83e\udd12",icon:null,label:"Sick"},{emoji:"\ud83e\udd15",icon:null,label:"Sick"},{emoji:"\ud83e\udd16",icon:null,label:"Robot"}],Ge=[{id:"recent",name:"Recent",icon:"\ud83d\udd52",emojis:qe.map((e=>e.emoji)).slice(0,8)},{id:"smileys",name:"Smileys",icon:"\ud83d\ude00",emojis:["\ud83d\ude00","\ud83d\ude03","\ud83d\ude04","\ud83d\ude01","\ud83d\ude06","\ud83d\ude05","\ud83e\udd23","\ud83d\ude02","\ud83d\ude42","\ud83d\ude43","\ud83d\ude09","\ud83d\ude0a","\ud83d\ude07","\ud83d\ude0d","\ud83e\udd70","\ud83d\ude18","\ud83d\ude17","\ud83d\ude19","\ud83d\ude1a","\ud83d\ude0b","\ud83d\ude1b","\ud83d\ude1c","\ud83d\ude1d","\ud83e\udd11","\ud83e\udd17","\ud83e\udd2d","\ud83e\udd2b","\ud83e\udd14","\ud83e\udd10","\ud83e\udd28","\ud83d\ude10","\ud83d\ude11","\ud83d\ude36","\ud83d\ude0f","\ud83d\ude12","\ud83d\ude44","\ud83d\ude2c","\ud83e\udd25","\ud83d\ude0c","\ud83d\ude14","\ud83d\ude2a","\ud83e\udd24","\ud83d\ude34","\ud83d\ude37","\ud83e\udd12","\ud83e\udd15","\ud83e\udd22","\ud83e\udd2e","\ud83e\udd27","\ud83e\udd75","\ud83e\udd76","\ud83e\udd74","\ud83d\ude35","\ud83e\udd2f","\ud83e\udd20","\ud83e\udd73","\ud83d\ude0e","\ud83e\udd13","\ud83e\uddd0","\ud83d\ude15","\ud83d\ude1f","\ud83d\ude41","\u2639\ufe0f","\ud83d\ude2e","\ud83d\ude2f","\ud83d\ude32","\ud83d\ude33","\ud83e\udd7a","\ud83d\ude26","\ud83d\ude27","\ud83d\ude28","\ud83d\ude30","\ud83d\ude25","\ud83d\ude22","\ud83d\ude2d","\ud83d\ude31","\ud83d\ude16","\ud83d\ude23","\ud83d\ude1e","\ud83d\ude13","\ud83d\ude29","\ud83d\ude2b","\ud83e\udd71","\ud83d\ude24","\ud83d\ude21","\ud83d\ude20","\ud83e\udd2c"]},{id:"gestures",name:"Gestures",icon:"\ud83d\udc4d",emojis:["\ud83d\udc4d","\ud83d\udc4e","\ud83d\udc4c","\u270c\ufe0f","\ud83e\udd1e","\ud83e\udd1f","\ud83e\udd18","\ud83d\udc4a","\ud83d\udc4b","\ud83d\ude4c","\ud83d\udc50","\ud83e\udd32","\ud83d\ude4f","\u270b","\ud83e\udd1a","\ud83d\udc46","\ud83d\udc47","\ud83d\udc48","\ud83d\udc49","\ud83d\udcaa","\ud83e\uddbe","\ud83d\udc4f","\ud83d\ude4f","\ud83e\udd1d","\ud83e\udd1c","\ud83e\udd1b","\u270d\ufe0f","\ud83d\udc4b","\ud83d\udc50","\ud83e\udd32","\ud83e\udd1d","\ud83d\ude4f","\ud83d\udc85","\ud83e\udd33"]},{id:"love",name:"Love",icon:"\u2764\ufe0f",emojis:["\u2764\ufe0f","\ud83e\udde1","\ud83d\udc9b","\ud83d\udc9a","\ud83d\udc99","\ud83d\udc9c","\ud83d\udda4","\ud83e\udd0d","\ud83e\udd0e","\ud83d\udc94","\u2763\ufe0f","\ud83d\udc95","\ud83d\udc9e","\ud83d\udc93","\ud83d\udc97","\ud83d\udc96","\ud83d\udc98","\ud83d\udc9d","\ud83d\udc9f","\u2665\ufe0f","\ud83d\udc8c","\ud83d\udc8b","\ud83d\udc68\u200d\u2764\ufe0f\u200d\ud83d\udc8b\u200d\ud83d\udc68","\ud83d\udc69\u200d\u2764\ufe0f\u200d\ud83d\udc8b\u200d\ud83d\udc69","\ud83d\udc69\u200d\u2764\ufe0f\u200d\ud83d\udc8b\u200d\ud83d\udc68"]},{id:"animals",name:"Animals",icon:"\ud83d\udc31",emojis:["\ud83d\udc36","\ud83d\udc31","\ud83d\udc2d","\ud83d\udc39","\ud83d\udc30","\ud83e\udd8a","\ud83d\udc3b","\ud83d\udc3c","\ud83d\udc28","\ud83d\udc2f","\ud83e\udd81","\ud83d\udc2e","\ud83d\udc37","\ud83d\udc38","\ud83d\udc35","\ud83d\ude48","\ud83d\ude49","\ud83d\ude4a","\ud83d\udc14","\ud83d\udc27","\ud83d\udc26","\ud83d\udc24","\ud83e\udd86","\ud83e\udd85","\ud83e\udd89","\ud83e\udd87","\ud83d\udc3a","\ud83d\udc17","\ud83d\udc34","\ud83e\udd84","\ud83d\udc1d","\ud83d\udc1b","\ud83e\udd8b","\ud83d\udc0c","\ud83d\udc1e","\ud83d\udc1c","\ud83e\udd9f","\ud83e\udd97","\ud83d\udd77","\ud83d\udd78","\ud83e\udd82","\ud83d\udc22","\ud83d\udc0d","\ud83e\udd8e","\ud83e\udd96","\ud83e\udd95","\ud83d\udc19","\ud83e\udd91","\ud83e\udd90","\ud83e\udd9e","\ud83e\udd80","\ud83d\udc21","\ud83d\udc20","\ud83d\udc1f","\ud83d\udc2c","\ud83d\udc33","\ud83d\udc0b","\ud83e\udd88","\ud83d\udc0a","\ud83d\udc05","\ud83d\udc06","\ud83e\udd93","\ud83e\udd8d","\ud83e\udda7","\ud83d\udc18","\ud83e\udd9b","\ud83e\udd8f","\ud83d\udc2a","\ud83d\udc2b","\ud83e\udd92","\ud83e\udd98","\ud83d\udc03","\ud83d\udc02","\ud83d\udc04","\ud83d\udc0e","\ud83d\udc16","\ud83d\udc0f","\ud83d\udc11","\ud83e\udd99","\ud83d\udc10","\ud83e\udd8c","\ud83d\udc15","\ud83d\udc29","\ud83e\uddae","\ud83d\udc15\u200d\ud83e\uddba","\ud83d\udc08","\ud83e\udd83","\ud83e\udd9a","\ud83e\udd9c","\ud83e\udda2","\ud83e\udda9","\ud83d\udd4a","\ud83d\udc07","\ud83e\udd9d","\ud83e\udda8","\ud83e\udda1","\ud83e\udda6","\ud83e\udda5","\ud83d\udc01","\ud83d\udc00","\ud83d\udc3f","\ud83e\udd94"]},{id:"food",name:"Food",icon:"\ud83c\udf54",emojis:["\ud83c\udf4f","\ud83c\udf4e","\ud83c\udf50","\ud83c\udf4a","\ud83c\udf4b","\ud83c\udf4c","\ud83c\udf49","\ud83c\udf47","\ud83c\udf53","\ud83c\udf48","\ud83c\udf52","\ud83c\udf51","\ud83e\udd6d","\ud83c\udf4d","\ud83e\udd65","\ud83e\udd5d","\ud83c\udf45","\ud83c\udf46","\ud83e\udd51","\ud83e\udd66","\ud83e\udd6c","\ud83e\udd52","\ud83c\udf36","\ud83c\udf3d","\ud83e\udd55","\ud83e\udd54","\ud83c\udf60","\ud83e\udd50","\ud83e\udd6f","\ud83c\udf5e","\ud83e\udd56","\ud83e\udd68","\ud83e\uddc0","\ud83e\udd5a","\ud83c\udf73","\ud83e\udd5e","\ud83e\uddc7","\ud83e\udd53","\ud83e\udd69","\ud83c\udf57","\ud83c\udf56","\ud83e\uddb4","\ud83c\udf2d","\ud83c\udf54","\ud83c\udf5f","\ud83c\udf55","\ud83e\udd6a","\ud83e\udd59","\ud83e\uddc6","\ud83c\udf2e","\ud83c\udf2f","\ud83e\udd57","\ud83e\udd58","\ud83e\udd6b","\ud83c\udf5d","\ud83c\udf5c","\ud83c\udf72","\ud83c\udf5b","\ud83c\udf63","\ud83c\udf71","\ud83e\udd5f","\ud83e\uddaa","\ud83c\udf64","\ud83c\udf59","\ud83c\udf5a","\ud83c\udf58","\ud83c\udf65","\ud83e\udd60","\ud83e\udd6e","\ud83c\udf62","\ud83c\udf61","\ud83c\udf67","\ud83c\udf68","\ud83c\udf66","\ud83e\udd67","\ud83e\uddc1","\ud83c\udf70","\ud83c\udf82","\ud83c\udf6e","\ud83c\udf6d","\ud83c\udf6c","\ud83c\udf6b","\ud83c\udf7f","\ud83c\udf69","\ud83c\udf6a","\ud83c\udf30","\ud83e\udd5c","\ud83c\udf6f","\ud83e\udd5b","\ud83c\udf7c","\u2615\ufe0f","\ud83c\udf75","\ud83e\uddc3","\ud83e\udd64","\ud83c\udf76","\ud83c\udf7a","\ud83c\udf7b","\ud83e\udd42","\ud83c\udf77","\ud83e\udd43","\ud83c\udf78","\ud83c\udf79","\ud83e\uddc9","\ud83c\udf7e","\ud83e\uddca"]}],[Ne,Ye]=(0,i.useState)(!1),Je=["\ud83d\ude00","\ud83d\ude01","\ud83d\ude02","\ud83e\udd23","\ud83d\ude03","\ud83d\ude04","\ud83d\ude05","\ud83d\ude06","\ud83d\ude09","\ud83d\ude0a","\ud83d\ude0b","\ud83d\ude0e","\ud83d\ude0d","\ud83e\udd70","\ud83d\ude18","\ud83d\ude17","\ud83d\ude19","\ud83d\ude1a","\ud83d\ude42","\ud83e\udd17","\ud83e\udd14","\ud83e\udd28","\ud83d\ude10","\ud83d\ude11","\ud83d\ude36","\ud83d\ude44","\ud83d\ude0f","\ud83d\ude23","\ud83d\ude25","\ud83d\ude2e","\ud83d\udc4d","\ud83d\udc4e","\ud83d\udc4c","\u270c\ufe0f","\ud83e\udd1e","\ud83e\udd1f","\ud83e\udd18","\ud83d\udc4a","\ud83d\udc4b","\ud83d\ude4c","\u2764\ufe0f","\ud83d\udc94","\ud83d\udc96","\ud83d\udc99","\ud83d\ude22","\ud83d\ude2d","\ud83d\ude24","\ud83d\ude20","\ud83d\ude21","\ud83e\udd2c"],Xe=(0,a.A)(),_e=(0,s.A)(Xe.breakpoints.up("md"));(0,i.useEffect)((()=>{if(null===te||void 0===te||!te.uid)return;const e=oe||re;if(!e)return void ie("/messages");let o=null;return(async()=>{if(await(async()=>{if(!re||oe)return null;try{var e;const o=(0,X.rJ)(_.db,"conversations"),r=(0,X.P)(o,(0,X._M)("participants","array-contains",te.uid)),t=await(0,X.GG)(r);let i=null;if(t.docs.forEach((e=>{e.data().participants.includes(re)&&(i=e.id)})),i)return ie("/chat/conversation/".concat(i),{replace:!0}),i;const n=(0,X.H9)(_.db,"users",re),a=await(0,X.x7)(n);if(!a.exists())return Q.oR.error("User not found"),ie("/messages"),null;const s=(null===(e=a.data().following)||void 0===e?void 0:e.includes(te.uid))||!1;console.log("[Chat] Creating conversation: recipient follows current user? ".concat(s));const l=(0,X.H9)((0,X.rJ)(_.db,"conversations"));return await(0,X.BN)(l,{participants:[te.uid,re],createdAt:(0,X.O5)(),lastUpdated:(0,X.O5)(),unreadCount:{[te.uid]:0,[re]:0},status:s?"accepted":"pending"}),console.log("[Chat] Created new conversation with status: ".concat(s?"accepted":"pending")),ie("/chat/conversation/".concat(l.id),{replace:!0}),l.id}catch(o){return console.error("[Chat] Error creating conversation:",o),Q.oR.error("Failed to start conversation"),null}})())return;const r=e;try{const e=(0,X.H9)(_.db,"conversations",r),i=await(0,X.x7)(e);if(!i.exists())return Q.oR.error("Conversation not found"),void ie("/messages");const n=(0,t.A)({},i.data());ge((0,t.A)((0,t.A)({},n),{},{id:i.id}));const a=n.status||"accepted";fe("pending"===a);const s=n.participants.find((e=>e!==te.uid));if(!s)return Q.oR.error("Invalid conversation"),void ie("/messages");const l=await(async e=>{try{const o=(0,X.H9)(_.db,"users",e),r=await(0,X.x7)(o);if(r.exists()){const o=r.data(),t=o.profilePic||o.photoURL||o.avatarUrl||void 0;return console.log("User profile debug:",{uid:e,userData:o,profilePic:t}),{id:e,username:o.username||"Unknown User",name:o.name,profilePic:t,followers:o.followers||[]}}return{id:e,username:"Unknown User",followers:[]}}catch(o){return console.error("Error fetching user profile:",o),{id:e,username:"Unknown User",followers:[]}}})(s);pe(l),"accepted"===a&&await(0,X.mZ)(e,{["unreadCount.".concat(te.uid)]:0});const d=(0,X.rJ)(_.db,"conversations",r,"messages"),c=(0,X.P)(d,(0,X.My)("timestamp","asc"));o=(0,X.aQ)(c,(e=>{const o=[];if(e.docs.forEach((e=>{o.push((0,t.A)({id:e.id},e.data()))})),de(o),se(!1),"accepted"===a){const e=o.filter((e=>!e.read&&e.sender!==te.uid));if(e.length>0){e.forEach((async e=>{const o=(0,X.H9)(_.db,"conversations",r,"messages",e.id);await(0,X.mZ)(o,{read:!0})}));const o=(0,X.H9)(_.db,"conversations",r);(0,X.mZ)(o,{["unreadCount.".concat(te.uid)]:0})}}Ke()}))}catch(i){console.error("Error fetching conversation:",i),Q.oR.error("Failed to load conversation")}})(),()=>{o&&o()}}),[null===te||void 0===te?void 0:te.uid,oe,re,ie]);const Ke=()=>{setTimeout((()=>{var e;null===(e=he.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})}),100)},Qe=async()=>{if(!ce.trim()||null===te||void 0===te||!te.uid||!xe)return;if(ve&&xe.participants[0]!==te.uid)return void Q.oR.error("You need to accept this message request before you can reply");const e=oe||re;if(e)try{var o;const t=(0,X.rJ)(_.db,"conversations",e,"messages"),i=xe.participants.find((e=>e!==te.uid));if(!i)return void Q.oR.error("Cannot find chat partner");await(0,X.gS)(t,{text:ce,sender:te.uid,timestamp:(0,X.O5)(),read:!1,reactions:[]});const n=(0,X.H9)(_.db,"conversations",e);if(await(0,X.mZ)(n,{lastMessage:{text:ce,sender:te.uid,timestamp:(0,X.O5)()},lastUpdated:(0,X.O5)(),["unreadCount.".concat(i)]:1+((null===(o=xe.lastMessage)||void 0===o?void 0:o.sender)===te.uid?1:0)}),me&&te)try{const o=(0,X.H9)(_.db,"users",te.uid),r=await(0,X.x7)(o),t=r.exists()?r.data():null,n=(null===t||void 0===t?void 0:t.name)||(null===t||void 0===t?void 0:t.username)||te.displayName||"Someone",a=(null===t||void 0===t?void 0:t.profilePic)||te.photoURL;await be({type:"message",senderId:te.uid,senderName:n,senderAvatar:a,recipientId:i,content:"New message: ".concat(ce.slice(0,50)).concat(ce.length>50?"...":""),postId:e,roomId:e}),console.log("[Chat] Notification sent for new message to:",i)}catch(r){console.error("[Chat] Error creating message notification:",r)}ue(""),Ke()}catch(t){console.error("[Chat] Error sending message:",t),Q.oR.error("Failed to send message")}},Ve=e=>{if(!e)return"";return(e.toDate?e.toDate():new Date(e)).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})},$e=e=>{if(!e)return"";return(e.toDate?e.toDate():new Date(e)).toLocaleDateString([],{weekday:"long",month:"long",day:"numeric"})},eo=async(e,o)=>{if(null===te||void 0===te||!te.uid||!xe)return;if(ve&&xe.participants[0]!==te.uid)return void Q.oR.error("You need to accept this message request before you can reply");const r=oe||re;if(r)try{var t;const n=(0,X.rJ)(_.db,"conversations",r,"messages"),a=xe.participants.find((e=>e!==te.uid));if(!a)return void Q.oR.error("Cannot find chat partner");const s="image"===o?"Sent an image":"Sent a video";await(0,X.gS)(n,{text:s,sender:te.uid,timestamp:(0,X.O5)(),read:!1,mediaUrl:e,mediaType:o,reactions:[]});const l=(0,X.H9)(_.db,"conversations",r);if(await(0,X.mZ)(l,{lastMessage:{text:s,sender:te.uid,timestamp:(0,X.O5)()},lastUpdated:(0,X.O5)(),["unreadCount.".concat(a)]:1+((null===(t=xe.lastMessage)||void 0===t?void 0:t.sender)===te.uid?1:0)}),me&&te)try{const e=(0,X.H9)(_.db,"users",te.uid),t=await(0,X.x7)(e),i=t.exists()?t.data():null,n=(null===i||void 0===i?void 0:i.name)||(null===i||void 0===i?void 0:i.username)||te.displayName||"Someone",s=(null===i||void 0===i?void 0:i.profilePic)||te.photoURL;await be({type:"message",senderId:te.uid,senderName:n,senderAvatar:s,recipientId:a,content:"image"===o?"Sent you an image":"Sent you a video",postId:r,roomId:r})}catch(i){console.error("[Chat] Error creating media message notification:",i)}Ke()}catch(n){console.error("[Chat] Error sending media message:",n),Q.oR.error("Failed to send media")}},oo=async()=>{if(xe&&te)try{se(!0);const e=(0,X.H9)(_.db,"conversations",xe.id);await(0,X.mZ)(e,{status:"accepted"}),fe(!1),ge((0,t.A)((0,t.A)({},xe),{},{status:"accepted"})),ye("Message request accepted"),we(!0)}catch(e){console.error("Error accepting message request:",e),Q.oR.error("Failed to accept message request")}finally{se(!1)}},ro=async()=>{if(xe&&te)try{se(!0);const e=(0,X.wP)(_.db),o=(0,X.rJ)(_.db,"conversations",xe.id,"messages");(await(0,X.GG)(o)).docs.forEach((o=>{e.delete(o.ref)}));const r=(0,X.H9)(_.db,"conversations",xe.id);e.delete(r),await e.commit(),ie("/messages"),ye("Message request declined"),we(!0)}catch(e){console.error("Error declining message request:",e),Q.oR.error("Failed to decline message request")}finally{se(!1)}},to=(e,o)=>{const r=setTimeout((()=>{if(o.sender===(null===te||void 0===te?void 0:te.uid)){var r;if("clientX"in e)Me({mouseX:e.clientX-2,mouseY:e.clientY-4,message:o});else if(null!==(r=e.touches)&&void 0!==r&&r.length){const r=e.touches[0];Me({mouseX:r.clientX-2,mouseY:r.clientY-4,message:o})}Ue(o)}else"currentTarget"in e&&no(e,o)}),500);Te(r)},io=()=>{Oe&&(clearTimeout(Oe),Te(null))},no=(e,o)=>{Oe&&(clearTimeout(Oe),Te(null)),We({anchorEl:e.currentTarget,message:o}),He&&Me(null)},ao=()=>{We({anchorEl:null,message:null})},so=()=>{Fe({anchorEl:null,message:null,emoji:null})},lo=async e=>{if(!Pe.message||null===te||void 0===te||!te.uid||!xe)return;const o=oe||re;if(o)try{const r=Pe.message.id,i=(0,X.H9)(_.db,"conversations",o,"messages",r),n=Pe.message.reactions||[],a=n.findIndex((o=>o.userId===te.uid&&o.emoji===e));if(-1!==a){const e=[...n];e.splice(a,1),await(0,X.mZ)(i,{reactions:e}),de((o=>o.map((o=>o.id===r?(0,t.A)((0,t.A)({},o),{},{reactions:e}):o))))}else{const o={emoji:e,userId:te.uid,username:te.displayName||""},a=[...n,o];await(0,X.mZ)(i,{reactions:a}),de((e=>e.map((e=>e.id===r?(0,t.A)((0,t.A)({},e),{},{reactions:a}):e))))}ao()}catch(r){console.error("[Chat] Error adding reaction:",r),Q.oR.error("Failed to add reaction"),ao()}},co=e=>{const o=/(https?:\/\/[^\s]+\/side-room\/[^\s]+)/g;return e.split(o).map(((e,r)=>{if(e.match(o)){const o=new URL(e).pathname.split("/"),t=o[o.length-1];return(0,$.jsx)(l.A,{component:"button",onClick:e=>{e.stopPropagation(),ie("/side-room/".concat(t))},sx:{color:"inherit",textDecoration:"underline",background:"none",border:"none",padding:0,font:"inherit",cursor:"pointer","&:hover":{opacity:.8}},children:e},r)}return(0,$.jsx)("span",{children:e},r)}))},uo=e=>{const o=e.sender===(null===te||void 0===te?void 0:te.uid);return(0,$.jsxs)(d.A,{sx:{display:"flex",flexDirection:"column",alignItems:o?"flex-end":"flex-start",mb:.5,px:1},children:[(0,$.jsxs)(d.A,{sx:{maxWidth:e.mediaUrl?"80%":"70%",backgroundColor:o?"primary.main":e=>"dark"===e.palette.mode?"rgba(255, 255, 255, 0.15)":"background.paper",color:o?"primary.contrastText":e=>"dark"===e.palette.mode?"common.white":"text.primary",borderRadius:o?"20px 20px 0 20px":"20px 20px 20px 0",p:e.mediaUrl?1:2,position:"relative",boxShadow:1,"& .timestamp":{position:"absolute",bottom:2,right:o?8:"auto",left:o?"auto":8,fontSize:"0.7rem",color:o?"rgba(255,255,255,0.7)":e=>"dark"===e.palette.mode?"rgba(255,255,255,0.7)":"text.secondary"},transition:"opacity 0.2s ease","&:hover":{opacity:.9,cursor:"pointer"},"&:active":{opacity:.7}},onMouseDown:o=>to(o,e),onMouseUp:io,onMouseLeave:io,onTouchStart:o=>to(o,e),onTouchEnd:io,onTouchCancel:io,onClick:o=>no(o,e),children:[e.mediaUrl&&"image"===e.mediaType&&(0,$.jsx)(d.A,{sx:{mb:1},children:(0,$.jsx)("img",{src:e.mediaUrl,alt:"Shared image",style:{maxWidth:"100%",maxHeight:"300px",borderRadius:"16px",display:"block"}})}),e.mediaUrl&&"video"===e.mediaType&&(0,$.jsx)(d.A,{sx:{mb:1},children:(0,$.jsx)("video",{src:e.mediaUrl,controls:!0,style:{maxWidth:"100%",maxHeight:"300px",borderRadius:"16px",display:"block"}})}),(0,$.jsx)(c.A,{variant:"body1",children:co(e.text)}),(0,$.jsx)(c.A,{variant:"caption",className:"timestamp",children:Ve(e.timestamp)})]}),e.reactions&&e.reactions.length>0&&(0,$.jsx)(d.A,{sx:{display:"flex",flexDirection:o?"row-reverse":"row",flexWrap:"wrap",gap:.5,mt:.5,maxWidth:"70%"},children:Object.entries(e.reactions.reduce(((e,o)=>(e[o.emoji]=(e[o.emoji]||0)+1,e)),{})).map((o=>{var r;let[t,i]=o;const n=null===(r=e.reactions)||void 0===r?void 0:r.some((e=>e.emoji===t&&e.userId===(null===te||void 0===te?void 0:te.uid)));return(0,$.jsx)(u.A,{label:"".concat(t," ").concat(i),size:"small",variant:"outlined",onClick:o=>((e,o,r)=>{e.stopPropagation(),Fe({anchorEl:e.currentTarget,message:o,emoji:r})})(o,e,t),sx:{borderRadius:"12px",height:"24px",fontSize:"0.75rem",cursor:"pointer",backgroundColor:e=>n?"dark"===e.palette.mode?"rgba(25, 118, 210, 0.2)":"rgba(25, 118, 210, 0.1)":"dark"===e.palette.mode?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.05)",border:e=>n?"1px solid ".concat(e.palette.primary.main):void 0,"&:hover":{backgroundColor:e=>n?"dark"===e.palette.mode?"rgba(25, 118, 210, 0.3)":"rgba(25, 118, 210, 0.2)":"dark"===e.palette.mode?"rgba(255,255,255,0.15)":"rgba(0,0,0,0.1)"}}},t)}))})]},e.id)},mo=e=>{ue((o=>o+e))};return(0,$.jsxs)(d.A,{sx:{display:"flex",flexDirection:"column",height:"100vh"},children:[(0,$.jsx)(m.A,{position:"static",color:"default",elevation:0,sx:{borderBottom:"1px solid",borderColor:"divider"},children:(0,$.jsxs)(p.A,{children:[(0,$.jsx)(x.A,{edge:"start",onClick:()=>ie("/messages"),sx:{mr:2},children:(0,$.jsx)(F.A,{})}),me?(0,$.jsxs)(d.A,{sx:{display:"flex",alignItems:"center",cursor:"pointer","&:hover":{opacity:.8},transition:"opacity 0.2s ease"},onClick:()=>ie("/profile/".concat(me.id)),children:[(0,$.jsxs)(d.A,{sx:{position:"relative",mr:2},children:[(0,$.jsx)(g.A,{src:me.profilePic||void 0,alt:me.name||me.username,sx:{width:40,height:40,bgcolor:me.profilePic?void 0:"primary.main"},children:!me.profilePic&&(null===(e=me.name||me.username)||void 0===e?void 0:e.charAt(0).toUpperCase())}),(0,$.jsx)(d.A,{sx:{position:"absolute",bottom:2,right:2,zIndex:1},children:(0,$.jsx)(T.A,{isOnline:ne(me.id),size:"small"})})]}),(0,$.jsxs)(d.A,{children:[(0,$.jsxs)(d.A,{sx:{display:"flex",alignItems:"center",gap:1},children:[(0,$.jsx)(c.A,{variant:"subtitle1",fontWeight:"medium",children:me.name||me.username}),ne(me.id)&&(0,$.jsx)(c.A,{variant:"caption",color:"success.main",sx:{fontWeight:"medium"},children:"\u2022 Online"})]}),me.name&&(0,$.jsxs)(c.A,{variant:"caption",color:"text.secondary",children:["@",me.username]})]})]}):(0,$.jsx)(h.A,{size:24,sx:{mr:2}}),(0,$.jsx)(b.A,{title:"Tip: Long-press on your messages to delete them",placement:"bottom",children:(0,$.jsxs)(c.A,{variant:"caption",color:"text.secondary",sx:{ml:"auto",mr:ve?2:0,display:{xs:"none",sm:"block"}},children:[(0,$.jsx)(Z.A,{fontSize:"inherit",sx:{fontSize:"1rem",verticalAlign:"middle",mr:.5}}),"Long-press to delete"]})}),ve&&(0,$.jsxs)(d.A,{sx:{ml:"auto",display:"flex",gap:1},children:[(0,$.jsx)(v.A,{variant:"contained",color:"success",startIcon:(0,$.jsx)(B.A,{}),onClick:oo,size:"small",children:"Accept"}),(0,$.jsx)(v.A,{variant:"outlined",color:"error",startIcon:(0,$.jsx)(q.A,{}),onClick:ro,size:"small",children:"Decline"})]})]})}),ve&&(0,$.jsx)(d.A,{sx:{bgcolor:"info.light",p:2},children:(0,$.jsx)(f.A,{severity:"info",icon:!1,children:(0,$.jsxs)(d.A,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[(0,$.jsxs)(c.A,{variant:"body2",children:["This is a message request from ",(null===me||void 0===me?void 0:me.name)||(null===me||void 0===me?void 0:me.username)||"a user",".",(null===xe||void 0===xe?void 0:xe.participants[0])!==(null===te||void 0===te?void 0:te.uid)?" You can read their message, but must accept to respond.":" Waiting for them to accept your request before they can read your message."]}),(null===xe||void 0===xe?void 0:xe.participants[0])!==(null===te||void 0===te?void 0:te.uid)&&(0,$.jsxs)(d.A,{sx:{display:"flex",gap:1,ml:2},children:[(0,$.jsx)(v.A,{variant:"contained",color:"success",size:"small",onClick:oo,children:"Accept"}),(0,$.jsx)(v.A,{variant:"outlined",color:"error",size:"small",onClick:ro,children:"Decline"})]})]})})}),Se&&(0,$.jsxs)(d.A,{sx:{width:"100%",px:2,py:1,bgcolor:"background.paper"},children:[(0,$.jsxs)(c.A,{variant:"caption",gutterBottom:!0,children:["Uploading media... ",ke?Math.round(ke):0,"%"]}),(0,$.jsx)(j.A,{variant:"determinate",value:ke||0,sx:{height:6,borderRadius:3}})]}),(0,$.jsx)(d.A,{sx:{flexGrow:1,overflowY:"auto",bgcolor:e=>"dark"===e.palette.mode?"grey.900":"grey.50",p:2,pb:2},children:ae?(0,$.jsx)(d.A,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"100%"},children:(0,$.jsx)(h.A,{})}):0===le.length?(0,$.jsx)(d.A,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"50%"},children:(0,$.jsx)(c.A,{color:"text.secondary",children:"No messages yet. Start the conversation!"})}):(0,$.jsxs)(d.A,{sx:{mb:"60px"},children:[" ",Object.entries((()=>{const e={};return le.forEach((o=>{if(!o.timestamp)return;const r=(o.timestamp.toDate?o.timestamp.toDate():new Date(o.timestamp)).toISOString().split("T")[0];e[r]||(e[r]=[]),e[r].push(o)})),e})()).map((e=>{let[o,r]=e;return(0,$.jsxs)(d.A,{sx:{mb:2},children:[(0,$.jsxs)(d.A,{sx:{display:"flex",alignItems:"center",mb:1},children:[(0,$.jsx)(y.A,{sx:{flexGrow:1,mr:2,borderColor:e=>"dark"===e.palette.mode?"rgba(255, 255, 255, 0.12)":"inherit"}}),(0,$.jsx)(c.A,{variant:"caption",sx:{color:e=>"dark"===e.palette.mode?"rgba(255,255,255,0.7)":"text.secondary"},children:$e(r[0].timestamp)}),(0,$.jsx)(y.A,{sx:{flexGrow:1,ml:2,borderColor:e=>"dark"===e.palette.mode?"rgba(255, 255, 255, 0.12)":"inherit"}})]}),r.map(uo)]},o)})),(0,$.jsx)("div",{ref:he,style:{height:"4px"}})]})}),(0,$.jsx)(d.A,{sx:{position:"fixed",bottom:0,left:0,right:0,pt:1,pb:1.5,px:1.5,backgroundColor:e=>"dark"===e.palette.mode?"background.paper":"white",borderTop:e=>"1px solid ".concat("dark"===e.palette.mode?"rgba(255,255,255,0.1)":"#ddd"),boxShadow:e=>"dark"===e.palette.mode?"0px -2px 10px rgba(0,0,0,0.3)":"0px -2px 10px rgba(0,0,0,0.1)",zIndex:9999},children:ve&&(null===xe||void 0===xe?void 0:xe.participants[0])!==(null===te||void 0===te?void 0:te.uid)?(0,$.jsx)(d.A,{sx:{display:"flex",justifyContent:"center",alignItems:"center",p:1},children:(0,$.jsx)(u.A,{label:"Accept message request to reply",color:"primary",variant:"outlined",sx:{fontSize:"0.9rem"}})}):(0,$.jsxs)($.Fragment,{children:[_e&&!Se&&(0,$.jsx)(d.A,{sx:{display:"flex",overflowX:"auto",mb:1,pb:1,"&::-webkit-scrollbar":{height:"4px"},"&::-webkit-scrollbar-track":{background:e=>"dark"===e.palette.mode?"rgba(255,255,255,0.05)":"rgba(0,0,0,0.05)"},"&::-webkit-scrollbar-thumb":{background:e=>"dark"===e.palette.mode?"rgba(255,255,255,0.2)":"rgba(0,0,0,0.2)",borderRadius:"2px"}},children:Je.map((e=>(0,$.jsx)(b.A,{title:e,placement:"top",children:(0,$.jsx)(d.A,{component:"button",onClick:()=>mo(e),sx:{border:"none",background:"none",cursor:"pointer",fontSize:"1.5rem",mx:.5,p:.5,borderRadius:"4px",minWidth:"40px",display:"flex",alignItems:"center",justifyContent:"center",transition:"all 0.2s","&:hover":{transform:"scale(1.2)",background:e=>"dark"===e.palette.mode?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.05)"}},children:e})},e)))}),(0,$.jsxs)(d.A,{sx:{display:"flex",width:"100%"},children:[(0,$.jsx)(ee,{ref:Ee,accept:"image/*,video/*",id:"file-upload-input",type:"file",onChange:async e=>{var o;const r=null===(o=e.target.files)||void 0===o?void 0:o[0];if(!r||!te||!xe)return;const t=oe||re;if(!t)return;if(r.size>10485760)return void Q.oR.error("File too large. Maximum size is 10MB.");const i=r.type.split("/")[0];if("image"===i||"video"===i){try{Re(!0),Ce(0),console.log("[Chat] Starting upload for file ".concat(r.name," to conversation ").concat(t));const e=(0,K.KR)(_.IG,"chat-media/".concat(t,"/").concat(Date.now(),"_").concat(r.name)),o=(0,K.bp)(e,r);o.on("state_changed",(e=>{const o=e.bytesTransferred/e.totalBytes*100;Ce(o),console.log("[Chat] Upload progress: ".concat(o.toFixed(2),"%"))}),(e=>{console.error("Error uploading file:",e);const o="storage/unauthorized"===e.code?"Permission denied. Cannot upload file (storage rules need to be updated).":"Upload failed: ".concat(e.message);Q.oR.error(o),Re(!1),Ce(null)}),(async()=>{console.log("[Chat] Upload completed successfully, getting download URL");try{const e=await(0,K.qk)(o.snapshot.ref);console.log("[Chat] Download URL obtained: ".concat(e)),await eo(e,i),Re(!1),Ce(null)}catch(e){console.error("Error getting download URL:",e);const o=e instanceof Error?e.message:"Unknown error occurred";Q.oR.error("Failed to process uploaded file: ".concat(o)),Re(!1),Ce(null)}}))}catch(n){console.error("Error handling file upload:",n);const e=n instanceof Error?n.message:"Unknown error occurred";Q.oR.error("Failed to upload file: ".concat(e)),Re(!1),Ce(null)}Ee.current&&(Ee.current.value="")}else Q.oR.error("Only image and video files are supported.")},disabled:Se||ve&&(null===xe||void 0===xe?void 0:xe.participants[0])!==(null===te||void 0===te?void 0:te.uid)}),(0,$.jsx)(x.A,{onClick:()=>{var e;null===(e=Ee.current)||void 0===e||e.click()},disabled:Se||ve&&(null===xe||void 0===xe?void 0:xe.participants[0])!==(null===te||void 0===te?void 0:te.uid),color:"primary",sx:{mr:1},"aria-label":"attach image or video",children:(0,$.jsx)(G.A,{})}),!_e&&(0,$.jsx)(x.A,{onClick:()=>{Ye((e=>!e))},disabled:Se||ve&&(null===xe||void 0===xe?void 0:xe.participants[0])!==(null===te||void 0===te?void 0:te.uid),color:"primary",sx:{mr:1},"aria-label":"add emoji",children:(0,$.jsx)(N.A,{})}),(0,$.jsx)(A.A,{fullWidth:!0,variant:"outlined",placeholder:"Type a message...",value:ce,onChange:e=>ue(e.target.value),onKeyPress:e=>"Enter"===e.key&&!e.shiftKey&&Qe(),disabled:Se||ve&&(null===xe||void 0===xe?void 0:xe.participants[0])!==(null===te||void 0===te?void 0:te.uid),sx:{mr:1,"& .MuiInputBase-root":{bgcolor:e=>"dark"===e.palette.mode?"rgba(255,255,255,0.05)":"white"}}}),(0,$.jsx)(v.A,{variant:"contained",color:"primary",disabled:Se||!ce.trim()&&!Se||ve&&(null===xe||void 0===xe?void 0:xe.participants[0])!==(null===te||void 0===te?void 0:te.uid),onClick:Qe,children:"Send"})]})]})}),(0,$.jsx)(w.A,{open:null!==He,onClose:()=>{Me(null)},anchorReference:"anchorPosition",anchorPosition:null!==He?{top:He.mouseY,left:He.mouseX}:void 0,children:(0,$.jsxs)(k.A,{onClick:()=>{De(!0),Me(null)},children:[(0,$.jsx)(Z.A,{fontSize:"small",sx:{mr:1}}),"Delete Message"]})}),(0,$.jsxs)(C.A,{open:ze,onClose:()=>De(!1),"aria-labelledby":"delete-dialog-title","aria-describedby":"delete-dialog-description",children:[(0,$.jsx)(S.A,{id:"delete-dialog-title",children:"Delete Message?"}),(0,$.jsx)(R.A,{children:(0,$.jsx)(E.A,{id:"delete-dialog-description",children:"Are you sure you want to delete this message? This action cannot be undone."})}),(0,$.jsxs)(I.A,{children:[(0,$.jsx)(v.A,{onClick:()=>De(!1),color:"primary",children:"Cancel"}),(0,$.jsx)(v.A,{onClick:async()=>{if(!Ie||null===te||void 0===te||!te.uid||!xe)return void De(!1);if(Ie.sender!==(null===te||void 0===te?void 0:te.uid))return Q.oR.error("You can only delete your own messages"),void De(!1);const e=oe||re;if(e)try{var o;se(!0);const r=(0,X.H9)(_.db,"conversations",e,"messages",Ie.id);if(await(0,X.kd)(r),null!==(o=xe.lastMessage)&&void 0!==o&&o.timestamp&&Ie.timestamp&&xe.lastMessage.timestamp.seconds===Ie.timestamp.seconds){const o=(0,X.rJ)(_.db,"conversations",e,"messages"),r=(0,X.P)(o,(0,X.My)("timestamp","desc"),(0,X.AB)(1)),t=await(0,X.GG)(r),i=(0,X.H9)(_.db,"conversations",e);if(t.empty)await(0,X.mZ)(i,{lastMessage:null});else{const e=t.docs[0].data();await(0,X.mZ)(i,{lastMessage:{text:e.text,sender:e.sender,timestamp:e.timestamp}})}}ye("Message deleted"),we(!0),de((e=>e.filter((e=>e.id!==Ie.id))))}catch(r){console.error("Error deleting message:",r),Q.oR.error("Failed to delete message")}finally{se(!1),De(!1),Ue(null),Me(null)}else De(!1)},color:"error",variant:"contained",children:"Delete"})]})]}),(0,$.jsx)(U.A,{open:Ae,autoHideDuration:4e3,onClose:()=>{we(!1)},message:je}),(0,$.jsx)(z.Ay,{open:Boolean(Pe.anchorEl),anchorEl:Pe.anchorEl,onClose:ao,anchorOrigin:{vertical:"top",horizontal:"center"},transformOrigin:{vertical:"bottom",horizontal:"center"},PaperProps:{sx:{width:"320px",maxWidth:"90vw",maxHeight:"350px",overflow:"hidden"}},children:(0,$.jsxs)(d.A,{sx:{display:"flex",flexDirection:"column",bgcolor:e=>"dark"===e.palette.mode?"grey.800":"background.paper",borderRadius:2},children:[(0,$.jsx)(d.A,{sx:{display:"flex",p:1,borderBottom:1,borderColor:"divider",justifyContent:"center"},children:qe.slice(0,7).map((e=>(0,$.jsx)(x.A,{onClick:()=>lo(e.emoji),sx:{mx:.5,"&:hover":{bgcolor:e=>"dark"===e.palette.mode?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.04)"}},"aria-label":e.label,children:(0,$.jsx)(c.A,{variant:"body1",sx:{fontSize:"1.4rem"},children:e.emoji})},e.emoji)))}),(0,$.jsx)(d.A,{sx:{display:"flex",overflowX:"auto",py:1,borderBottom:1,borderColor:"divider","&::-webkit-scrollbar":{height:"4px"},"&::-webkit-scrollbar-track":{background:e=>"dark"===e.palette.mode?"rgba(255,255,255,0.05)":"rgba(0,0,0,0.05)"},"&::-webkit-scrollbar-thumb":{background:e=>"dark"===e.palette.mode?"rgba(255,255,255,0.2)":"rgba(0,0,0,0.2)",borderRadius:"2px"}},children:Ge.map((e=>(0,$.jsxs)(d.A,{onClick:()=>Be(e.id),sx:{minWidth:"auto",mx:1.5,cursor:"pointer",display:"flex",flexDirection:"column",alignItems:"center",opacity:Ze===e.id?1:.6,borderBottom:Ze===e.id?2:0,borderColor:"primary.main",transition:"all 0.2s ease","&:hover":{opacity:.8}},children:[(0,$.jsx)(c.A,{sx:{fontSize:"1.4rem"},children:e.icon}),(0,$.jsx)(c.A,{variant:"caption",sx:{fontSize:"0.7rem"},children:e.name})]},e.id)))}),(0,$.jsx)(d.A,{sx:{height:"200px",overflowY:"auto",p:1,display:"flex",flexWrap:"wrap",justifyContent:"flex-start","&::-webkit-scrollbar":{width:"4px"},"&::-webkit-scrollbar-track":{background:e=>"dark"===e.palette.mode?"rgba(255,255,255,0.05)":"rgba(0,0,0,0.05)"},"&::-webkit-scrollbar-thumb":{background:e=>"dark"===e.palette.mode?"rgba(255,255,255,0.2)":"rgba(0,0,0,0.2)",borderRadius:"2px"}},children:null===(o=Ge.find((e=>e.id===Ze)))||void 0===o?void 0:o.emojis.map((e=>(0,$.jsx)(d.A,{component:"button",onClick:()=>lo(e),sx:{border:"none",background:"none",cursor:"pointer",fontSize:"1.6rem",width:"40px",height:"40px",display:"flex",alignItems:"center",justifyContent:"center",transition:"transform 0.2s",borderRadius:"4px","&:hover":{transform:"scale(1.2)",background:e=>"dark"===e.palette.mode?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.05)"}},children:e},e)))})]})}),!_e&&(0,$.jsx)(z.Ay,{open:Ne,onClose:()=>Ye(!1),anchorReference:"anchorPosition",anchorPosition:{top:window.innerHeight-300,left:window.innerWidth/2},transformOrigin:{vertical:"bottom",horizontal:"center"},children:(0,$.jsx)(d.A,{sx:{p:1,width:"300px",maxWidth:"90vw",height:"200px",overflow:"auto",display:"flex",flexWrap:"wrap",justifyContent:"center"},children:Je.map((e=>(0,$.jsx)(d.A,{component:"button",onClick:()=>{mo(e),Ye(!1)},sx:{border:"none",background:"none",cursor:"pointer",fontSize:"1.8rem",m:.5,p:.5,borderRadius:"4px",minWidth:"40px",height:"40px",display:"flex",alignItems:"center",justifyContent:"center","&:hover":{background:e=>"dark"===e.palette.mode?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.05)"}},children:e},e)))})}),(0,$.jsx)(z.Ay,{open:Boolean(Le.anchorEl),anchorEl:Le.anchorEl,onClose:so,anchorOrigin:{vertical:"top",horizontal:"center"},transformOrigin:{vertical:"bottom",horizontal:"center"},PaperProps:{sx:{width:"250px",maxWidth:"90vw",maxHeight:"300px"}},children:(0,$.jsxs)(d.A,{sx:{p:2,bgcolor:e=>"dark"===e.palette.mode?"grey.800":"background.paper"},children:[(0,$.jsxs)(d.A,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:1.5,pb:1,borderBottom:1,borderColor:"divider"},children:[(0,$.jsxs)(c.A,{variant:"h6",sx:{display:"flex",alignItems:"center"},children:[(0,$.jsx)(d.A,{component:"span",sx:{fontSize:"1.6rem",mr:1},children:Le.emoji}),"Reactions"]}),Le.message&&Le.emoji&&(null===(r=Le.message.reactions)||void 0===r?void 0:r.some((e=>e.emoji===Le.emoji&&e.userId===(null===te||void 0===te?void 0:te.uid))))&&(0,$.jsx)(v.A,{variant:"outlined",color:"error",size:"small",onClick:()=>{var e;return(async(e,o)=>{if(null===te||void 0===te||!te.uid||!xe)return;const r=oe||re;if(r)try{const i=(0,X.H9)(_.db,"conversations",r,"messages",e),n=await(0,X.x7)(i);if(!n.exists())return void Q.oR.error("Message not found");const a=(n.data().reactions||[]).filter((e=>!(e.userId===te.uid&&e.emoji===o)));await(0,X.mZ)(i,{reactions:a}),de((o=>o.map((o=>o.id===e?(0,t.A)((0,t.A)({},o),{},{reactions:a}):o)))),so()}catch(i){console.error("[Chat] Error removing reaction:",i),Q.oR.error("Failed to remove reaction")}})((null===(e=Le.message)||void 0===e?void 0:e.id)||"",Le.emoji||"")},children:"Remove"})]}),(0,$.jsx)(D.A,{sx:{py:0},children:Le.message&&Le.emoji&&(null===(n=Le.message.reactions)||void 0===n?void 0:n.filter((e=>e.emoji===Le.emoji)).map(((e,o)=>(0,$.jsx)(O.Ay,{sx:{py:.5,px:1,borderRadius:1,my:.3,bgcolor:e.userId===(null===te||void 0===te?void 0:te.uid)?e=>"dark"===e.palette.mode?"rgba(25, 118, 210, 0.15)":"rgba(25, 118, 210, 0.05)":"transparent"},children:(0,$.jsxs)(d.A,{sx:{display:"flex",alignItems:"center",width:"100%",justifyContent:"space-between"},children:[(0,$.jsxs)(c.A,{children:[e.username||"User",e.userId===(null===te||void 0===te?void 0:te.uid)&&(0,$.jsx)(c.A,{component:"span",color:"text.secondary",sx:{ml:.5,fontSize:"0.8rem"},children:"(you)"})]}),(0,$.jsx)(c.A,{fontSize:"1.2rem",children:e.emoji})]})},"".concat(e.userId,"-").concat(o)))))})]})})]})}},7016:(e,o,r)=>{r.d(o,{A:()=>a});r(9950);var t=r(6491),i=r(3274),n=r(4414);const a=e=>{let{isOnline:o,size:r="small",showTooltip:a=!0}=e;const s={small:10,medium:14,large:18},l=(0,n.jsx)(t.A,{sx:{width:s[r],height:s[r],borderRadius:"50%",backgroundColor:o?"#4caf50":"#bdbdbd",border:"2px solid white",boxShadow:"0 0 0 1px rgba(0,0,0,0.1)",transition:"background-color 0.3s ease"}});return a?(0,n.jsx)(i.A,{title:o?"Online":"Offline",placement:"top",children:l}):l}}}]);