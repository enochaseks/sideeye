"use strict";(self.webpackChunkside_eye=self.webpackChunkside_eye||[]).push([[303],{2303:(e,t,r)=>{r.r(t),r.d(t,{default:()=>j});var o=r(9950),i=r(8429),n=r(2074),s=r(9808),a=r(6491),c=r(6639),d=r(2235),l=r(2053),u=r(3174),p=r(8145),g=r(226),m=r(1367),y=r(6220),h=r(9901),f=r(330);const v={randomUUID:"undefined"!==typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};let x;const S=new Uint8Array(16);function b(){if(!x&&(x="undefined"!==typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!x))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return x(S)}const D=[];for(let C=0;C<256;++C)D.push((C+256).toString(16).slice(1));function w(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return D[e[t+0]]+D[e[t+1]]+D[e[t+2]]+D[e[t+3]]+"-"+D[e[t+4]]+D[e[t+5]]+"-"+D[e[t+6]]+D[e[t+7]]+"-"+D[e[t+8]]+D[e[t+9]]+"-"+D[e[t+10]]+D[e[t+11]]+D[e[t+12]]+D[e[t+13]]+D[e[t+14]]+D[e[t+15]]}const A=function(e,t,r){if(v.randomUUID&&!t&&!e)return v.randomUUID();const o=(e=e||{}).random||(e.rng||b)();if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,t){r=r||0;for(let e=0;e<16;++e)t[r+e]=o[e];return t}return w(o)};var I=r(4414);const j=()=>{const{currentUser:e,user:t,loading:r,userProfile:v}=(0,m.As)(),x=(0,i.Zp)(),[S,b]=(0,o.useState)(""),[D,w]=(0,o.useState)(""),[j,C]=(0,o.useState)(null),[U,P]=(0,o.useState)(null),[k,R]=(0,o.useState)(!1),[W,q]=(0,o.useState)("");(0,o.useEffect)((()=>{(async()=>{try{let i="";try{i=localStorage.getItem("deviceId")||""}catch(o){console.log("localStorage access blocked, generating new device ID")}if(!i){i=A();try{localStorage.setItem("deviceId",i)}catch(o){console.log("Failed to store device ID in localStorage")}}if(q(i),r)return;if(!(e||t))return void x("/login");null!==v&&void 0!==v&&v.sourceCodeSetupComplete&&x("/")}catch(i){console.error("Device initialization error:",i),C("Failed to initialize device")}})()}),[e,t,r,x,v]);return r?(0,I.jsx)(s.A,{maxWidth:"sm",children:(0,I.jsx)(a.A,{display:"flex",justifyContent:"center",mt:8,children:(0,I.jsx)(c.A,{})})}):(0,I.jsx)(s.A,{maxWidth:"xs",children:(0,I.jsxs)(d.A,{elevation:3,sx:{mt:8,p:4},children:[(0,I.jsx)(l.A,{variant:"h5",align:"center",gutterBottom:!0,children:"Device Registration"}),(0,I.jsx)(l.A,{variant:"body2",color:"text.secondary",align:"center",paragraph:!0,children:W?"Device ID: ".concat(W.slice(0,8),"..."):"Generating device ID..."}),j&&(0,I.jsx)(u.A,{severity:"error",sx:{mb:2},children:j}),U&&(0,I.jsx)(u.A,{severity:"success",sx:{mb:2},children:U}),(0,I.jsxs)(a.A,{component:"form",onSubmit:async r=>{if(r.preventDefault(),!(/^\d{8}$/.test(S)?S===D||(C("Codes do not match"),0):(C("Source code must be exactly 8 digits"),0)))return;if(!W)return void C("Device identification failed. Please refresh the page.");const o=e||t;if(o&&f.db){R(!0),C(null);try{const e=h.Ay.genSaltSync(10),t=h.Ay.hashSync(S,e);if(!W||"string"!==typeof W)throw new Error("Invalid device ID");const r=(0,y.H9)(f.db,"users",o.uid);await(0,y.mZ)(r,{sourceCodeHash:t,sourceCodeSetupComplete:!0,registeredDevices:(0,y.hq)(W),lastUpdated:(0,y.O5)()});const i=await(0,y.x7)(r);if(!i.exists()||!i.data().sourceCodeSetupComplete)throw new Error("Failed to update source code settings");localStorage.setItem("deviceId",W),P("Device registration successful! Redirecting..."),setTimeout((()=>{x("/"),setTimeout((()=>{window.openProfileSetupDialog&&window.openProfileSetupDialog()}),1e3)}),1500)}catch(i){console.error("Setup error:",i),C("permission-denied"===i.code?"Permission denied. Please contact support.":i.message.includes("device")?"Device registration failed. Please try again.":"Setup failed. Please try again.")}finally{R(!1)}}else C("Authentication error")},sx:{mt:2},children:[(0,I.jsx)(p.A,{fullWidth:!0,margin:"normal",label:"8-Digit Security Code",value:S,type:"password",onChange:e=>b(e.target.value.replace(/\D/g,"").slice(0,8)),inputProps:{maxLength:8,inputMode:"numeric",pattern:"[0-9]*"},required:!0}),(0,I.jsx)(p.A,{fullWidth:!0,margin:"normal",label:"Confirm Security Code",value:D,type:"password",onChange:e=>w(e.target.value.replace(/\D/g,"").slice(0,8)),inputProps:{maxLength:8,inputMode:"numeric",pattern:"[0-9]*"},required:!0}),(0,I.jsx)(l.A,{variant:"body2",color:"text.secondary",sx:{mt:2,mb:2},children:"Please set up a 8 digit source code, that is not your birth date. Your source code is a permanent security feature that cannot be reset. It protects your account by verifying your identity when logging in from new devices. Please remember this code as you will need it anytime you log in from a new device."}),(0,I.jsx)(n.N_,{to:"/faq#source-code-faq",style:{display:"block",textAlign:"center",marginBottom:"16px",fontSize:"0.9rem",color:"primary"},children:"Why do I need to set up a source code?"}),(0,I.jsx)(g.A,{type:"submit",fullWidth:!0,variant:"contained",sx:{mt:1},disabled:k||!W,children:k?(0,I.jsx)(c.A,{size:24}):"Register This Device"})]})]})})}}}]);