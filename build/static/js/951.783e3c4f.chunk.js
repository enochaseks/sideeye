"use strict";(self.webpackChunkside_eye=self.webpackChunkside_eye||[]).push([[951],{5951:(e,o,r)=>{r.r(o),r.d(o,{default:()=>ue});var t=r(9379),i=r(9950),s=r(4857),a=r(6589),n=r(6491),l=r(6639),d=r(9808),c=r(5333),u=r(2053),h=r(8145),x=r(2046),p=r(2235),m=r(249),b=r(6050),g=r(8614),v=r(1413),f=r(3563),A=r(4745),y=r(2236),j=r(4142),w=r(1378),C=r(899),S=r(470),k=r(3569),P=r(5277),I=r(704),z=r(226),R=r(6583),U=r(33),E=r(8170),M=r(9739),W=r(9715),D=r(6835),F=r(6164),L=r(7092),G=r(227),B=r(4066),H=r(7920),T=r(2960),O=r(7493),_=r(4517),N=r(8429),V=r(6220),J=r(330),q=r(1367),Y=r(5887),Z=r(7081);const X=e=>{try{return(0,Z.A)(e)}catch(o){return e instanceof Date?e.toLocaleString():new Date(e).toLocaleString()}},K=e=>{if(!e)return"";try{return e.toDate?X(e.toDate()):e instanceof Date?X(e):X(new Date(e))}catch(o){return console.error("Error formatting timestamp:",o),""}};var Q=r(9325),$=r(1849),ee=r(2472),oe=r(4862),re=r(3174),te=r(3256),ie=r(5788),se=r(6052),ae=r(7222),ne=r(7341),le=r(9751),de=r(4414);const ce=()=>{var e,o,r,d,x,p;const{currentUser:m,blockUser:b}=(0,q.As)(),g=(0,N.Zp)(),f=(0,s.A)(),A=(0,a.A)(f.breakpoints.down("sm")),[y,j]=(0,i.useState)([]),[w,C]=(0,i.useState)(!0),[k,U]=(0,i.useState)(null),[M,W]=(0,i.useState)(0),[F,L]=(0,i.useState)(0),[G,B]=(0,i.useState)(""),[H,T]=(0,i.useState)(null),[O,_]=(0,i.useState)(!1),[Y,Z]=(0,i.useState)(null),[X,K]=(0,i.useState)(null),[Q,$]=(0,i.useState)(!1),[ce,ue]=(0,i.useState)(!1),[he,xe]=(0,i.useState)(null),[pe,me]=(0,i.useState)(null),[be,ge]=(0,i.useState)(null),[ve,fe]=(0,i.useState)(null),[Ae,ye]=(0,i.useState)(!1),[je,we]=(0,i.useState)([]),[Ce,Se]=(0,i.useState)(null),[ke,Pe]=(0,i.useState)(""),[Ie,ze]=(0,i.useState)(!1),[Re,Ue]=(0,i.useState)(!1),[Ee,Me]=(0,i.useState)(!1),[We,De]=(0,i.useState)([]),[Fe,Le]=(0,i.useState)(!1),[Ge,Be]=(0,i.useState)(null),[He,Te]=(0,i.useState)(!1),[Oe,_e]=(0,i.useState)(null),[Ne,Ve]=(0,i.useState)(!1),Je=async()=>{if(m)try{const e=(0,V.H9)(J.db,"users",m.uid),o=await(0,V.x7)(e);o.exists()&&_e(o.data())}catch(Y){console.error("Error fetching user profile:",Y)}};(0,i.useEffect)((()=>{console.log("State update:",{previewMode:Re,showPostDrawer:Ie,hasSelectedFile:!!H,hasCapturedPhoto:!!pe,hasRecordedVideo:!!he,showCameraView:Q})}),[Re,Ie,H,pe,he,Q]);const qe=(0,i.useRef)(null),Ye=(0,i.useRef)(null),Ze=(0,i.useRef)(null),Xe=(0,i.useRef)(null),Ke=async()=>{if(m)try{C(!0),console.log("Fetching stories for user:",m.uid);const r=(0,V.P)((0,V.rJ)(J.db,"users/".concat(m.uid,"/following"))),t=(await(0,V.GG)(r)).docs.map((e=>e.id));console.log("Following list from subcollection:",t);const i=[m.uid,...t];console.log("All user IDs to fetch stories for:",i);const s=new Date;let a;s.setHours(s.getHours()-24);try{if(i.length<=10){const e=(0,V.P)((0,V.rJ)(J.db,"stories"),(0,V._M)("userId","in",i),(0,V._M)("expiresAt",">",V.Dc.fromDate(s)),(0,V.My)("expiresAt"),(0,V.My)("createdAt","desc"));console.log("Executing stories query for",i.length,"users..."),a=await(0,V.GG)(e),console.log("Found",a.docs.length,"stories")}else{console.log("More than 10 users, batching queries...");const e=[];for(let r=0;r<i.length;r+=10){const o=i.slice(r,r+10),t=(0,V.P)((0,V.rJ)(J.db,"stories"),(0,V._M)("userId","in",o),(0,V._M)("expiresAt",">",V.Dc.fromDate(s)),(0,V.My)("expiresAt"),(0,V.My)("createdAt","desc"));e.push((0,V.GG)(t))}const o=(await Promise.all(e)).flatMap((e=>e.docs));a={docs:o},console.log("Found",o.length,"stories from batched queries")}}catch(o){console.error("Error with compound query, trying simpler approach:",o);const e=(0,V.P)((0,V.rJ)(J.db,"stories"),(0,V._M)("userId","==",m.uid),(0,V._M)("expiresAt",">",V.Dc.fromDate(s)),(0,V.My)("expiresAt","desc"));a=await(0,V.GG)(e),console.log("Fallback query found",a.docs.length,"user stories")}const n=[];for(const o of a.docs){var e;const r=o.data();console.log("Processing story:",o.id,r);const t=(0,V.H9)(J.db,"users",r.userId),i=(await(0,V.x7)(t)).data();n.push({id:o.id,userId:r.userId,username:(null===i||void 0===i?void 0:i.username)||(null===i||void 0===i?void 0:i.name)||"Unknown User",userAvatar:(null===i||void 0===i?void 0:i.profilePic)||(null===i||void 0===i?void 0:i.photoURL)||"",content:r.content||"",mediaUrl:r.mediaUrl,mediaType:r.mediaType,createdAt:r.createdAt,expiresAt:r.expiresAt,views:r.views||[],isViewed:(null===(e=r.views)||void 0===e?void 0:e.includes(m.uid))||!1})}console.log("Processed stories:",n);const l={};n.forEach((e=>{l[e.userId]||(l[e.userId]={userId:e.userId,username:e.username,userAvatar:e.userAvatar,stories:[],hasUnviewed:!1}),l[e.userId].stories.push(e),e.isViewed||e.userId===m.uid||(l[e.userId].hasUnviewed=!0)}));const d=Object.values(l).sort(((e,o)=>e.userId===m.uid?-1:o.userId===m.uid?1:e.hasUnviewed&&!o.hasUnviewed?-1:!e.hasUnviewed&&o.hasUnviewed?1:0));console.log("Final story groups:",d),j(d)}catch(Y){console.error("Error fetching stories:",Y),Z("Failed to load stories")}finally{C(!1)}else console.log("No current user, skipping story fetch")},Qe=async e=>{if(m)try{const o=(0,V.H9)(J.db,"stories",e);await(0,V.mZ)(o,{views:(0,V.hq)(m.uid)})}catch(Y){console.error("Error marking story as viewed:",Y)}},$e=async e=>{if(m)try{const o=(0,V.H9)(J.db,"stories",e),r=await(0,V.x7)(o);if(r.exists()){const e=r.data().views||[],o=[];for(const r of e){const e=(0,V.H9)(J.db,"users",r),t=await(0,V.x7)(e);if(t.exists()){const e=t.data();o.push({id:r,username:e.username||e.name||"Unknown User",avatar:e.profilePic||e.photoURL||""})}}De(o),Me(!0)}}catch(Y){console.error("Error getting story viewers:",Y),Z("Failed to load viewers")}};(0,i.useEffect)((()=>(k&&k.stories.length>0&&!Ee&&(Xe.current=setInterval((()=>{L((e=>{if(e>=100){const e=M+1;return e<k.stories.length?(W(e),k.stories[e].userId!==(null===m||void 0===m?void 0:m.uid)&&Qe(k.stories[e].id),0):(U(null),0)}return e+2}))}),100)),()=>{Xe.current&&clearInterval(Xe.current)})),[k,M,m,Ee]);const eo=()=>{if(!k)return;const e=M+1;e<k.stories.length?(W(e),L(0),k.stories[e].userId!==(null===m||void 0===m?void 0:m.uid)&&Qe(k.stories[e].id)):U(null)},oo=()=>{M>0&&(W(M-1),L(0))},ro=async()=>{try{const e=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)?{facingMode:"user",width:{ideal:720},height:{ideal:1280}}:{facingMode:"user",width:{ideal:1280},height:{ideal:720}},o=await navigator.mediaDevices.getUserMedia({video:e,audio:!0});ge(o),$(!0),setTimeout((()=>{Ze.current&&o&&(Ze.current.srcObject=o,Ze.current.play().catch(console.error))}),100)}catch(Y){console.error("Error accessing camera:",Y),Z("Could not access camera. Please check permissions.")}},to=()=>{be&&(be.getTracks().forEach((e=>e.stop())),ge(null)),$(!1),ue(!1),xe(null),me(null),Ue(!1),ze(!1),we([]),B(""),T(null)},io=()=>{const e={id:Date.now().toString(),text:ke||"Tap to edit",x:50,y:50,fontSize:24,color:"#ffffff"};we((o=>[...o,e])),Pe(""),ye(!1)},so=(e,o)=>{we((r=>r.map((r=>r.id===e?(0,t.A)((0,t.A)({},r),o):r))))};return(0,i.useEffect)((()=>{Q&&be&&Ze.current&&(Ze.current.srcObject=be,Ze.current.play().catch(console.error))}),[Q,be]),(0,i.useEffect)((()=>()=>{be&&be.getTracks().forEach((e=>e.stop()))}),[be]),(0,i.useEffect)((()=>{Ke(),Je()}),[m]),w?(0,de.jsx)(n.A,{sx:{display:"flex",justifyContent:"center",py:2},children:(0,de.jsx)(l.A,{size:24})}):(0,de.jsxs)(n.A,{sx:{py:1,"& @keyframes pulse":{"0%":{transform:"scale(1)",boxShadow:"0 8px 30px rgba(0, 122, 255, 0.6)"},"50%":{transform:"scale(1.05)",boxShadow:"0 12px 40px rgba(0, 122, 255, 0.8)"},"100%":{transform:"scale(1)",boxShadow:"0 8px 30px rgba(0, 122, 255, 0.6)"}}},children:[(0,de.jsx)(u.A,{variant:"h6",sx:{mb:1,fontWeight:600},children:"Peeks"}),(0,de.jsxs)(n.A,{sx:{display:"flex",gap:2,overflowX:"auto",pb:1,"&::-webkit-scrollbar":{height:6},"&::-webkit-scrollbar-track":{backgroundColor:"rgba(0,0,0,0.1)",borderRadius:3},"&::-webkit-scrollbar-thumb":{backgroundColor:"rgba(0,0,0,0.3)",borderRadius:3}},children:[m&&(0,de.jsxs)(n.A,{sx:{display:"flex",flexDirection:"column",alignItems:"center",minWidth:80,cursor:"pointer"},onClick:ro,children:[(0,de.jsxs)(n.A,{sx:{position:"relative"},children:[(0,de.jsx)(v.A,{src:(null===Oe||void 0===Oe?void 0:Oe.profilePic)||(null===Oe||void 0===Oe?void 0:Oe.photoURL)||m.photoURL||"",sx:{width:64,height:64,border:"2px solid",borderColor:"divider"},children:null===(e=(null===Oe||void 0===Oe?void 0:Oe.username)||(null===Oe||void 0===Oe?void 0:Oe.name)||m.displayName||m.email)||void 0===e||null===(o=e[0])||void 0===o?void 0:o.toUpperCase()}),(0,de.jsx)(ee.A,{size:"small",color:"primary",sx:{position:"absolute",bottom:-4,right:-4,width:24,height:24,minHeight:24},children:(0,de.jsx)(te.A,{sx:{fontSize:16}})})]}),(0,de.jsx)(u.A,{variant:"caption",sx:{mt:1,textAlign:"center"},children:"Your Story"})]}),y.map((e=>{var o;return(0,de.jsxs)(n.A,{sx:{display:"flex",flexDirection:"column",alignItems:"center",minWidth:80,cursor:"pointer"},onClick:()=>function(e){let o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;Ne||(Ve(!0),U(e),W(o),L(0),e.stories[o]&&e.stories[o].userId!==(null===m||void 0===m?void 0:m.uid)&&Qe(e.stories[o].id),setTimeout((()=>{Ve(!1)}),500))}(e),children:[(0,de.jsx)(v.A,{src:e.userAvatar,sx:{width:64,height:64,border:"3px solid",borderColor:e.hasUnviewed?"primary.main":"divider",p:e.hasUnviewed?.5:0},children:null===(o=e.username[0])||void 0===o?void 0:o.toUpperCase()}),(0,de.jsx)(u.A,{variant:"caption",sx:{mt:1,textAlign:"center"},children:e.userId===(null===m||void 0===m?void 0:m.uid)?"You":e.username}),e.hasUnviewed&&(0,de.jsx)(P.A,{label:"New",size:"small",color:"primary",sx:{mt:.5,height:16,fontSize:"0.7rem"}})]},e.userId)})),0===y.length&&(0,de.jsx)(u.A,{variant:"body2",color:"text.secondary",sx:{py:4},children:"No stories available. Follow users to see their stories here!"})]}),(0,de.jsx)(R.A,{open:!!k,onClose:()=>U(null),fullScreen:!0,PaperProps:{sx:{bgcolor:"black",color:"white",margin:0,maxHeight:"100vh",maxWidth:"100vw"}},TransitionProps:{timeout:300},children:k&&k.stories[M]&&(0,de.jsxs)(n.A,{sx:{position:"relative",height:"100vh",width:"100vw",overflow:"hidden",bgcolor:"black"},children:[(0,de.jsx)(n.A,{sx:{position:"absolute",top:0,left:0,right:0,bottom:0,zIndex:1},children:k.stories[M].mediaUrl?"video"===k.stories[M].mediaType?(0,de.jsx)("video",{src:k.stories[M].mediaUrl,autoPlay:!0,muted:!0,loop:!0,playsInline:!0,style:{width:"100%",height:"100%",objectFit:"cover",objectPosition:"center"}}):(0,de.jsx)("img",{src:k.stories[M].mediaUrl,alt:"Story",style:{width:"100%",height:"100%",objectFit:"cover",objectPosition:"center"}}):(0,de.jsx)(n.A,{sx:{width:"100%",height:"100%",background:"linear-gradient(135deg, #667eea 0%, #764ba2 100%)",display:"flex",alignItems:"center",justifyContent:"center"}})}),(0,de.jsx)(n.A,{sx:{position:"absolute",top:0,left:0,right:0,bottom:0,background:"linear-gradient(to bottom, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0) 20%, rgba(0,0,0,0) 80%, rgba(0,0,0,0.3) 100%)",zIndex:2}}),(0,de.jsx)(n.A,{sx:{position:"absolute",top:20,left:16,right:16,zIndex:10,display:"flex",gap:4},children:k.stories.map(((e,o)=>(0,de.jsx)(n.A,{sx:{flex:1,height:3,bgcolor:"rgba(255,255,255,0.3)",borderRadius:2,overflow:"hidden"},children:(0,de.jsx)(n.A,{sx:{height:"100%",width:o<M?"100%":o===M?"".concat(F,"%"):"0%",bgcolor:"white",transition:o===M?"none":"width 0.3s ease"}})},o)))}),(0,de.jsxs)(n.A,{sx:{position:"absolute",top:40,left:16,right:16,zIndex:10,display:"flex",alignItems:"center",justifyContent:"space-between"},children:[(0,de.jsxs)(n.A,{sx:{display:"flex",alignItems:"center",gap:1.5},children:[(0,de.jsx)(v.A,{src:k.userAvatar,sx:{width:40,height:40,border:"2px solid white"},children:null===(r=k.username[0])||void 0===r?void 0:r.toUpperCase()}),(0,de.jsxs)(n.A,{children:[(0,de.jsx)(u.A,{variant:"subtitle1",sx:{fontWeight:600,fontSize:16,textShadow:"1px 1px 2px rgba(0,0,0,0.8)"},children:k.username}),(0,de.jsx)(u.A,{variant:"caption",sx:{color:"rgba(255,255,255,0.8)",fontSize:12,textShadow:"1px 1px 2px rgba(0,0,0,0.8)"},children:null===(d=k.stories[M].createdAt)||void 0===d?void 0:d.toDate().toLocaleTimeString()})]})]}),(0,de.jsxs)(n.A,{sx:{display:"flex",gap:1},children:[k.stories[M].userId===(null===m||void 0===m?void 0:m.uid)&&(0,de.jsx)(c.A,{onClick:()=>Le(!0),sx:{color:"white",bgcolor:"rgba(0,0,0,0.3)",backdropFilter:"blur(10px)","&:hover":{bgcolor:"rgba(255,0,0,0.5)"}},children:(0,de.jsx)(u.A,{sx:{fontSize:18},children:"\ud83d\uddd1\ufe0f"})}),(0,de.jsx)(c.A,{onClick:()=>U(null),sx:{color:"white",bgcolor:"rgba(0,0,0,0.3)",backdropFilter:"blur(10px)","&:hover":{bgcolor:"rgba(0,0,0,0.5)"}},children:(0,de.jsx)(D.A,{})})]})]}),k.stories[M].content&&(0,de.jsx)(n.A,{sx:{position:"absolute",bottom:100,left:20,right:20,zIndex:10,textAlign:"center"},children:(0,de.jsx)(u.A,{variant:"h5",sx:{fontWeight:600,fontSize:{xs:20,sm:24},textShadow:"2px 2px 8px rgba(0,0,0,0.8)",lineHeight:1.3,wordBreak:"break-word"},children:k.stories[M].content})}),k.stories[M].userId===(null===m||void 0===m?void 0:m.uid)&&!Ee&&(0,de.jsxs)(n.A,{onClick:()=>$e(k.stories[M].id),sx:{position:"absolute",bottom:0,left:0,right:0,height:120,zIndex:15,cursor:"pointer",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"flex-end",pb:3,background:"linear-gradient(to top, rgba(0,0,0,0.4) 0%, rgba(0,0,0,0) 100%)"},children:[(0,de.jsxs)(n.A,{sx:{display:"flex",alignItems:"center",gap:1,bgcolor:"rgba(0,0,0,0.5)",px:2,py:1,borderRadius:3,backdropFilter:"blur(10px)"},children:[(0,de.jsx)(u.A,{sx:{fontSize:16},children:"\ud83d\udc41\ufe0f"}),(0,de.jsxs)(u.A,{variant:"body2",sx:{color:"white",fontWeight:500},children:[(null===(x=k.stories[M].views)||void 0===x?void 0:x.length)||0," views"]})]}),(0,de.jsx)(u.A,{variant:"caption",sx:{color:"rgba(255,255,255,0.8)",mt:1,textShadow:"1px 1px 2px rgba(0,0,0,0.8)"},children:"Tap to see who viewed your story"})]}),Ee&&k.stories[M].userId===(null===m||void 0===m?void 0:m.uid)&&(0,de.jsxs)(n.A,{sx:{position:"absolute",bottom:0,left:0,right:0,height:"50vh",bgcolor:"rgba(0,0,0,0.9)",backdropFilter:"blur(20px)",zIndex:20,borderTopLeftRadius:20,borderTopRightRadius:20,display:"flex",flexDirection:"column"},children:[(0,de.jsx)(n.A,{sx:{width:36,height:5,bgcolor:"rgba(255,255,255,0.3)",borderRadius:3,mx:"auto",mt:1,mb:2}}),(0,de.jsxs)(n.A,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",px:3,pb:2},children:[(0,de.jsxs)(u.A,{variant:"h6",sx:{color:"white",fontWeight:600},children:["Viewed by ",We.length]}),(0,de.jsx)(c.A,{onClick:()=>Me(!1),sx:{color:"white"},children:(0,de.jsx)(D.A,{})})]}),(0,de.jsx)(n.A,{sx:{flex:1,overflow:"auto",px:3},children:0===We.length?(0,de.jsxs)(n.A,{sx:{textAlign:"center",py:4,color:"rgba(255,255,255,0.7)"},children:[(0,de.jsx)(u.A,{sx:{fontSize:48,mb:2},children:"\ud83d\udc41\ufe0f"}),(0,de.jsx)(u.A,{variant:"body1",sx:{color:"white"},children:"No views yet"}),(0,de.jsx)(u.A,{variant:"body2",children:"When people view your story, you'll see them here"})]}):(0,de.jsx)(n.A,{sx:{display:"flex",flexDirection:"column",gap:2},children:We.map((e=>{var o;return(0,de.jsxs)(n.A,{sx:{display:"flex",alignItems:"center",gap:2,py:1,position:"relative"},children:[(0,de.jsx)(v.A,{src:e.avatar,sx:{width:50,height:50},children:null===(o=e.username[0])||void 0===o?void 0:o.toUpperCase()}),(0,de.jsx)(n.A,{sx:{flex:1},children:(0,de.jsx)(u.A,{variant:"body1",sx:{fontWeight:500,color:"white"},children:e.username})}),(0,de.jsx)(c.A,{onClick:()=>{Be(e),Te(!0)},sx:{color:"rgba(255,255,255,0.7)","&:hover":{color:"white",bgcolor:"rgba(255,255,255,0.1)"}},children:(0,de.jsx)(u.A,{sx:{fontSize:20,fontWeight:"bold"},children:"\u22ef"})})]},e.id)}))})})]}),k.stories[M].userId!==(null===m||void 0===m?void 0:m.uid)&&(0,de.jsxs)(de.Fragment,{children:[(0,de.jsx)(n.A,{sx:{position:"absolute",left:0,top:0,bottom:0,width:"40%",cursor:"pointer",zIndex:5,display:"flex",alignItems:"center",justifyContent:"flex-start",pl:2},onClick:oo,children:M>0&&(0,de.jsx)(ie.A,{sx:{color:"rgba(255,255,255,0.0)",fontSize:40,transition:"color 0.2s ease","&:hover":{color:"rgba(255,255,255,0.7)"}}})}),(0,de.jsx)(n.A,{sx:{position:"absolute",right:0,top:0,bottom:0,width:"40%",cursor:"pointer",zIndex:5,display:"flex",alignItems:"center",justifyContent:"flex-end",pr:2},onClick:eo,children:(0,de.jsx)(se.A,{sx:{color:"rgba(255,255,255,0.0)",fontSize:40,transition:"color 0.2s ease","&:hover":{color:"rgba(255,255,255,0.7)"}}})})]}),k.stories[M].userId===(null===m||void 0===m?void 0:m.uid)&&(0,de.jsxs)(de.Fragment,{children:[(0,de.jsx)(n.A,{sx:{position:"absolute",left:0,top:100,bottom:150,width:"25%",cursor:"pointer",zIndex:5,display:"flex",alignItems:"center",justifyContent:"flex-start",pl:2},onClick:oo,children:M>0&&(0,de.jsx)(ie.A,{sx:{color:"rgba(255,255,255,0.0)",fontSize:40,transition:"color 0.2s ease","&:hover":{color:"rgba(255,255,255,0.7)"}}})}),(0,de.jsx)(n.A,{sx:{position:"absolute",right:0,top:100,bottom:150,width:"25%",cursor:"pointer",zIndex:5,display:"flex",alignItems:"center",justifyContent:"flex-end",pr:2},onClick:eo,children:(0,de.jsx)(se.A,{sx:{color:"rgba(255,255,255,0.0)",fontSize:40,transition:"color 0.2s ease","&:hover":{color:"rgba(255,255,255,0.7)"}}})})]})]})}),(0,de.jsx)(R.A,{open:Q,onClose:to,maxWidth:"md",fullWidth:!0,fullScreen:A,PaperProps:{sx:{bgcolor:"black",color:"white",height:A?"100vh":"90vh"}},children:(0,de.jsxs)(E.A,{sx:{p:0,position:"relative",height:"100%",display:"flex"},children:[(0,de.jsxs)(n.A,{sx:{flex:1,position:"relative",display:"flex",alignItems:"center",justifyContent:"center",bgcolor:"black",width:"100%",height:"100%"},children:[Re?(0,de.jsx)(n.A,{sx:{width:"100%",height:"100%",position:"relative"},children:pe?(0,de.jsx)("img",{src:pe,alt:"Captured",style:{width:"100%",height:"100%",objectFit:"cover"}}):he?(0,de.jsx)("video",{src:URL.createObjectURL(he),controls:!0,autoPlay:!0,muted:!0,loop:!0,playsInline:!0,style:{width:"100%",height:"100%",objectFit:"cover"},onLoadedData:()=>console.log("Recorded video loaded for preview"),onError:e=>console.error("Error loading recorded video:",e)}):null}):(0,de.jsx)("video",{ref:Ze,autoPlay:!0,muted:!0,playsInline:!0,style:{width:"100%",height:"100%",objectFit:"cover",transform:"scaleX(-1)"},onLoadedMetadata:()=>{Ze.current&&Ze.current.play().catch(console.error)}}),(0,de.jsx)(n.A,{sx:{position:"absolute",bottom:20,left:0,right:0,display:"flex",justifyContent:"space-between",alignItems:"center",px:3},children:Re?(0,de.jsx)(n.A,{sx:{display:"flex",gap:2,width:"100%",justifyContent:"center"},children:(0,de.jsx)(z.A,{onClick:()=>{xe(null),T(null),me(null),we([]),Ue(!1),ze(!1),B(""),be&&Ze.current?(Ze.current.srcObject=be,Ze.current.play().catch(console.error)):be||ro()},variant:"outlined",sx:{color:"white",borderColor:"white",px:4,py:1.5,borderRadius:3},children:"Retake"})}):(0,de.jsxs)(de.Fragment,{children:[(0,de.jsx)(c.A,{onClick:()=>{if(!Ze.current||!be)return;const e=document.createElement("canvas"),o=Ze.current;e.width=o.videoWidth,e.height=o.videoHeight;const r=e.getContext("2d");if(r){r.scale(-1,1),r.drawImage(o,-e.width,0,e.width,e.height);const t=e.toDataURL("image/jpeg",.8);me(t),e.toBlob((e=>{if(e){const o=new File([e],"photo_".concat(Date.now(),".jpg"),{type:"image/jpeg"});T(o),Ue(!0)}}),"image/jpeg",.8)}},sx:{width:60,height:60,bgcolor:"rgba(255,255,255,0.2)",color:"white",backdropFilter:"blur(10px)","&:hover":{bgcolor:"rgba(255,255,255,0.3)"}},children:(0,de.jsx)(ae.A,{sx:{fontSize:28}})}),(0,de.jsx)(c.A,{onClick:ce?()=>{if(console.log("Stopping recording...",{mediaRecorder:!!ve,isRecording:ce}),ve&&ce)try{ve.stop(),ue(!1),fe(null),console.log("Recording stop requested")}catch(Y){console.error("Error stopping recording:",Y),Z("Error stopping recording")}}:()=>{if(be)try{if(console.log("Starting video recording..."),!MediaRecorder.isTypeSupported("video/webm")&&(console.warn("video/webm not supported, trying video/mp4"),!MediaRecorder.isTypeSupported("video/mp4")))return void Z("Video recording not supported on this device");const e=MediaRecorder.isTypeSupported("video/webm")?"video/webm":"video/mp4",o=new MediaRecorder(be,{mimeType:e,videoBitsPerSecond:25e5}),r=[];o.ondataavailable=e=>{console.log("Data available:",e.data.size,"bytes"),e.data.size>0&&r.push(e.data)},o.onstop=()=>{console.log("Recording stopped, creating blob from",r.length,"chunks");const o=new Blob(r,{type:e});if(console.log("Created blob:",o.size,"bytes"),0===o.size)return console.error("Recorded blob is empty!"),void Z("Recording failed - no data captured");xe(o);const t="video/webm"===e?"webm":"mp4",i=new File([o],"story_".concat(Date.now(),".").concat(t),{type:e});T(i),console.log("Switching to preview mode..."),Ue(!0)},o.onerror=e=>{console.error("MediaRecorder error:",e),Z("Recording error occurred")},o.start(1e3),fe(o),ue(!0),console.log("Recording started successfully")}catch(Y){console.error("Error starting recording:",Y),Z("Could not start recording")}else console.error("No camera stream available for recording")},sx:{width:80,height:80,bgcolor:ce?"error.main":"white",color:ce?"white":"primary.main",border:ce?"none":"4px solid white","&:hover":{bgcolor:ce?"error.dark":"rgba(255,255,255,0.9)"}},children:ce?(0,de.jsx)(n.A,{sx:{width:30,height:30,bgcolor:"white",borderRadius:1}}):(0,de.jsx)(n.A,{sx:{width:30,height:30,bgcolor:"error.main",borderRadius:"50%"}})}),(0,de.jsx)(c.A,{onClick:()=>{qe.current&&qe.current.click()},sx:{width:60,height:60,bgcolor:"rgba(255,255,255,0.2)",color:"white",backdropFilter:"blur(10px)","&:hover":{bgcolor:"rgba(255,255,255,0.3)"}},children:(0,de.jsx)(ne.A,{sx:{fontSize:28}})})]})}),Re&&(H||pe||he)&&(0,de.jsx)(ee.A,{onClick:()=>{console.log("Next button clicked - posting story directly!"),(async()=>{if(console.log("Creating story...",{hasUser:!!m,hasContent:!!G.trim(),hasFile:!!H}),m&&(G.trim()||H))try{_(!0),Z(null);let o,r="";if(H){var e;console.log("Uploading file:",H.name,H.type);const t=null===(e=H.name.split(".").pop())||void 0===e?void 0:e.toLowerCase();o=["jpg","jpeg","png","gif","webp"].includes(t||"")?"image":"video";const i=(0,le.KR)(J.IG,"stories/".concat(m.uid,"/").concat(Date.now(),"_").concat(H.name));console.log("Storage ref created:",i.fullPath);const s=await(0,le.D)(i,H);console.log("Upload completed:",s),r=await(0,le.qk)(s.ref),console.log("Download URL obtained:",r)}const t=new Date;t.setHours(t.getHours()+24);const i={userId:m.uid,content:G.trim(),mediaUrl:r,mediaType:o,createdAt:(0,V.O5)(),expiresAt:V.Dc.fromDate(t),views:[]};console.log("Creating story document:",i);const s=await(0,V.gS)((0,V.rJ)(J.db,"stories"),i);console.log("Story created with ID:",s.id);const a=await(0,V.x7)(s);a.exists()?console.log("Story verified in database:",a.data()):console.error("Story was not found after creation!"),K("Story created successfully!"),ze(!1),$(!1),Ue(!1),B(""),T(null),xe(null),me(null),we([]),be&&(be.getTracks().forEach((e=>e.stop())),ge(null)),console.log("Refreshing stories..."),setTimeout((async()=>{await Ke(),await Je(),console.log("Stories refreshed")}),1e3)}catch(Y){console.error("Error creating story:",Y),Z("Failed to create story: ".concat(Y instanceof Error?Y.message:"Unknown error"))}finally{_(!1)}else Z("Please add content or select a file")})()},sx:{position:"absolute",bottom:100,right:30,bgcolor:"#007aff",color:"white",width:70,height:70,zIndex:1e5,boxShadow:"0 8px 30px rgba(0, 122, 255, 0.6)",border:"3px solid white","&:hover":{bgcolor:"#0056b3",transform:"scale(1.1)",boxShadow:"0 12px 40px rgba(0, 122, 255, 0.8)"},transition:"all 0.3s ease-in-out"},children:(0,de.jsx)(se.A,{sx:{fontSize:28}})}),A&&Ae&&(0,de.jsxs)(n.A,{sx:{position:"absolute",bottom:120,left:16,right:16,bgcolor:"rgba(0,0,0,0.8)",borderRadius:2,p:2,zIndex:15},children:[(0,de.jsx)(h.A,{fullWidth:!0,placeholder:"Add text to your story...",value:ke,onChange:e=>Pe(e.target.value),autoFocus:!0,sx:{"& .MuiOutlinedInput-root":{color:"white","& fieldset":{borderColor:"rgba(255,255,255,0.3)"},"&:hover fieldset":{borderColor:"rgba(255,255,255,0.5)"},"&.Mui-focused fieldset":{borderColor:"primary.main"}}}}),(0,de.jsxs)(n.A,{sx:{display:"flex",gap:1,mt:1,justifyContent:"flex-end"},children:[(0,de.jsx)(z.A,{onClick:()=>{ye(!1),Pe(""),Se(null)},size:"small",sx:{color:"white"},children:"Cancel"}),(0,de.jsx)(z.A,{onClick:()=>{Ce?(so(Ce,{text:ke}),Se(null)):io(),ye(!1)},variant:"contained",size:"small",disabled:!ke.trim(),children:Ce?"Update":"Add"})]})]}),je.map((e=>(0,de.jsx)(n.A,{sx:{position:"absolute",left:"".concat(e.x,"%"),top:"".concat(e.y,"%"),transform:"translate(-50%, -50%)",color:e.color,fontSize:e.fontSize,fontWeight:"bold",textShadow:"2px 2px 4px rgba(0,0,0,0.8)",cursor:"pointer",userSelect:"none",zIndex:5},onClick:()=>{Se(e.id),Pe(e.text),ye(!0)},children:e.text},e.id))),(0,de.jsxs)(n.A,{sx:{position:"absolute",top:16,left:16,right:16,display:"flex",justifyContent:"space-between",alignItems:"center",zIndex:10},children:[(0,de.jsx)(c.A,{onClick:()=>ye(!0),sx:{color:"white",bgcolor:"rgba(0,0,0,0.5)",backdropFilter:"blur(10px)","&:hover":{bgcolor:"rgba(0,0,0,0.7)"}},children:(0,de.jsx)(u.A,{sx:{fontSize:20,fontWeight:"bold"},children:"Aa"})}),(0,de.jsx)(c.A,{onClick:to,sx:{color:"white",bgcolor:"rgba(0,0,0,0.5)",backdropFilter:"blur(10px)","&:hover":{bgcolor:"rgba(0,0,0,0.7)"}},children:(0,de.jsx)(D.A,{})})]}),ce&&(0,de.jsxs)(n.A,{sx:{position:"absolute",top:70,left:"50%",transform:"translateX(-50%)",display:"flex",alignItems:"center",gap:1,bgcolor:"rgba(0,0,0,0.7)",px:2,py:1,borderRadius:2,zIndex:10},children:[(0,de.jsx)(n.A,{sx:{width:8,height:8,bgcolor:"error.main",borderRadius:"50%",animation:"pulse 1s infinite"}}),(0,de.jsx)(u.A,{variant:"body2",sx:{color:"white",fontWeight:"bold"},children:"Recording..."})]})]}),!A&&(0,de.jsxs)(n.A,{sx:{width:300,position:"relative",height:"100%",bgcolor:"rgba(0,0,0,0.8)",p:2,display:"flex",flexDirection:"column",gap:2},children:[(0,de.jsx)(u.A,{variant:"h6",sx:{color:"white",mb:2},children:"Create Your Peek"}),(0,de.jsx)(h.A,{fullWidth:!0,multiline:!0,rows:3,placeholder:"Add a caption...",value:G,onChange:e=>B(e.target.value),sx:{"& .MuiOutlinedInput-root":{color:"white","& fieldset":{borderColor:"rgba(255,255,255,0.3)"},"&:hover fieldset":{borderColor:"rgba(255,255,255,0.5)"},"&.Mui-focused fieldset":{borderColor:"primary.main"}},"& .MuiInputLabel-root":{color:"rgba(255,255,255,0.7)"}}}),(0,de.jsxs)(n.A,{sx:{display:"flex",gap:1,flexWrap:"wrap"},children:[(0,de.jsx)(z.A,{startIcon:(0,de.jsx)(ae.A,{}),onClick:()=>{var e;return null===(e=qe.current)||void 0===e?void 0:e.click()},variant:"outlined",size:"small",sx:{color:"white",borderColor:"white"},children:"Photo"}),(0,de.jsx)(z.A,{startIcon:(0,de.jsx)(ne.A,{}),onClick:()=>{var e;return null===(e=qe.current)||void 0===e?void 0:e.click()},variant:"outlined",size:"small",sx:{color:"white",borderColor:"white"},children:"Gallery"})]}),H&&(0,de.jsx)(S.A,{sx:{bgcolor:"rgba(255,255,255,0.1)"},children:(0,de.jsx)(I.A,{children:(0,de.jsx)(u.A,{variant:"body2",sx:{color:"white"},children:H.name})})})]}),(0,de.jsx)("input",{ref:qe,type:"file",accept:"image/*,video/*",onChange:e=>{var o;const r=null===(o=e.target.files)||void 0===o?void 0:o[0];if(r){if(r.size>52428800)return void Z("File size must be less than 50MB");T(r),Ue(!0),$(!0)}e.target.value=""},style:{display:"none"}}),(0,de.jsx)("input",{ref:Ye,type:"file",accept:"image/*",onChange:e=>{var o;const r=null===(o=e.target.files)||void 0===o?void 0:o[0];if(r&&r.type.startsWith("image/")){if(r.size>52428800)return void Z("File size must be less than 50MB");T(r),Ue(!0),$(!0)}e.target.value=""},style:{display:"none"}})]})}),!A&&(0,de.jsx)(R.A,{open:Ae,onClose:()=>{ye(!1),Se(null),Pe("")},maxWidth:"sm",fullWidth:!0,PaperProps:{sx:{bgcolor:"rgba(0,0,0,0.9)",color:"white",backdropFilter:"blur(20px)"}},children:(0,de.jsxs)(E.A,{sx:{p:3},children:[(0,de.jsx)(u.A,{variant:"h6",sx:{mb:2,color:"white"},children:Ce?"Edit Text":"Add Text"}),(0,de.jsx)(h.A,{fullWidth:!0,multiline:!0,rows:3,placeholder:"Enter your text...",value:ke,onChange:e=>Pe(e.target.value),autoFocus:!0,sx:{mb:3,"& .MuiOutlinedInput-root":{color:"white",fontSize:"1.2rem","& fieldset":{borderColor:"rgba(255,255,255,0.3)"},"&:hover fieldset":{borderColor:"rgba(255,255,255,0.5)"},"&.Mui-focused fieldset":{borderColor:"primary.main"}}}}),(0,de.jsxs)(n.A,{sx:{display:"flex",gap:1,justifyContent:"flex-end"},children:[Ce&&(0,de.jsx)(z.A,{onClick:()=>{var e;e=Ce,we((o=>o.filter((o=>o.id!==e)))),Se(null),ye(!1)},color:"error",variant:"outlined",children:"Delete"}),(0,de.jsx)(z.A,{onClick:()=>{ye(!1),Se(null),Pe("")},sx:{color:"white"},children:"Cancel"}),(0,de.jsx)(z.A,{onClick:()=>{Ce?(so(Ce,{text:ke}),Se(null)):io(),ye(!1)},variant:"contained",color:"primary",disabled:!ke.trim(),children:Ce?"Update":"Add"})]})]})}),(0,de.jsx)(R.A,{open:He,onClose:()=>{Te(!1),Be(null)},PaperProps:{sx:{borderRadius:3,bgcolor:"#1c1c1e",color:"white",minWidth:300}},children:Ge&&(0,de.jsxs)(n.A,{sx:{p:2},children:[(0,de.jsxs)(n.A,{sx:{display:"flex",alignItems:"center",gap:2,mb:3,pb:2,borderBottom:"1px solid rgba(255,255,255,0.1)"},children:[(0,de.jsx)(v.A,{src:Ge.avatar,sx:{width:50,height:50},children:null===(p=Ge.username[0])||void 0===p?void 0:p.toUpperCase()}),(0,de.jsxs)(n.A,{children:[(0,de.jsx)(u.A,{variant:"h6",sx:{fontWeight:600},children:Ge.username}),(0,de.jsx)(u.A,{variant:"body2",sx:{color:"rgba(255,255,255,0.7)"},children:"Story viewer"})]})]}),(0,de.jsxs)(n.A,{sx:{display:"flex",flexDirection:"column",gap:1},children:[(0,de.jsxs)(z.A,{onClick:()=>{return e=Ge.id,Te(!1),Be(null),Me(!1),U(null),void g("/profile/".concat(e));var e},sx:{justifyContent:"flex-start",color:"white",textTransform:"none",py:1.5,px:2,borderRadius:2,"&:hover":{bgcolor:"rgba(255,255,255,0.1)"}},children:[(0,de.jsx)(u.A,{sx:{fontSize:18,mr:2},children:"\ud83d\udc64"}),"View Profile"]}),(0,de.jsxs)(z.A,{onClick:()=>{k&&(async(e,o)=>{if(m)try{const r=(0,V.H9)(J.db,"stories",o);await(0,V.mZ)(r,{hiddenFrom:(0,V.hq)(e)}),K("Story hidden from user"),Te(!1),Be(null),k&&await $e(k.stories[M].id)}catch(Y){console.error("Error hiding story:",Y),Z("Failed to hide story")}})(Ge.id,k.stories[M].id)},sx:{justifyContent:"flex-start",color:"white",textTransform:"none",py:1.5,px:2,borderRadius:2,"&:hover":{bgcolor:"rgba(255,255,255,0.1)"}},children:[(0,de.jsx)(u.A,{sx:{fontSize:18,mr:2},children:"\ud83d\ude48"}),"Hide Story From This User"]}),(0,de.jsxs)(z.A,{onClick:()=>(async e=>{if(m)try{await b(e),K("User blocked successfully"),Te(!1),Be(null),k&&await $e(k.stories[M].id)}catch(Y){console.error("Error blocking user:",Y),Z("Failed to block user")}})(Ge.id),sx:{justifyContent:"flex-start",color:"#ff3b30",textTransform:"none",py:1.5,px:2,borderRadius:2,"&:hover":{bgcolor:"rgba(255, 59, 48, 0.1)"}},children:[(0,de.jsx)(u.A,{sx:{fontSize:18,mr:2},children:"\ud83d\udeab"}),"Block User"]})]}),(0,de.jsx)(n.A,{sx:{mt:3,pt:2,borderTop:"1px solid rgba(255,255,255,0.1)"},children:(0,de.jsx)(z.A,{onClick:()=>{Te(!1),Be(null)},fullWidth:!0,variant:"outlined",sx:{color:"white",borderColor:"rgba(255,255,255,0.3)",py:1.5,borderRadius:2,"&:hover":{borderColor:"rgba(255,255,255,0.5)",bgcolor:"rgba(255,255,255,0.05)"}},children:"Cancel"})})]})}),(0,de.jsx)(R.A,{open:Fe,onClose:()=>Le(!1),PaperProps:{sx:{borderRadius:3,bgcolor:"#1c1c1e",color:"white"}},children:(0,de.jsxs)(n.A,{sx:{p:3,textAlign:"center"},children:[(0,de.jsx)(u.A,{sx:{fontSize:48,mb:2},children:"\ud83d\uddd1\ufe0f"}),(0,de.jsx)(u.A,{variant:"h6",sx:{mb:2,fontWeight:600},children:"Delete Story?"}),(0,de.jsx)(u.A,{variant:"body2",sx:{color:"rgba(255,255,255,0.7)",mb:3,lineHeight:1.5},children:"This story will be permanently deleted and removed from your profile."}),(0,de.jsxs)(n.A,{sx:{display:"flex",gap:2,justifyContent:"center"},children:[(0,de.jsx)(z.A,{onClick:()=>Le(!1),variant:"outlined",sx:{color:"white",borderColor:"rgba(255,255,255,0.3)",px:3,py:1,borderRadius:2,"&:hover":{borderColor:"rgba(255,255,255,0.5)",bgcolor:"rgba(255,255,255,0.05)"}},children:"Cancel"}),(0,de.jsx)(z.A,{onClick:()=>{k&&k.stories[M]&&(async e=>{if(m)try{await(0,V.kd)((0,V.H9)(J.db,"stories",e)),Me(!1),U(null),Le(!1),K("Story deleted successfully!"),setTimeout((async()=>{await Ke()}),500)}catch(Y){console.error("Error deleting story:",Y),Z("Failed to delete story")}})(k.stories[M].id)},variant:"contained",sx:{bgcolor:"#ff3b30",color:"white",px:3,py:1,borderRadius:2,"&:hover":{bgcolor:"#d70015"}},children:"Delete"})]})]})}),(0,de.jsx)(oe.A,{open:!!Y,autoHideDuration:6e3,onClose:()=>Z(null),children:(0,de.jsx)(re.A,{severity:"error",onClose:()=>Z(null),children:Y})}),(0,de.jsx)(oe.A,{open:!!X,autoHideDuration:6e3,onClose:()=>K(null),children:(0,de.jsx)(re.A,{severity:"success",onClose:()=>K(null),children:X})})]})},ue=()=>{var e;const[o,r]=(0,i.useState)(0),[Z,X]=(0,i.useState)(""),[ee,oe]=(0,i.useState)([]),[re,te]=(0,i.useState)([]),[ie,se]=(0,i.useState)(!0),[ae,ne]=(0,i.useState)(new Set),[le,ue]=(0,i.useState)(new Set),he=(0,N.Zp)(),{currentUser:xe}=(0,q.As)(),[pe,me]=(0,i.useState)(null),be=(0,s.A)(),ge=(0,a.A)(be.breakpoints.down("sm")),[ve,fe]=(0,i.useState)(!1),[Ae,ye]=(0,i.useState)([]),[je,we]=(0,i.useState)(!1),Ce=i.useRef(null),[Se,ke]=(0,i.useState)("All"),[Pe,Ie]=(0,i.useState)(!1),[ze,Re]=(0,i.useState)(!1),[Ue,Ee]=(0,i.useState)(null),[Me,We]=(0,i.useState)(null),[De,Fe]=(0,i.useState)([]),[Le,Ge]=(0,i.useState)([]),[Be,He]=(0,i.useState)(""),[Te,Oe]=(0,i.useState)("All"),[_e,Ne]=(0,i.useState)(!1),[Ve,Je]=(0,i.useState)([]),[qe,Ye]=(0,i.useState)([]),[Ze,Xe]=(0,i.useState)(""),[Ke,Qe]=(0,i.useState)("All"),[$e,eo]=(0,i.useState)(!1),[oo,ro]=(0,i.useState)(!1),to=["ASMR","Just Chatting","Music","Gossip","Podcasts","Shows","Social","Other"],io=async()=>{try{const e=(0,V.rJ)(J.db,"users"),o=(0,V.P)(e,(0,V.My)("createdAt","desc"),(0,V.AB)(20)),r=(await(0,V.GG)(o)).docs.filter((e=>"sideeye"!==e.id&&"contact-team"!==e.id)).map((e=>({id:e.id,username:e.data().username||"",name:e.data().name||"",profilePic:e.data().profilePic,bio:e.data().bio,coverPhoto:e.data().coverPhoto,isPublic:e.data().isPublic,isAuthenticated:e.data().isAuthenticated,createdAt:e.data().createdAt,isActive:e.data().isActive,isVerified:!0,email:e.data().email})));te(r)}catch(pe){console.error("Error fetching users:",pe)}finally{se(!1)}},so=async()=>{try{if(se(!0),!J.db)return;const e=await(async()=>{if(!xe||!J.db)return[];try{const e=(0,V.rJ)(J.db,"users"),o=await(0,V.GG)(e),r=[];return o.forEach((e=>{const o=e.data();o.blockedUsers&&Array.isArray(o.blockedUsers)&&o.blockedUsers.includes(xe.uid)&&r.push(e.id)})),[...xe.blockedUsers||[],...r]}catch(pe){return console.error("Error fetching blocked users:",pe),[]}})(),o=(0,V.rJ)(J.db,"sideRooms"),r=(0,V.P)(o,(0,V._M)("deleted","!=",!0)),i=await(0,V.GG)(r),s=i.docs.map((e=>{const o=e.data();return(0,t.A)({id:e.id},o)})).filter((o=>!e.includes(o.ownerId))),a=await Promise.all(s.map((async e=>{try{var o,r;const t=await(0,V.x7)((0,V.H9)(J.db,"users",e.ownerId)),i=t.exists()?t.data():null;return{id:e.id,name:e.name||"",description:e.description||"",memberCount:e.memberCount||0,shareCount:0,isPrivate:e.isPrivate||!1,createdAt:(null===(o=e.createdAt)||void 0===o?void 0:o.toDate())||new Date,creatorName:(null===i||void 0===i?void 0:i.username)||"Unknown",creatorId:e.ownerId,creatorAvatar:(null===i||void 0===i?void 0:i.profilePic)||"",tags:e.tags||[],lastActive:(null===(r=e.lastActive)||void 0===r?void 0:r.toDate())||new Date,maxMembers:e.maxMembers||100,activeUsers:e.activeUsers||0,isLive:e.isLive||!1,thumbnailUrl:e.thumbnailUrl||"",isPopular:(e.activeUsers||0)>=200}}catch(pe){return console.error("Error fetching owner data for room ".concat(e.id,":"),pe),null}}))),n=a.filter((e=>null!==e)).sort(((e,o)=>e.isPopular&&!o.isPopular?-1:!e.isPopular&&o.isPopular?1:(o.activeUsers||0)-(e.activeUsers||0)));oe(n)}catch(pe){console.error("Error fetching rooms:",pe)}finally{se(!1)}};(0,i.useEffect)((()=>{io(),so(),(async()=>{try{const e=(0,V.rJ)(J.db,"sideRooms"),o=await(0,V.GG)(e),r=new Map;o.docs.forEach((e=>{const o=e.data(),t=o.ownerId,i=o.activeUsers||0;if(r.has(t)){const e=r.get(t);e.totalViews+=i,e.activeRooms+=1}else r.set(t,{totalViews:i,activeRooms:1})}));const t=Array.from(r.entries()).filter((e=>{let[o,r]=e;return r.totalViews>=200})).map((e=>{let[o]=e;return o})),i=await Promise.all(t.map((async e=>{const o=(0,V.H9)(J.db,"users",e),t=await(0,V.x7)(o);if(t.exists()){var i;const o=t.data(),s=r.get(e);return{id:e,username:o.username||"",name:o.name||"",profilePic:o.profilePic,bio:o.bio,isPublic:null===(i=o.isPublic)||void 0===i||i,isAuthenticated:o.isAuthenticated,createdAt:o.createdAt,isActive:o.isActive,isVerified:!0,isTopHost:!0,totalViews:s.totalViews,activeRooms:s.activeRooms}}return null})));Fe(i.filter(Boolean))}catch(pe){console.error("Error fetching top hosts:",pe)}})(),(async()=>{try{const e=(0,V.rJ)(J.db,"sideRooms"),o=(0,V.P)(e,(0,V._M)("deleted","!=",!0)),r=(await(0,V.GG)(o)).docs.map((e=>{const o=e.data();return(0,t.A)({id:e.id},o)})).filter((e=>(e.activeUsers||0)>=200)),i=await Promise.all(r.map((async e=>{try{var o,r;const t=await(0,V.x7)((0,V.H9)(J.db,"users",e.ownerId)),i=t.exists()?t.data():null;return{id:e.id,name:e.name||"",description:e.description||"",memberCount:e.memberCount||0,shareCount:0,isPrivate:e.isPrivate||!1,createdAt:(null===(o=e.createdAt)||void 0===o?void 0:o.toDate())||new Date,creatorName:(null===i||void 0===i?void 0:i.username)||"Unknown",creatorId:e.ownerId,creatorAvatar:(null===i||void 0===i?void 0:i.profilePic)||"",tags:e.tags||[],lastActive:(null===(r=e.lastActive)||void 0===r?void 0:r.toDate())||new Date,maxMembers:e.maxMembers||100,activeUsers:e.activeUsers||0,isLive:e.isLive||!1,thumbnailUrl:e.thumbnailUrl||"",isPopular:!0}}catch(pe){return console.error("Error fetching owner data for room ".concat(e.id,":"),pe),null}}))),s=i.filter((e=>null!==e));Je(s),Ye(s)}catch(pe){console.error("Error fetching popular rooms:",pe)}})();const e=async()=>{xe&&(await ao(),await no())};e();const o=()=>{e()};return window.addEventListener("focus",o),()=>{window.removeEventListener("focus",o)}}),[xe]),(0,i.useEffect)((()=>{xe&&ae.size>0&&no()}),[ae]);const ao=async()=>{if(xe&&J.db)try{const e=(0,V.P)((0,V.rJ)(J.db,"users/".concat(xe.uid,"/following"))),o=await(0,V.GG)(e),r=new Set(o.docs.map((e=>e.id))),t=(0,V.P)((0,V.rJ)(J.db,"users")),i=await(0,V.GG)(t);await Promise.all(i.docs.map((async e=>{if(r.has(e.id))return;const o=(0,V.H9)(J.db,"users/".concat(e.id,"/followers/").concat(xe.uid));if((await(0,V.x7)(o)).exists()){r.add(e.id);const o=(0,V.H9)(J.db,"users/".concat(xe.uid,"/following/").concat(e.id));(await(0,V.x7)(o)).exists()||(await(0,V.BN)(o,{timestamp:(0,V.O5)()}),console.log("Fixed inconsistent follow status for user ".concat(e.id)))}}))),ne(r)}catch(pe){console.error("Error fetching following:",pe)}},no=async()=>{if(xe&&J.db)try{const e=new Set,o=(0,V.P)((0,V.rJ)(J.db,"users"),(0,V._M)("isPrivate","==",!0)),r=await(0,V.GG)(o);await Promise.all(r.docs.map((async o=>{if(ae.has(o.id))return;const r=(0,V.H9)(J.db,"users/".concat(o.id,"/followRequests/").concat(xe.uid));(await(0,V.x7)(r)).exists()&&e.add(o.id)})));const t=(0,V.P)((0,V.rJ)(J.db,"users"),(0,V._M)("isPublic","==",!1)),i=await(0,V.GG)(t);await Promise.all(i.docs.map((async o=>{if(ae.has(o.id)||e.has(o.id))return;const r=(0,V.H9)(J.db,"users/".concat(o.id,"/followRequests/").concat(xe.uid));(await(0,V.x7)(r)).exists()&&e.add(o.id)}))),ue(e)}catch(pe){console.error("Error fetching pending requests:",pe)}},lo=async e=>{if(!J.db||!e)return null;try{const o=(0,V.rJ)(J.db,"rooms"),r=(0,V.P)(o,(0,V._M)("createdBy","==",e),(0,V._M)("type","==","public")),t=await(0,V.GG)(r);if(!t.empty){const o=t.docs[0],r=(0,V.H9)(J.db,"users",e),i=await(0,V.x7)(r);return i.exists()&&We({username:i.data().username||i.data().name}),{id:o.id,name:o.data().name||"Chat Room"}}return null}catch(pe){return console.error("[Discover] Error checking for server chat room:",pe),null}},co=()=>{Re(!1)},uo=async e=>{if(xe&&e!==xe.uid)try{const i=(0,V.H9)(J.db,"users/".concat(xe.uid,"/following"),e),s=(0,V.H9)(J.db,"users/".concat(e,"/followers"),xe.uid);if(ae.has(e))await(0,V.kd)(i),await(0,V.kd)(s),ne((o=>{const r=new Set(o);return r.delete(e),r})),Y.oR.success("Unfollowed user");else{const a=await(async e=>{if(!J.db)return!1;try{const o=(0,V.H9)(J.db,"users",e),r=await(0,V.x7)(o);if(r.exists()){const e=r.data();return!0===e.isPrivate||!1===e.isPublic}return!1}catch(pe){return console.error("Error checking if account is private:",pe),!1}})(e);if(a){var o;const r=(0,V.H9)(J.db,"users",e,"followRequests",xe.uid);await(0,V.BN)(r,{userId:xe.uid,username:xe.displayName||(null===(o=xe.email)||void 0===o?void 0:o.split("@")[0])||"User_".concat(xe.uid.substring(0,5)),timestamp:(0,V.O5)()}),ue((o=>new Set(o).add(e))),Y.oR.success("Follow request sent")}else{var r,t;await(0,V.BN)(i,{timestamp:(0,V.O5)()}),await(0,V.BN)(s,{timestamp:(0,V.O5)()}),ne((o=>new Set(o).add(e)));const o={type:"follow",senderId:xe.uid,senderName:xe.displayName||(null===(r=xe.email)||void 0===r?void 0:r.split("@")[0])||"Someone",senderAvatar:xe.photoURL||"",recipientId:e,content:"".concat(xe.displayName||(null===(t=xe.email)||void 0===t?void 0:t.split("@")[0])||"Someone"," started following you"),createdAt:(0,V.O5)(),isRead:!1};await(0,V.gS)((0,V.rJ)(J.db,"notifications"),o);const a=await lo(e);a&&(Ee(a),Re(!0)),Y.oR.success("Followed user")}}}catch(pe){console.error("Error toggling follow:",pe),Y.oR.error("Failed to update follow status")}},ho=e=>{he("/side-room/".concat(e))},xo=async function(e){if(X(e),""===e.trim())return te([]),oe([]),void fe(!1);try{se(!0),fe(!0);const o=(null===xe||void 0===xe?void 0:xe.blockedUsers)||[],r=[];if(xe&&J.db){(await(0,V.GG)((0,V.rJ)(J.db,"users"))).forEach((e=>{const o=e.data();o.blockedUsers&&Array.isArray(o.blockedUsers)&&o.blockedUsers.includes(xe.uid)&&r.push(e.id)}))}const i=[...o,...r];let s=[];const a=(0,V.rJ)(J.db,"users"),n=e.toLowerCase();try{const e=(0,V.P)(a,(0,V.My)("username_lower"),(0,V.EO)(n),(0,V.FD)(n+"\uf8ff"),(0,V.AB)(20)),o=await(0,V.GG)(e);s=o.docs.map((e=>{var o;return{id:e.id,username:e.data().username||"",name:e.data().name||"",bio:e.data().bio||"",profilePic:e.data().profilePic||"",isPublic:null===(o=e.data().isPublic)||void 0===o||o,isAuthenticated:e.data().isAuthenticated,createdAt:e.data().createdAt,isActive:e.data().isActive,isVerified:!0,email:e.data().email}})).filter((e=>!i.includes(e.id)&&"sideeye"!==e.id&&"contact-team"!==e.id))}catch(pe){console.error("Error searching by username_lower:",pe)}if(s.length<10)try{const e=(0,V.P)(a,(0,V.My)("name_lower"),(0,V.EO)(n),(0,V.FD)(n+"\uf8ff"),(0,V.AB)(20)),o=(await(0,V.GG)(e)).docs.map((e=>{var o;return{id:e.id,username:e.data().username||"",name:e.data().name||"",bio:e.data().bio||"",profilePic:e.data().profilePic||"",isPublic:null===(o=e.data().isPublic)||void 0===o||o,isAuthenticated:e.data().isAuthenticated,createdAt:e.data().createdAt,isActive:e.data().isActive,isVerified:!0,email:e.data().email}})).filter((e=>!i.includes(e.id)&&"sideeye"!==e.id&&"contact-team"!==e.id&&!s.some((o=>o.id===e.id))));s=[...s,...o]}catch(pe){console.error("Error searching by name_lower:",pe)}if(0===s.length){console.log("Falling back to simple search approach");const e=(0,V.P)(a,(0,V.AB)(50)),o=await(0,V.GG)(e);s=o.docs.map((e=>{var o;return{id:e.id,username:e.data().username||"",name:e.data().name||"",bio:e.data().bio||"",profilePic:e.data().profilePic||"",isPublic:null===(o=e.data().isPublic)||void 0===o||o,isAuthenticated:e.data().isAuthenticated,createdAt:e.data().createdAt,isActive:e.data().isActive,isVerified:!0,email:e.data().email}})).filter((e=>!i.includes(e.id)&&"sideeye"!==e.id&&"contact-team"!==e.id&&(e.username.toLowerCase().includes(n)||e.name.toLowerCase().includes(n))))}const l=(0,V.rJ)(J.db,"sideRooms");let d=[];try{const o=(0,V.P)(l,(0,V._M)("name",">=",e),(0,V._M)("name","<=",e+"\uf8ff"),(0,V.AB)(20)),r=await(0,V.GG)(o);if(d=r.docs.map((e=>(0,t.A)({id:e.id},e.data()))),d.length<5){const e=(0,V.P)(l,(0,V._M)("deleted","!=",!0),(0,V.AB)(50)),o=(await(0,V.GG)(e)).docs.map((e=>(0,t.A)({id:e.id},e.data()))).filter((e=>!d.some((o=>o.id===e.id))&&(e.name.toLowerCase().includes(n)||e.description&&e.description.toLowerCase().includes(n)||e.tags&&e.tags.some((e=>e.toLowerCase().includes(n))))));d=[...d,...o]}}catch(pe){console.error("Error searching rooms:",pe)}d=d.filter((e=>e.ownerId&&!i.includes(e.ownerId)));const c=await Promise.all(d.map((async e=>{try{var o,r;const t=await(0,V.x7)((0,V.H9)(J.db,"users",e.ownerId)),i=t.exists()?t.data():null;return{id:e.id,name:e.name,description:e.description,memberCount:e.memberCount||0,shareCount:0,isPrivate:e.isPrivate||!1,createdAt:(null===(o=e.createdAt)||void 0===o?void 0:o.toDate())||new Date,creatorName:(null===i||void 0===i?void 0:i.username)||"Unknown",creatorId:e.ownerId,creatorAvatar:(null===i||void 0===i?void 0:i.profilePic)||"",tags:e.tags||[],lastActive:(null===(r=e.lastActive)||void 0===r?void 0:r.toDate())||new Date,maxMembers:e.maxMembers||100,activeUsers:e.activeUsers||0,isLive:e.isLive||!1,thumbnailUrl:e.thumbnailUrl||""}}catch(pe){var t,i;return console.error("Error fetching owner data for room ".concat(e.id,":"),pe),{id:e.id,name:e.name,description:e.description,memberCount:e.memberCount||0,shareCount:0,isPrivate:e.isPrivate||!1,createdAt:(null===(t=e.createdAt)||void 0===t?void 0:t.toDate())||new Date,creatorName:"Unknown",creatorId:e.ownerId,creatorAvatar:"",tags:e.tags||[],lastActive:(null===(i=e.lastActive)||void 0===i?void 0:i.toDate())||new Date,maxMembers:e.maxMembers||100,activeUsers:e.activeUsers||0,isLive:e.isLive||!1,thumbnailUrl:e.thumbnailUrl||""}}})));te(s),oe(c)}catch(pe){console.error("Error searching:",pe)}finally{se(!1)}};(0,i.useEffect)((()=>{if(null===xe||void 0===xe||!xe.uid||!J.db)return;const e=(0,V.rJ)(J.db,"users",xe.uid,"following"),o=(0,V.aQ)(e,(async e=>{e.docChanges().forEach((async e=>{if("added"===e.type){const o=e.doc.id;if(le.has(o)){const e=await lo(o);e&&(Ee(e),Re(!0),ue((e=>{const r=new Set(e);return r.delete(o),r})))}}}))}));return()=>o()}),[null===xe||void 0===xe?void 0:xe.uid,J.db,le]);(0,i.useEffect)((()=>{Ge(De)}),[De]);return ie&&!ve?(0,de.jsx)(n.A,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"80vh",children:(0,de.jsx)(l.A,{})}):(0,de.jsxs)(n.A,{sx:{position:"relative",backgroundColor:be.palette.background.default},children:[(0,de.jsx)(n.A,{sx:{position:"sticky",top:0,backgroundColor:be.palette.background.default,zIndex:1e3,pt:.5,pb:.5,borderBottom:1,borderColor:"divider"},children:(0,de.jsxs)(d.A,{maxWidth:!1,sx:{maxWidth:"1440px"},children:[(0,de.jsxs)(n.A,{sx:{mb:.5},children:[!oo&&!ve&&(0,de.jsx)(n.A,{sx:{display:"flex",justifyContent:"flex-end",mb:.5},children:(0,de.jsx)(c.A,{onClick:()=>ro(!0),sx:{bgcolor:"background.paper",border:"1px solid",borderColor:"divider","&:hover":{bgcolor:"action.hover"}},children:(0,de.jsx)(W.A,{})})}),(oo||ve)&&(0,de.jsx)(Q.x,{onClickAway:()=>{Z.trim()||(ro(!1),we(!1))},children:(0,de.jsxs)(n.A,{sx:{position:"relative",mb:.5,display:"flex",alignItems:"center",gap:1},children:[ve&&(0,de.jsx)(u.A,{variant:ge?"h6":"h5",component:"h1",sx:{fontWeight:600,mr:2},children:"Search Results"}),(0,de.jsxs)(n.A,{ref:Ce,sx:{flex:1},children:[(0,de.jsx)(h.A,{fullWidth:!0,size:"small",placeholder:"Search rooms and users...",value:Z,onChange:e=>{(async e=>{if(X(e),e.length<1)return ye([]),void we(!1);try{const o=e.toLowerCase(),r=(0,V.rJ)(J.db,"users"),t=e=>{var o,r,t,i,s,a,n,l,d,c;return{id:e.id,username:(null===(o=e.data())||void 0===o?void 0:o.username)||"",name:(null===(r=e.data())||void 0===r?void 0:r.name)||"",bio:null===(t=e.data())||void 0===t?void 0:t.bio,profilePic:null===(i=e.data())||void 0===i?void 0:i.profilePic,isPublic:null===(s=null===(a=e.data())||void 0===a?void 0:a.isPublic)||void 0===s||s,isAuthenticated:null===(n=e.data())||void 0===n?void 0:n.isAuthenticated,createdAt:null===(l=e.data())||void 0===l?void 0:l.createdAt,isActive:null===(d=e.data())||void 0===d?void 0:d.isActive,isVerified:!0,email:null===(c=e.data())||void 0===c?void 0:c.email}};let i=[];try{const e=(0,V.P)(r,(0,V.My)("username_lower"),(0,V.EO)(o),(0,V.FD)(o+"\uf8ff"),(0,V.AB)(10)),s=await(0,V.GG)(e);i=s.docs.filter((e=>"sideeye"!==e.id&&"contact-team"!==e.id)).map(t)}catch(pe){console.log("Error searching by username_lower:",pe)}if(i.length<5)try{const e=(0,V.P)(r,(0,V.My)("name_lower"),(0,V.EO)(o),(0,V.FD)(o+"\uf8ff"),(0,V.AB)(10)),s=(await(0,V.GG)(e)).docs.filter((e=>"sideeye"!==e.id&&"contact-team"!==e.id&&!i.some((o=>o.id===e.id)))).map(t);i=[...i,...s]}catch(pe){console.log("Error searching by name_lower:",pe)}if(i.length<3){const e=(0,V.P)(r,(0,V.AB)(25));try{const r=(await(0,V.GG)(e)).docs.filter((e=>{var r,t;return"sideeye"!==e.id&&"contact-team"!==e.id&&!i.some((o=>o.id===e.id))&&(((null===(r=e.data())||void 0===r?void 0:r.username)||"").toLowerCase().includes(o)||((null===(t=e.data())||void 0===t?void 0:t.name)||"").toLowerCase().includes(o))})).map(t);i=[...i,...r]}catch(pe){console.log("Error with fallback search:",pe)}}null!==xe&&void 0!==xe&&xe.blockedUsers&&(i=i.filter((e=>{var o;return!(null!==(o=xe.blockedUsers)&&void 0!==o&&o.includes(e.id))}))),ye(i.slice(0,5)),we(i.length>0)}catch(pe){console.error("Instant search error:",pe)}})(e.target.value),xo(e.target.value)},onKeyDown:e=>{"Enter"===e.key&&(xo(Z,!0),we(!1))},autoFocus:oo,InputProps:{startAdornment:(0,de.jsx)(x.A,{position:"start",children:(0,de.jsx)(W.A,{})}),endAdornment:(oo||ve)&&(0,de.jsx)(x.A,{position:"end",children:(0,de.jsx)(c.A,{size:"small",onClick:()=>{X(""),ro(!1),fe(!1),we(!1),te([]),oe([])},children:(0,de.jsx)(D.A,{fontSize:"small"})})})},sx:{backgroundColor:"background.paper",borderRadius:2,"& .MuiOutlinedInput-root":{borderRadius:2}}}),(0,de.jsx)($.A,{open:je&&Ae.length>0,anchorEl:Ce.current,placement:"bottom-start",style:{width:null===(e=Ce.current)||void 0===e?void 0:e.offsetWidth,zIndex:1400},children:(0,de.jsx)(p.A,{elevation:3,sx:{mt:1,maxHeight:"300px",overflowY:"auto",borderRadius:2},children:(0,de.jsx)(m.A,{sx:{p:0},children:Ae.map(((e,o)=>{var r,t;return(0,de.jsxs)(i.Fragment,{children:[(0,de.jsxs)(b.Ay,{button:!0,onClick:()=>{he("/profile/".concat(e.id)),we(!1)},sx:{py:1,px:2,"&:hover":{backgroundColor:"action.hover"}},children:[(0,de.jsx)(g.A,{children:(0,de.jsx)(v.A,{src:!1===e.isActive?void 0:e.profilePic,alt:e.name,sx:{width:32,height:32},children:!1===e.isActive||e.profilePic?null:null===(r=e.name)||void 0===r||null===(t=r[0])||void 0===t?void 0:t.toUpperCase()})}),(0,de.jsx)(f.A,{primary:(0,de.jsxs)(u.A,{variant:"body1",component:"div",children:[e.name,e.isVerified&&(0,de.jsx)(F.A,{sx:{ml:.5,color:"primary.main",fontSize:"0.9rem",verticalAlign:"middle"}})]}),secondary:(0,de.jsxs)(de.Fragment,{children:[(0,de.jsxs)(u.A,{variant:"body2",component:"span",color:"text.secondary",children:["@",e.username]}),e.bio&&(0,de.jsx)(u.A,{variant:"body2",component:"span",color:"text.secondary",sx:{mt:.5,display:"block",WebkitLineClamp:2,WebkitBoxOrient:"vertical",overflow:"hidden"},children:e.bio})]}),sx:{my:0}}),xe&&e.id!==xe.uid&&(0,de.jsxs)(n.A,{sx:{display:"flex",gap:1},children:[(0,de.jsx)(c.A,{size:"small",onClick:o=>{o.stopPropagation(),he("/messages/".concat(e.id))},children:(0,de.jsx)(L.A,{fontSize:"small"})}),(0,de.jsx)(c.A,{size:"small",onClick:o=>{o.stopPropagation(),le.has(e.id)||uo(e.id)},color:ae.has(e.id)?"primary":le.has(e.id)?"secondary":"default",disabled:le.has(e.id),children:(0,de.jsx)(G.A,{fontSize:"small"})})]})]}),o<Ae.length-1&&(0,de.jsx)(A.A,{})]},e.id)}))})})})]})]})})]}),!ve&&(0,de.jsx)(ce,{}),!ve&&(0,de.jsxs)(y.A,{value:o,onChange:(e,o)=>{r(o),1===o&&0===re.length&&io()},variant:ge?"scrollable":"standard",scrollButtons:!!ge&&"auto",sx:{mb:.5,"& .MuiTabs-indicator":{height:3}},children:[(0,de.jsx)(j.A,{icon:(0,de.jsx)(B.A,{}),label:"ROOMS",iconPosition:"start"}),(0,de.jsx)(j.A,{icon:(0,de.jsx)(H.A,{}),label:"PEOPLE",iconPosition:"start"}),(0,de.jsx)(j.A,{icon:(0,de.jsx)(T.A,{}),label:"TOP HOSTS",iconPosition:"start"}),(0,de.jsx)(j.A,{icon:(0,de.jsx)(O.A,{}),label:"POPULAR",iconPosition:"start"})]}),!ve&&0===o&&(0,de.jsxs)(y.A,{value:Se,onChange:(e,o)=>{ke(o),ve&&fe(!1)},variant:"scrollable",scrollButtons:"auto","aria-label":"room categories",sx:{mb:1,borderBottom:1,borderColor:"divider"},children:[(0,de.jsx)(j.A,{label:"All",value:"All"}),to.map((e=>(0,de.jsx)(j.A,{label:e,value:e},e)))]})]})}),(0,de.jsx)(d.A,{maxWidth:!1,sx:{pt:1,pb:4,px:ge?2:3,maxWidth:"1440px"},children:ve?(0,de.jsxs)(n.A,{sx:{display:"flex",flexDirection:"column",gap:4},children:[re.length>0&&(0,de.jsxs)(n.A,{children:[(0,de.jsx)(u.A,{variant:"h6",sx:{mb:2},children:"Users"}),(0,de.jsx)(m.A,{children:re.map(((e,o)=>{var r,t;return(0,de.jsxs)(i.Fragment,{children:[(0,de.jsxs)(b.Ay,{sx:{py:2,cursor:"pointer","&:hover":{backgroundColor:"action.hover"}},onClick:()=>he("/profile/".concat(e.id)),children:[(0,de.jsx)(g.A,{children:(0,de.jsx)(v.A,{src:!1===e.isActive?void 0:e.profilePic,alt:e.name,sx:{width:50,height:50},children:!1===e.isActive||e.profilePic?null:null===(r=e.name)||void 0===r||null===(t=r[0])||void 0===t?void 0:t.toUpperCase()})}),(0,de.jsx)(f.A,{primary:(0,de.jsxs)(u.A,{variant:"subtitle1",component:"div",sx:{fontWeight:600},children:[e.name,e.isVerified&&(0,de.jsx)(F.A,{sx:{ml:.5,color:"primary.main",fontSize:"1rem",verticalAlign:"middle"}})]}),secondary:(0,de.jsxs)(de.Fragment,{children:[(0,de.jsxs)(u.A,{variant:"body2",component:"span",color:"text.secondary",children:["@",e.username]}),e.bio&&(0,de.jsx)(u.A,{variant:"body2",component:"span",color:"text.secondary",sx:{mt:.5,display:"block",WebkitLineClamp:2,WebkitBoxOrient:"vertical",overflow:"hidden"},children:e.bio})]})}),xe&&e.id!==xe.uid&&(0,de.jsx)(w.A,{children:(0,de.jsxs)(n.A,{sx:{display:"flex",gap:1},children:[(0,de.jsx)(c.A,{onClick:o=>{o.stopPropagation(),he("/chat/".concat(e.id))},size:"small",children:(0,de.jsx)(L.A,{})}),(0,de.jsx)(c.A,{onClick:o=>{o.stopPropagation(),le.has(e.id)||uo(e.id)},size:"small",color:ae.has(e.id)?"primary":le.has(e.id)?"secondary":"default",disabled:le.has(e.id),children:(0,de.jsx)(G.A,{})})]})})]}),o<re.length-1&&(0,de.jsx)(A.A,{})]},e.id)}))})]}),ee.length>0&&(0,de.jsxs)(n.A,{children:[(0,de.jsx)(u.A,{variant:"h6",sx:{mb:2},children:"Rooms"}),(0,de.jsx)(C.Ay,{container:!0,spacing:3,children:ee.filter((e=>"All"===Se||e.tags&&e.tags.includes(Se))).map((e=>(0,de.jsx)(C.Ay,{item:!0,xs:12,sm:6,md:4,children:(0,de.jsxs)(S.A,{sx:{display:"flex",flexDirection:"column",cursor:"pointer",borderRadius:2,overflow:"hidden",boxShadow:be.shadows[3],"&:hover":{transform:"translateY(-4px)",transition:"transform 0.2s ease-in-out",boxShadow:be.shadows[6]}},onClick:()=>ho(e.id),children:[(0,de.jsxs)(n.A,{sx:{position:"relative"},children:[(0,de.jsx)(k.A,{component:"img",height:ge?"220":"280",image:e.thumbnailUrl||e.creatorAvatar||"https://placehold.co/600x400/333/666?text=Room",alt:e.name,sx:{objectFit:"cover",width:"100%"}}),(0,de.jsxs)(n.A,{sx:{position:"absolute",top:12,right:12,display:"flex",gap:1},children:[e.isPopular&&(0,de.jsx)(P.A,{label:"Popular",color:"warning",size:"small",icon:(0,de.jsx)(O.A,{}),sx:{fontWeight:"bold",fontSize:ge?"0.75rem":"0.875rem",height:"auto",padding:"6px 12px"}}),e.isLive&&(0,de.jsx)(P.A,{label:"LIVE",color:"error",size:"small",sx:{fontWeight:"bold",fontSize:ge?"0.75rem":"0.875rem",height:"auto",padding:"6px 12px"}})]})]}),(0,de.jsxs)(I.A,{sx:{flexGrow:1,p:3,"&:last-child":{pb:3}},children:[(0,de.jsxs)(n.A,{sx:{mb:2},children:[(0,de.jsx)(u.A,{gutterBottom:!0,variant:ge?"h6":"h5",component:"h2",noWrap:!0,sx:{fontWeight:600,mb:1},children:e.name}),(0,de.jsx)(u.A,{variant:"body1",color:"text.secondary",sx:{display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical",overflow:"hidden",mb:2,lineHeight:1.5},children:e.description})]}),(0,de.jsxs)(n.A,{sx:{display:"flex",alignItems:"center",gap:1.5,mb:2,flexWrap:"wrap"},children:[(0,de.jsx)(P.A,{icon:(0,de.jsx)(_.A,{sx:{fontSize:ge?"1.1rem":"1.25rem"}}),label:"".concat(e.activeUsers||0," views"),color:"primary",variant:"outlined",sx:{height:"auto",padding:"8px 12px","& .MuiChip-label":{padding:"0 4px",fontSize:ge?"0.875rem":"1rem"}}}),e.isPrivate&&(0,de.jsx)(P.A,{label:"Private",color:"secondary",sx:{height:"auto",padding:"8px 12px","& .MuiChip-label":{padding:"0 4px",fontSize:ge?"0.875rem":"1rem"}}})]}),(0,de.jsxs)(u.A,{variant:"body2",color:"text.secondary",sx:{fontSize:ge?"0.75rem":"0.875rem",display:"flex",alignItems:"center",gap:.5},children:["Created by ",e.creatorName||"Anonymous"," \u2022 ",K(e.lastActive)]})]})]})},e.id)))})]}),0===re.length&&0===ee.length&&!ie&&(0,de.jsxs)(n.A,{sx:{textAlign:"center",py:4},children:[(0,de.jsx)(u.A,{variant:"h6",color:"text.secondary",children:"No results found"}),(0,de.jsx)(u.A,{variant:"body2",color:"text.secondary",children:"Try different keywords or check your spelling"})]})]}):0===o?(0,de.jsx)(C.Ay,{container:!0,spacing:3,children:ee.filter((e=>"All"===Se||e.tags&&e.tags.includes(Se))).map((e=>(0,de.jsx)(C.Ay,{item:!0,xs:12,sm:6,md:4,children:(0,de.jsxs)(S.A,{sx:{display:"flex",flexDirection:"column",cursor:"pointer",borderRadius:2,overflow:"hidden",boxShadow:be.shadows[3],"&:hover":{transform:"translateY(-4px)",transition:"transform 0.2s ease-in-out",boxShadow:be.shadows[6]}},onClick:()=>ho(e.id),children:[(0,de.jsxs)(n.A,{sx:{position:"relative"},children:[(0,de.jsx)(k.A,{component:"img",height:ge?"220":"280",image:e.thumbnailUrl||e.creatorAvatar||"https://placehold.co/600x400/333/666?text=Room",alt:e.name,sx:{objectFit:"cover",width:"100%"}}),(0,de.jsxs)(n.A,{sx:{position:"absolute",top:12,right:12,display:"flex",gap:1},children:[e.isPopular&&(0,de.jsx)(P.A,{label:"Popular",color:"warning",size:"small",icon:(0,de.jsx)(O.A,{}),sx:{fontWeight:"bold",fontSize:ge?"0.75rem":"0.875rem",height:"auto",padding:"6px 12px"}}),e.isLive&&(0,de.jsx)(P.A,{label:"LIVE",color:"error",size:"small",sx:{fontWeight:"bold",fontSize:ge?"0.75rem":"0.875rem",height:"auto",padding:"6px 12px"}})]})]}),(0,de.jsxs)(I.A,{sx:{flexGrow:1,p:3,"&:last-child":{pb:3}},children:[(0,de.jsxs)(n.A,{sx:{mb:2},children:[(0,de.jsx)(u.A,{gutterBottom:!0,variant:ge?"h6":"h5",component:"h2",noWrap:!0,sx:{fontWeight:600,mb:1},children:e.name}),(0,de.jsx)(u.A,{variant:"body1",color:"text.secondary",sx:{display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical",overflow:"hidden",mb:2,lineHeight:1.5},children:e.description})]}),(0,de.jsxs)(n.A,{sx:{display:"flex",alignItems:"center",gap:1.5,mb:2,flexWrap:"wrap"},children:[(0,de.jsx)(P.A,{icon:(0,de.jsx)(_.A,{sx:{fontSize:ge?"1.1rem":"1.25rem"}}),label:"".concat(e.activeUsers||0," views"),color:"primary",variant:"outlined",sx:{height:"auto",padding:"8px 12px","& .MuiChip-label":{padding:"1 4px",fontSize:ge?"0.875rem":"1rem"}}}),e.isPrivate&&(0,de.jsx)(P.A,{label:"Private",color:"secondary",sx:{height:"auto",padding:"8px 12px","& .MuiChip-label":{padding:"0 4px",fontSize:ge?"0.875rem":"1rem"}}})]}),(0,de.jsxs)(u.A,{variant:"body2",color:"text.secondary",sx:{fontSize:ge?"0.75rem":"0.875rem",display:"flex",alignItems:"center",gap:.5},children:["Created by ",e.creatorName||"Anonymous"," \u2022 ",K(e.lastActive)]})]})]})},e.id)))}):1===o?(0,de.jsx)(n.A,{sx:{mt:2},children:ie?(0,de.jsx)(n.A,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"50vh",children:(0,de.jsx)(l.A,{})}):re.length>0?(0,de.jsx)(m.A,{children:re.map(((e,o)=>{var r,t;return(0,de.jsxs)(i.Fragment,{children:[(0,de.jsxs)(b.Ay,{sx:{py:3,px:2,cursor:"pointer","&:hover":{backgroundColor:"action.hover"},borderRadius:1,mb:1},onClick:()=>he("/profile/".concat(e.id)),children:[(0,de.jsx)(g.A,{children:(0,de.jsx)(v.A,{src:!1===e.isActive?void 0:e.profilePic,alt:e.name,sx:{width:60,height:60,mr:2},children:!1===e.isActive||e.profilePic?null:null===(r=e.name)||void 0===r||null===(t=r[0])||void 0===t?void 0:t.toUpperCase()})}),(0,de.jsx)(f.A,{primary:(0,de.jsxs)(u.A,{variant:"subtitle1",component:"div",sx:{fontWeight:600},children:[e.name,e.isVerified&&(0,de.jsx)(F.A,{sx:{ml:.5,color:"primary.main",fontSize:"1rem",verticalAlign:"middle"}})]}),secondary:(0,de.jsxs)(de.Fragment,{children:[(0,de.jsxs)(u.A,{variant:"body2",component:"span",color:"text.secondary",children:["@",e.username]}),e.bio&&(0,de.jsx)(u.A,{variant:"body2",component:"span",color:"text.secondary",sx:{mt:.5,display:"block",WebkitLineClamp:2,WebkitBoxOrient:"vertical",overflow:"hidden"},children:e.bio})]}),sx:{ml:2}}),xe&&e.id!==xe.uid&&(0,de.jsx)(w.A,{sx:{right:16},children:(0,de.jsxs)(n.A,{sx:{display:"flex",gap:1,flexWrap:{xs:"wrap",sm:"nowrap"}},children:[(0,de.jsx)(c.A,{color:"primary",size:"small",onClick:o=>{o.stopPropagation(),he("/chat/user/".concat(e.id))},sx:{border:"1px solid",borderColor:"primary.main",p:1},children:(0,de.jsx)(L.A,{fontSize:"small"})}),(0,de.jsx)(z.A,{variant:ae.has(e.id)||le.has(e.id)?"contained":"outlined",size:"small",startIcon:ae.has(e.id)||le.has(e.id)?null:(0,de.jsx)(G.A,{}),onClick:o=>{o.stopPropagation(),le.has(e.id)||uo(e.id)},color:le.has(e.id)?"secondary":"primary",disabled:le.has(e.id),children:ae.has(e.id)?"Following":le.has(e.id)?"Requested":"Follow"})]})})]}),o<re.length-1&&(0,de.jsx)(A.A,{sx:{my:1}})]},e.id)}))}):(0,de.jsx)(n.A,{sx:{textAlign:"center",py:4},children:(0,de.jsx)(u.A,{variant:"h6",color:"text.secondary",children:"No users found"})})}):2===o?(0,de.jsxs)(n.A,{sx:{mt:2},children:[(0,de.jsx)(n.A,{sx:{mb:3},children:(0,de.jsxs)(C.Ay,{container:!0,spacing:2,alignItems:"center",children:[(0,de.jsx)(C.Ay,{item:!0,xs:12,md:6,children:(0,de.jsx)(h.A,{fullWidth:!0,size:"small",placeholder:"Search top hosts...",value:Be,onChange:e=>{He(e.target.value),(async e=>{if(e.trim()){Ne(!0);try{const o=e.toLowerCase(),r=(0,V.rJ)(J.db,"users"),i=(0,V.P)(r,(0,V._M)("username_lower",">=",o),(0,V._M)("username_lower","<=",o+"\uf8ff"),(0,V.AB)(20)),s=(await(0,V.GG)(i)).docs.map((e=>(0,t.A)({id:e.id},e.data()))).filter((e=>De.some((o=>o.id===e.id))));Ge(s)}catch(pe){console.error("Error searching top hosts:",pe),Ge([])}finally{Ne(!1)}}else Ge(De)})(e.target.value)},InputProps:{startAdornment:(0,de.jsx)(x.A,{position:"start",children:(0,de.jsx)(W.A,{})})},sx:{backgroundColor:"background.paper",borderRadius:1,"& .MuiOutlinedInput-root":{borderRadius:1}}})}),(0,de.jsx)(C.Ay,{item:!0,xs:12,md:6,children:(0,de.jsxs)(y.A,{value:Te,onChange:(e,o)=>(e=>{if(Oe(e),"All"===e)return void Ge(De);const o=De.filter((o=>ee.filter((e=>e.creatorId===o.id)).some((o=>{var r;return null===(r=o.tags)||void 0===r?void 0:r.includes(e)}))));Ge(o)})(o),variant:"scrollable",scrollButtons:"auto","aria-label":"top host categories",sx:{borderBottom:1,borderColor:"divider"},children:[(0,de.jsx)(j.A,{label:"All",value:"All"}),to.map((e=>(0,de.jsx)(j.A,{label:e,value:e},e)))]})})]})}),ie||_e?(0,de.jsx)(n.A,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"50vh",children:(0,de.jsx)(l.A,{})}):Le.length>0?(0,de.jsx)(m.A,{children:Le.map(((e,o)=>{var r,t,s;return(0,de.jsxs)(i.Fragment,{children:[(0,de.jsxs)(b.Ay,{sx:{py:3,px:2,cursor:"pointer","&:hover":{backgroundColor:"action.hover"},borderRadius:1,mb:1,position:"relative"},children:[(0,de.jsx)(g.A,{children:(0,de.jsx)(v.A,{src:!1===e.isActive?void 0:e.profilePic,alt:e.name,sx:{width:60,height:60,mr:2,cursor:"pointer","&:hover":{opacity:.8}},onClick:()=>he("/profile/".concat(e.id)),children:!1===e.isActive||e.profilePic?null:null===(r=e.name)||void 0===r||null===(t=r[0])||void 0===t?void 0:t.toUpperCase()})}),(0,de.jsx)(f.A,{primary:(0,de.jsxs)(n.A,{sx:{display:"flex",alignItems:"center",gap:1},children:[(0,de.jsxs)(u.A,{variant:"subtitle1",component:"div",sx:{fontWeight:600},children:[e.name,e.isVerified&&(0,de.jsx)(F.A,{sx:{ml:.5,color:"primary.main",fontSize:"1rem",verticalAlign:"middle"}})]}),(0,de.jsx)(P.A,{label:"Top Host",color:"warning",size:"small",icon:(0,de.jsx)(T.A,{}),sx:{height:"auto","& .MuiChip-label":{px:1}}})]}),secondary:(0,de.jsxs)(de.Fragment,{children:[(0,de.jsxs)(u.A,{variant:"body2",component:"span",color:"text.secondary",children:["@",e.username]}),(0,de.jsxs)(n.A,{sx:{mt:1,display:"flex",gap:2},children:[(0,de.jsxs)(u.A,{variant:"body2",color:"text.secondary",children:[null===(s=e.totalViews)||void 0===s?void 0:s.toLocaleString()," total views"]}),(0,de.jsxs)(u.A,{variant:"body2",color:"text.secondary",children:[e.activeRooms," active rooms"]})]}),e.bio&&(0,de.jsx)(u.A,{variant:"body2",component:"span",color:"text.secondary",sx:{mt:.5,display:"block",WebkitLineClamp:2,WebkitBoxOrient:"vertical",overflow:"hidden"},children:e.bio})]}),sx:{ml:2}}),xe&&e.id!==xe.uid&&(0,de.jsx)(w.A,{sx:{right:16},children:(0,de.jsx)(z.A,{variant:ae.has(e.id)||le.has(e.id)?"contained":"outlined",size:"small",startIcon:ae.has(e.id)||le.has(e.id)?null:(0,de.jsx)(G.A,{}),onClick:o=>{o.stopPropagation(),le.has(e.id)||uo(e.id)},color:le.has(e.id)?"secondary":"primary",disabled:le.has(e.id),children:ae.has(e.id)?"Following":le.has(e.id)?"Requested":"Follow"})})]}),o<Le.length-1&&(0,de.jsx)(A.A,{sx:{my:1}})]},e.id)}))}):(0,de.jsxs)(n.A,{sx:{textAlign:"center",py:4},children:[(0,de.jsx)(u.A,{variant:"h6",color:"text.secondary",children:Be?"No matching top hosts found":"No top hosts found"}),Be&&(0,de.jsx)(u.A,{variant:"body2",color:"text.secondary",sx:{mt:1},children:"Try different keywords or check your spelling"})]})]}):(0,de.jsxs)(n.A,{sx:{mt:2},children:[(0,de.jsx)(n.A,{sx:{mb:3},children:(0,de.jsxs)(C.Ay,{container:!0,spacing:2,alignItems:"center",children:[(0,de.jsx)(C.Ay,{item:!0,xs:12,md:6,children:(0,de.jsx)(h.A,{fullWidth:!0,size:"small",placeholder:"Search popular rooms...",value:Ze,onChange:e=>{Xe(e.target.value),(async e=>{if(e.trim()){eo(!0);try{const o=e.toLowerCase(),r=Ve.filter((e=>e.name.toLowerCase().includes(o)||e.description.toLowerCase().includes(o)||e.creatorName.toLowerCase().includes(o)));Ye(r)}catch(pe){console.error("Error searching popular rooms:",pe),Ye([])}finally{eo(!1)}}else Ye(Ve)})(e.target.value)},InputProps:{startAdornment:(0,de.jsx)(x.A,{position:"start",children:(0,de.jsx)(W.A,{})})},sx:{backgroundColor:"background.paper",borderRadius:1,"& .MuiOutlinedInput-root":{borderRadius:1}}})}),(0,de.jsx)(C.Ay,{item:!0,xs:12,md:6,children:(0,de.jsxs)(y.A,{value:Ke,onChange:(e,o)=>(e=>{if(Qe(e),"All"===e)return void Ye(Ve);const o=Ve.filter((o=>{var r;return null===(r=o.tags)||void 0===r?void 0:r.includes(e)}));Ye(o)})(o),variant:"scrollable",scrollButtons:"auto","aria-label":"popular room categories",sx:{borderBottom:1,borderColor:"divider"},children:[(0,de.jsx)(j.A,{label:"All",value:"All"}),to.map((e=>(0,de.jsx)(j.A,{label:e,value:e},e)))]})})]})}),ie||$e?(0,de.jsx)(n.A,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"50vh",children:(0,de.jsx)(l.A,{})}):qe.length>0?(0,de.jsx)(C.Ay,{container:!0,spacing:3,children:qe.map((e=>(0,de.jsx)(C.Ay,{item:!0,xs:12,sm:6,md:4,children:(0,de.jsxs)(S.A,{sx:{display:"flex",flexDirection:"column",cursor:"pointer",borderRadius:2,overflow:"hidden",boxShadow:be.shadows[3],"&:hover":{transform:"translateY(-4px)",transition:"transform 0.2s ease-in-out",boxShadow:be.shadows[6]}},onClick:()=>ho(e.id),children:[(0,de.jsxs)(n.A,{sx:{position:"relative"},children:[(0,de.jsx)(k.A,{component:"img",height:ge?"220":"280",image:e.thumbnailUrl||e.creatorAvatar||"https://placehold.co/600x400/333/666?text=Room",alt:e.name,sx:{objectFit:"cover",width:"100%"}}),(0,de.jsxs)(n.A,{sx:{position:"absolute",top:12,right:12,display:"flex",gap:1},children:[(0,de.jsx)(P.A,{label:"Popular",color:"warning",size:"small",icon:(0,de.jsx)(O.A,{}),sx:{fontWeight:"bold",fontSize:ge?"0.75rem":"0.875rem",height:"auto",padding:"6px 12px"}}),e.isLive&&(0,de.jsx)(P.A,{label:"LIVE",color:"error",size:"small",sx:{fontWeight:"bold",fontSize:ge?"0.75rem":"0.875rem",height:"auto",padding:"6px 12px"}})]})]}),(0,de.jsxs)(I.A,{sx:{flexGrow:1,p:3,"&:last-child":{pb:3}},children:[(0,de.jsxs)(n.A,{sx:{mb:2},children:[(0,de.jsx)(u.A,{gutterBottom:!0,variant:ge?"h6":"h5",component:"h2",noWrap:!0,sx:{fontWeight:600,mb:1},children:e.name}),(0,de.jsx)(u.A,{variant:"body1",color:"text.secondary",sx:{display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical",overflow:"hidden",mb:2,lineHeight:1.5},children:e.description})]}),(0,de.jsxs)(n.A,{sx:{display:"flex",alignItems:"center",gap:1.5,mb:2,flexWrap:"wrap"},children:[(0,de.jsx)(P.A,{icon:(0,de.jsx)(_.A,{sx:{fontSize:ge?"1.1rem":"1.25rem"}}),label:"".concat(e.activeUsers||0," views"),color:"primary",variant:"outlined",sx:{height:"auto",padding:"8px 12px","& .MuiChip-label":{padding:"1 4px",fontSize:ge?"0.875rem":"1rem"}}}),e.isPrivate&&(0,de.jsx)(P.A,{label:"Private",color:"secondary",sx:{height:"auto",padding:"8px 12px","& .MuiChip-label":{padding:"0 4px",fontSize:ge?"0.875rem":"1rem"}}})]}),(0,de.jsxs)(u.A,{variant:"body2",color:"text.secondary",sx:{fontSize:ge?"0.75rem":"0.875rem",display:"flex",alignItems:"center",gap:.5},children:["Created by ",e.creatorName||"Anonymous"," \u2022 ",K(e.lastActive)]})]})]})},e.id)))}):(0,de.jsxs)(n.A,{sx:{textAlign:"center",py:4},children:[(0,de.jsx)(u.A,{variant:"h6",color:"text.secondary",children:Ze?"No matching popular rooms found":"No popular rooms found"}),Ze&&(0,de.jsx)(u.A,{variant:"body2",color:"text.secondary",sx:{mt:1},children:"Try different keywords or check your spelling"})]})]})}),(0,de.jsxs)(R.A,{open:ze,onClose:co,"aria-labelledby":"join-room-chat-dialog-title",children:[(0,de.jsx)(U.A,{id:"join-room-chat-dialog-title",children:"Join Room Chat?"}),(0,de.jsx)(E.A,{children:(0,de.jsxs)(u.A,{children:[(null===Me||void 0===Me?void 0:Me.username)||"This creator",' has a server chat room: "',null===Ue||void 0===Ue?void 0:Ue.name,'". Would you like to join it to receive updates and connect with other followers?']})}),(0,de.jsxs)(M.A,{children:[(0,de.jsx)(z.A,{onClick:co,children:"Not Now"}),(0,de.jsx)(z.A,{onClick:()=>{Ue&&he("/chat/room/".concat(Ue.id)),Re(!1)},variant:"contained",color:"primary",children:"Join"})]})]})]})}}}]);