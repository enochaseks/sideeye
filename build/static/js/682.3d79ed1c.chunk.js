"use strict";(self.webpackChunkside_eye=self.webpackChunkside_eye||[]).push([[682],{379:(e,s,t)=>{t.d(s,{A:()=>a});var n=t(3235),r=t(4414);const a=(0,n.A)((0,r.jsx)("path",{d:"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75z"}),"Edit")},760:(e,s,t)=>{t.d(s,{A:()=>a});var n=t(3235),r=t(4414);const a=(0,n.A)((0,r.jsx)("path",{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6zM19 4h-3.5l-1-1h-5l-1 1H5v2h14z"}),"Delete")},1227:(e,s,t)=>{t.d(s,{A:()=>a});var n=t(3235),r=t(4414);const a=(0,n.A)((0,r.jsx)("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m-2 15-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8z"}),"CheckCircle")},4801:(e,s,t)=>{t.d(s,{A:()=>a});var n=t(3235),r=t(4414);const a=(0,n.A)((0,r.jsx)("path",{d:"M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20z"}),"ArrowBack")},6281:(e,s,t)=>{t.d(s,{A:()=>a});var n=t(3235),r=t(4414);const a=(0,n.A)((0,r.jsx)("path",{d:"M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2m0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2m0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2"}),"MoreVert")},8682:(e,s,t)=>{t.r(s),t.d(s,{default:()=>Y});var n=t(9379),r=t(45),a=t(9950),o=t(6491),i=t(2053),c=t(226),l=t(249),d=t(6050),u=t(5333),h=t(8614),x=t(4447),m=t(1413),p=t(3563),A=t(4745),g=t(9808),j=t(2235),v=t(8145),y=t(2046),f=t(2236),b=t(4142),C=t(6639),w=t(3174),M=t(7591),S=t(3266),k=t(4195),E=t(6583),P=t(33),L=t(8170),U=t(4862),R=t(379),z=t(1227),G=t(9885),q=t(6281),H=t(9715),D=t(4801),F=t(3235),I=t(4414);const N=(0,F.A)((0,I.jsx)("path",{d:"M7.58 4.08 6.15 2.65C3.75 4.48 2.17 7.3 2.03 10.5h2c.15-2.65 1.51-4.97 3.55-6.42m12.39 6.42h2c-.15-3.2-1.73-6.02-4.12-7.85l-1.42 1.43c2.02 1.45 3.39 3.77 3.54 6.42M18 11c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2zm-6 11c.14 0 .27-.01.4-.04.65-.14 1.18-.58 1.44-1.18.1-.24.15-.5.15-.78h-4c.01 1.1.9 2 2.01 2"}),"NotificationsActive");var W=t(760),_=t(8429),B=t(1367),J=t(6220),T=t(330),V=t(5887);const K=["children","value","index"];function O(e){const{children:s,value:t,index:a}=e,i=(0,r.A)(e,K);return(0,I.jsx)("div",(0,n.A)((0,n.A)({role:"tabpanel",hidden:t!==a,id:"messages-tabpanel-".concat(a),"aria-labelledby":"messages-tab-".concat(a)},i),{},{children:t===a&&(0,I.jsx)(o.A,{sx:{pt:2},children:s})}))}const Y=()=>{const{currentUser:e}=(0,B.As)(),s=(0,_.Zp)(),[t,r]=(0,a.useState)(!0),[F,K]=(0,a.useState)([]),[Y,Z]=(0,a.useState)([]),[Q,X]=(0,a.useState)(""),[$,ee]=(0,a.useState)([]),[se,te]=(0,a.useState)(!1),[ne,re]=(0,a.useState)(!1),[ae,oe]=(0,a.useState)(null),[ie,ce]=(0,a.useState)(null),[le,de]=(0,a.useState)(0),[ue,he]=(0,a.useState)([]),[xe,me]=(0,a.useState)([]),[pe,Ae]=(0,a.useState)(""),[ge,je]=(0,a.useState)(!1);(0,a.useEffect)((()=>{if(!e||!T.db)return;r(!0);const s=(0,J.rJ)(T.db,"conversations"),t=(0,J.P)(s,(0,J._M)("participants","array-contains",e.uid)),a=(0,J.aQ)(t,(async s=>{try{const t=(0,J.rJ)(T.db,"users"),a=await(0,J.GG)(t),o=[];a.forEach((s=>{const t=s.data();t.blockedUsers&&Array.isArray(t.blockedUsers)&&t.blockedUsers.includes(e.uid)&&o.push(s.id)}));const i=[...e.blockedUsers||[],...o],c=s.docs.map((e=>{const s=e.data();return(0,n.A)({id:e.id},s)})).filter((s=>{const t=s.participants.find((s=>s!==e.uid));return t&&!i.includes(t)})),l=await Promise.all(c.map((async s=>{const t=s.participants.find((s=>s!==e.uid));if(!t)return s;try{const e=await(0,J.x7)((0,J.H9)(T.db,"users",t));if(e.exists()){const t=e.data();return(0,n.A)((0,n.A)({},s),{},{displayName:t.name||t.username,photoURL:t.profilePic||t.photoURL,status:s.status||"accepted"})}}catch(r){console.error("Error fetching user data:",r)}return s}))),d=l.filter((e=>"pending"!==e.status)),u=l.filter((e=>"pending"===e.status));K(d),Z(u),r(!1)}catch(t){console.error("Error loading conversations:",t),r(!1)}}));return()=>a()}),[e,T.db]);const ve=async()=>{if(Q.trim()){r(!0);try{const s=Q.toLowerCase().trim(),t=(0,J.rJ)(T.db,"users"),r=(0,J.P)(t,(0,J._M)("username",">=",s),(0,J._M)("username","<=",s+"\uf8ff"),(0,J.AB)(10)),a=await(0,J.GG)(r),o=(0,J.P)(t,(0,J._M)("name",">=",Q),(0,J._M)("name","<=",Q+"\uf8ff"),(0,J.AB)(10)),i=await(0,J.GG)(o),c=new Map;a.docs.forEach((e=>{c.set(e.id,(0,n.A)({id:e.id},e.data()))})),i.docs.forEach((e=>{c.set(e.id,(0,n.A)({id:e.id},e.data()))}));const l=Array.from(c.values()).filter((s=>s.id!==(null===e||void 0===e?void 0:e.uid)));ee(l)}catch(s){console.error("Error searching users:",s),V.oR.error("Failed to search users")}finally{r(!1)}}else ee([])},ye=e=>{if(!e)return"";const s=e.toDate?e.toDate():new Date(e),t=(new Date).getTime()-s.getTime(),n=864e5;return t<n?s.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):t<2*n?"Yesterday":s.toLocaleDateString([],{month:"short",day:"numeric"})},fe=()=>{oe(null),ce(null)},be=t=>0===t.length?(0,I.jsxs)(o.A,{sx:{textAlign:"center",mt:4,p:3},children:[(0,I.jsx)(i.A,{variant:"body1",color:"text.secondary",gutterBottom:!0,children:0===le?"You haven't started any conversations yet":"No message requests"}),0===le&&(0,I.jsx)(c.A,{variant:"contained",startIcon:(0,I.jsx)(R.A,{}),onClick:()=>te(!0),sx:{mt:2},children:"Start a new chat"})]}):(0,I.jsx)(l.A,{sx:{bgcolor:"background.paper",borderRadius:1},children:t.map(((c,l)=>{var g,j,v;return(0,I.jsxs)(a.Fragment,{children:[(0,I.jsxs)(d.Ay,{alignItems:"flex-start",button:!0,onClick:()=>s("/chat/conversation/".concat(c.id)),sx:{py:2},secondaryAction:"pending"===c.status?(0,I.jsxs)(o.A,{sx:{display:"flex"},children:[(0,I.jsx)(u.A,{edge:"end",onClick:s=>{s.stopPropagation(),(async s=>{if(e)try{r(!0);const e=(0,J.H9)(T.db,"conversations",s.id);await(0,J.mZ)(e,{status:"accepted"}),Z((e=>e.filter((e=>e.id!==s.id)))),K((e=>[(0,n.A)((0,n.A)({},s),{},{status:"accepted"}),...e])),Ae("Message request accepted"),je(!0)}catch(t){console.error("Error accepting message request:",t),V.oR.error("Failed to accept message request")}finally{r(!1)}})(c)},color:"success","aria-label":"accept request",title:"Accept",children:(0,I.jsx)(z.A,{})}),(0,I.jsx)(u.A,{edge:"end",onClick:s=>{s.stopPropagation(),(async s=>{if(e)try{r(!0);const e=(0,J.wP)(T.db),t=(0,J.rJ)(T.db,"conversations",s.id,"messages");(await(0,J.GG)(t)).docs.forEach((s=>{e.delete(s.ref)}));const n=(0,J.H9)(T.db,"conversations",s.id);e.delete(n),await e.commit(),Z((e=>e.filter((e=>e.id!==s.id)))),Ae("Message request declined"),je(!0)}catch(t){console.error("Error declining message request:",t),V.oR.error("Failed to decline message request")}finally{r(!1)}})(c)},color:"error","aria-label":"decline request",title:"Decline",children:(0,I.jsx)(G.A,{})})]}):(0,I.jsx)(u.A,{edge:"end",onClick:e=>((e,s)=>{e.stopPropagation(),oe(e.currentTarget),ce(s)})(e,c),"aria-label":"more options",children:(0,I.jsx)(q.A,{})}),children:[(0,I.jsx)(h.A,{children:(0,I.jsx)(x.A,{color:"primary",badgeContent:"number"===typeof c.unreadCount?c.unreadCount:0,invisible:!c.unreadCount,children:(0,I.jsx)(m.A,{alt:c.displayName||"User",src:c.photoURL||void 0,sx:{width:40,height:40,bgcolor:c.photoURL?void 0:"primary.main"},children:!c.photoURL&&(null===(g=c.displayName)||void 0===g?void 0:g.charAt(0).toUpperCase())})})}),(0,I.jsx)(p.A,{primary:c.displayName,secondary:(0,I.jsxs)(a.Fragment,{children:[(0,I.jsx)(i.A,{component:"span",variant:"body2",color:"text.primary",sx:{display:"inline",fontWeight:c.unreadCount?"bold":"normal"},children:(null===(j=c.lastMessage)||void 0===j?void 0:j.text)||"Start a conversation"}),(null===(v=c.lastMessage)||void 0===v?void 0:v.timestamp)&&(0,I.jsx)(i.A,{component:"span",variant:"caption",color:"text.secondary",sx:{display:"block",mt:.5},children:ye(c.lastMessage.timestamp)})]})})]}),l<t.length-1&&(0,I.jsx)(A.A,{component:"li"})]},c.id)}))});return(0,I.jsxs)(g.A,{maxWidth:"md",sx:{mt:2,mb:8},children:[(0,I.jsxs)(j.A,{elevation:0,sx:{p:2,mb:2},children:[(0,I.jsxs)(o.A,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:2},children:[(0,I.jsx)(i.A,{variant:"h5",fontWeight:"bold",children:"Messages"}),(0,I.jsx)(u.A,{onClick:()=>te(!0),color:"primary",children:(0,I.jsx)(R.A,{})})]}),(0,I.jsx)(v.A,{fullWidth:!0,placeholder:"Search conversations...",variant:"outlined",value:Q,onChange:e=>X(e.target.value),onKeyPress:e=>"Enter"===e.key&&ve(),InputProps:{startAdornment:(0,I.jsx)(y.A,{position:"start",children:(0,I.jsx)(H.A,{})}),endAdornment:Q?(0,I.jsx)(y.A,{position:"end",children:(0,I.jsx)(u.A,{size:"small",onClick:()=>X(""),children:(0,I.jsx)(D.A,{})})}):null},sx:{mb:2}}),(0,I.jsx)(o.A,{sx:{borderBottom:1,borderColor:"divider"},children:(0,I.jsxs)(f.A,{value:le,onChange:(e,s)=>{de(s)},"aria-label":"message tabs",variant:"fullWidth",children:[(0,I.jsx)(b.A,{label:"Inbox",id:"messages-tab-0","aria-controls":"messages-tabpanel-0"}),(0,I.jsx)(b.A,{label:(0,I.jsxs)(o.A,{sx:{display:"flex",alignItems:"center"},children:[(0,I.jsx)("span",{children:"Message Requests"}),Y.length>0&&(0,I.jsx)(x.A,{color:"error",badgeContent:Y.length,sx:{ml:1}})]}),id:"messages-tab-1","aria-controls":"messages-tabpanel-1",icon:Y.length>0?(0,I.jsx)(N,{fontSize:"small"}):void 0,iconPosition:"end"})]})})]}),t&&0===F.length&&0===Y.length?(0,I.jsx)(o.A,{sx:{display:"flex",justifyContent:"center",mt:4},children:(0,I.jsx)(C.A,{})}):(0,I.jsxs)(I.Fragment,{children:[(0,I.jsx)(O,{value:le,index:0,children:be(F)}),(0,I.jsxs)(O,{value:le,index:1,children:[Y.length>0&&(0,I.jsx)(w.A,{severity:"info",sx:{mb:2},children:"These are message requests from people you don't follow. Accept to start chatting or decline to remove."}),be(Y)]})]}),(0,I.jsx)(M.A,{anchorEl:ae,open:Boolean(ae),onClose:fe,children:(0,I.jsxs)(S.A,{onClick:async()=>{if(ie&&e)try{r(!0);const e=(0,J.wP)(T.db),s=(0,J.rJ)(T.db,"conversations",ie.id,"messages");(await(0,J.GG)(s)).docs.forEach((s=>{e.delete(s.ref)}));const t=(0,J.H9)(T.db,"conversations",ie.id);e.delete(t),await e.commit(),K((e=>e.filter((e=>e.id!==ie.id)))),Z((e=>e.filter((e=>e.id!==ie.id)))),Ae("Conversation deleted"),je(!0)}catch(s){console.error("Error deleting conversation:",s),V.oR.error("Failed to delete conversation")}finally{r(!1),fe()}else fe()},sx:{color:"error.main"},children:[(0,I.jsx)(k.A,{children:(0,I.jsx)(W.A,{fontSize:"small",color:"error"})}),"Delete conversation"]})}),(0,I.jsxs)(E.A,{open:se,onClose:()=>te(!1),maxWidth:"sm",fullWidth:!0,children:[(0,I.jsx)(P.A,{children:(0,I.jsxs)(o.A,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[(0,I.jsx)(i.A,{variant:"h6",children:"Start a new conversation"}),(0,I.jsx)(u.A,{edge:"end",color:"inherit",onClick:()=>te(!1),"aria-label":"close",children:(0,I.jsx)(D.A,{})})]})}),(0,I.jsxs)(L.A,{children:[(0,I.jsx)(v.A,{autoFocus:!0,margin:"dense",fullWidth:!0,label:"Search for a user",variant:"outlined",value:Q,onChange:e=>X(e.target.value),onKeyPress:e=>"Enter"===e.key&&ve(),InputProps:{endAdornment:(0,I.jsx)(y.A,{position:"end",children:(0,I.jsx)(u.A,{onClick:ve,children:(0,I.jsx)(H.A,{})})})},sx:{mb:2}}),$.length>0&&(0,I.jsx)(l.A,{children:$.map((t=>(0,I.jsxs)(d.Ay,{button:!0,onClick:()=>(async t=>{if(null!==e&&void 0!==e&&e.uid){re(!0);try{var n;const r=(0,J.P)((0,J.rJ)(T.db,"conversations"),(0,J._M)("participants","array-contains",e.uid)),a=await(0,J.GG)(r);let o=null;if(a.docs.forEach((e=>{e.data().participants.includes(t)&&(o=e.id)})),o)return void s("/chat/conversation/".concat(o));const i=(0,J.H9)(T.db,"users",t),c=await(0,J.x7)(i);if(!c.exists())return void V.oR.error("User not found");const l=c.data(),d=(null===(n=l.following)||void 0===n?void 0:n.includes(e.uid))||!1;console.log("[Messages] Creating conversation: ".concat(l.username||t," follows current user? ").concat(d));const u=(0,J.H9)((0,J.rJ)(T.db,"conversations"));await(0,J.BN)(u,{participants:[e.uid,t],createdAt:(0,J.O5)(),lastUpdated:(0,J.O5)(),unreadCount:{[e.uid]:0,[t]:0},status:d?"accepted":"pending"}),s("/chat/conversation/".concat(u.id))}catch(r){console.error("[Messages] Error creating conversation:",r),V.oR.error("Failed to start conversation")}finally{re(!1),te(!1)}}})(t.id),disabled:ne,children:[(0,I.jsx)(h.A,{children:(0,I.jsx)(m.A,{src:t.profilePic,alt:t.username||t.name})}),(0,I.jsx)(p.A,{primary:t.name||t.username,secondary:"@".concat(t.username)})]},t.id)))}),Q&&0===$.length&&!t&&(0,I.jsxs)(o.A,{sx:{textAlign:"center",py:3},children:[(0,I.jsxs)(i.A,{variant:"body2",color:"text.secondary",children:['No users found for "',Q,'"']}),(0,I.jsx)(i.A,{variant:"body2",color:"text.secondary",sx:{mt:1},children:"Try using a different search term"})]}),t&&(0,I.jsxs)(o.A,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",py:3},children:[(0,I.jsx)(C.A,{size:32,sx:{mb:2}}),(0,I.jsx)(i.A,{variant:"body2",color:"text.secondary",children:"Searching for users..."})]}),!Q&&!t&&(0,I.jsx)(o.A,{sx:{textAlign:"center",py:3},children:(0,I.jsx)(i.A,{variant:"body2",color:"text.secondary",children:"Enter a username or name to search"})})]})]}),(0,I.jsx)(U.A,{open:ge,autoHideDuration:4e3,onClose:()=>{je(!1)},message:pe})]})}},9885:(e,s,t)=>{t.d(s,{A:()=>a});var n=t(3235),r=t(4414);const a=(0,n.A)((0,r.jsx)("path",{d:"M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2m5 13.59L15.59 17 12 13.41 8.41 17 7 15.59 10.59 12 7 8.41 8.41 7 12 10.59 15.59 7 17 8.41 13.41 12z"}),"Cancel")}}]);